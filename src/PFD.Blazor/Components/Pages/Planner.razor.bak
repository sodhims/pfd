@page "/planner"
@using PFD.Shared.Interfaces
@using PFD.Shared.Models
@using PFD.Services
@using Microsoft.Extensions.DependencyInjection
@inject ITaskService TaskService
@inject IAnalysisService AnalysisService
@inject IAuthService AuthService
@inject ICalendarCredentialsService CredentialsService
@inject IServiceProvider ServiceProvider
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>PFD - Personal Daily Planner</PageTitle>

<div class="planner-container theme-@CurrentTheme @(UseLargeText ? "large-text" : "") @(HighContrastMode ? "high-contrast" : "")">
    <!-- Left Panel: Calendar + Settings -->
    <div class="left-panel">
        <!-- Calendar -->
        <div class="calendar-section">
            <div class="calendar-header">
                <button class="nav-btn" @onclick="PreviousMonth">&lt;</button>
                <span class="month-year">@CurrentMonth.ToString("MMMM yyyy")</span>
                <button class="nav-btn" @onclick="NextMonth">&gt;</button>
            </div>
            <div class="calendar-weekdays">
                <span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span>
            </div>
            <div class="calendar-days">
                @foreach (var day in CalendarDays)
                {
                    <button class="calendar-day @(day.IsCurrentMonth ? "" : "other-month") @(day.Date.Date == SelectedDate.Date ? "selected" : "") @(day.Date.Date == DateTime.Today ? "today" : "")"
                            @onclick="() => SelectDate(day.Date)">
                        @day.Date.Day
                    </button>
                }
            </div>
        </div>

        <!-- Settings -->
        <div class="settings-section">
            <div class="setting-group">
                <label>View</label>
                <div class="view-toggle">
                    <button class="@(IsDailyView ? "active" : "")" @onclick="() => SetView(true)">Daily</button>
                    <button class="@(!IsDailyView ? "active" : "")" @onclick="() => SetView(false)">Weekly</button>
                </div>
            </div>
            <div class="setting-group">
                <label>Theme</label>
                <select @onchange="ChangeTheme" value="@CurrentTheme">
                    <option value="teal">Teal</option>
                    <option value="red">Red</option>
                    <option value="orange">Orange</option>
                    <option value="yellow">Yellow</option>
                    <option value="blue">Blue</option>
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                    <option value="preppy">Preppy</option>
                    <option value="tropical">Tropical</option>
                    <option value="nordic">Nordic</option>
                    <option value="pinkish">Pinkish</option>
                    <option value="bigly">Bigly</option>
                    <option value="ughly">Ughly</option>
                    <option value="vampire">Vampire</option>
                    <option value="greek">Greek</option>
                </select>
            </div>
            <div class="setting-group">
                <label>Text Size</label>
                <div class="view-toggle">
                    <button class="@(!UseLargeText ? "active" : "")" @onclick="() => SetLargeText(false)">Normal</button>
                    <button class="@(UseLargeText ? "active" : "")" @onclick="() => SetLargeText(true)">Large</button>
                </div>
            </div>
            <div class="setting-group">
                <label>AI Assistant</label>
                <button class="ai-toggle-btn" @onclick="ToggleAiPanel">
                    <span class="ai-icon">&#129302;</span>
                    @(ShowAiPanel ? "Hide Insights" : "Show Insights")
                </button>
            </div>
            @if (HasGoogleCredentials || HasMicrosoftCredentials)
            {
                <div class="setting-group">
                    <label>External Calendars</label>
                    <div class="external-calendars">
                        @if (HasGoogleCredentials && GoogleCalendarService != null)
                        {
                            <div class="calendar-connection">
                                <span class="cal-icon google-icon">G</span>
                                <span class="cal-name">Google</span>
                                @if (IsGoogleConnected)
                                {
                                    <span class="status-badge connected">‚úì</span>
                                    <button class="disconnect-small-btn" @onclick="DisconnectGoogle">√ó</button>
                                }
                                else
                                {
                                    <button class="connect-small-btn" @onclick="ConnectGoogle">Connect</button>
                                }
                            </div>
                        }
                        @if (HasMicrosoftCredentials && MicrosoftCalendarService != null)
                        {
                            <div class="calendar-connection">
                                <span class="cal-icon microsoft-icon">M</span>
                                <span class="cal-name">Teams</span>
                                @if (IsMicrosoftConnected)
                                {
                                    <span class="status-badge connected">‚úì</span>
                                    <button class="disconnect-small-btn" @onclick="DisconnectMicrosoft">√ó</button>
                                }
                                else
                                {
                                    <button class="connect-small-btn" @onclick="ConnectMicrosoft">Connect</button>
                                }
                            </div>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(ImportMessage))
                    {
                        <div class="import-message">@ImportMessage</div>
                    }
                </div>
            }
            <div class="setting-group">
                <label>Calendars</label>
                <button class="settings-link-btn" @onclick="GoToSettings">
                    ‚öô Manage Credentials
                </button>
            </div>
            <div class="setting-group user-section">
                <label>Signed in as</label>
                <span class="username">@CurrentUsername</span>
                <button class="logout-btn" @onclick="Logout">Logout</button>
            </div>
        </div>
    </div>

    <!-- Center Panel: Tasks -->
    <div class="center-panel">
        <!-- Header -->
        <div class="task-header">
            <span class="header-icon">&#128197;</span>
            <span class="header-text">@GetHeaderText()</span>
        </div>

        <!-- Add Task -->
        <div class="add-task">
            <input type="text" @bind="NewTaskText" @bind:event="oninput"
                   @onkeydown="HandleKeyDown" placeholder="Enter a new task..." />
            <input type="text" @bind="NewTaskTimeText" @bind:event="oninput" class="time-input"
                   placeholder="9:00" pattern="[0-9]{1,2}:[0-9]{2}" title="Time (e.g. 9:00, 14:30)" />
            <button @onclick="AddTask">Add</button>
        </div>

        <!-- Waiting Section (previously Overdue) -->
        @if (OverdueTasks.Any() && IsDailyView)
        {
            <div class="waiting-section">
                <div class="waiting-header">
                    <span class="waiting-icon">&#9203;</span>
                    <span>Waiting (@OverdueTasks.Count)</span>
                </div>
                @foreach (var task in OverdueTasks)
                {
                    <div class="task-row waiting">
                        <input type="checkbox" checked="@task.IsCompleted" @onchange="() => ToggleOverdueTask(task)" />
                        <span class="task-title">@task.Title</span>
                        <span class="task-date waiting-date">@task.TaskDate.ToString("M/d")</span>
                        <button class="move-btn" title="Move to today" @onclick="() => MoveToToday(task)">&#10132;</button>
                        <button class="delete-btn" @onclick="() => DeleteOverdueTask(task)">&#128465;</button>
                    </div>
                }
            </div>
        }

        <!-- Calendar Tabs - Always show -->
        <div class="calendar-tabs-container">
            <div class="tab-bar">
                <button class="tab @(ActiveCalendarTab == CalendarSource.Integrated ? "active" : "")"
                        @onclick="() => SetCalendarTab(CalendarSource.Integrated)">
                    <span class="tab-icon">üìã</span> All Tasks
                    @if (TotalTaskCount > 0)
                    {
                        <span class="tab-count">@TotalTaskCount</span>
                    }
                </button>
                <button class="tab google-tab @(ActiveCalendarTab == CalendarSource.Google ? "active" : "") @(IsGoogleConnected ? "" : "disconnected")"
                        @onclick="() => SetCalendarTab(CalendarSource.Google)">
                    <span class="tab-icon google-tab-icon">G</span> Google
                    @if (IsGoogleConnected && GoogleEventCount > 0)
                    {
                        <span class="tab-count">@GoogleEventCount</span>
                    }
                    else if (HasGoogleCredentials && !IsGoogleConnected)
                    {
                        <span class="tab-status" title="Configured - click to connect">‚öô</span>
                    }
                    else if (!HasGoogleCredentials)
                    {
                        <span class="tab-status">‚óã</span>
                    }
                </button>
                <button class="tab microsoft-tab @(ActiveCalendarTab == CalendarSource.Microsoft ? "active" : "") @(IsMicrosoftConnected ? "" : "disconnected")"
                        @onclick="() => SetCalendarTab(CalendarSource.Microsoft)">
                    <span class="tab-icon microsoft-tab-icon">M</span> Teams
                    @if (IsMicrosoftConnected && MicrosoftEventCount > 0)
                    {
                        <span class="tab-count">@MicrosoftEventCount</span>
                    }
                    else if (HasMicrosoftCredentials && !IsMicrosoftConnected)
                    {
                        <span class="tab-status" title="Configured - click to connect">‚öô</span>
                    }
                    else if (!HasMicrosoftCredentials)
                    {
                        <span class="tab-status">‚óã</span>
                    }
                </button>
            </div>
        </div>

        <!-- External Calendar Events (when on Google or Teams tab) -->
        @if (ActiveCalendarTab == CalendarSource.Google || ActiveCalendarTab == CalendarSource.Microsoft)
        {
            @if ((ActiveCalendarTab == CalendarSource.Google && !IsGoogleConnected) ||
                 (ActiveCalendarTab == CalendarSource.Microsoft && !IsMicrosoftConnected))
            {
                @if ((ActiveCalendarTab == CalendarSource.Google && HasGoogleCredentials) ||
                     (ActiveCalendarTab == CalendarSource.Microsoft && HasMicrosoftCredentials))
                {
                    <!-- Credentials configured, show connect button -->
                    <div class="connect-prompt">
                        <div class="connect-icon">@(ActiveCalendarTab == CalendarSource.Google ? "üî¥" : "üîµ")</div>
                        <h3>@(ActiveCalendarTab == CalendarSource.Google ? "Google Calendar" : "Microsoft Teams") - Ready to Connect</h3>
                        <p>Your credentials are configured. Click below to authorize access to your calendar.</p>
                        @if (ActiveCalendarTab == CalendarSource.Google)
                        {
                            <button class="connect-btn" @onclick="ConnectGoogle">
                                Connect Google Calendar
                            </button>
                        }
                        else
                        {
                            <button class="connect-btn" @onclick="ConnectMicrosoft">
                                Connect Microsoft Teams
                            </button>
                        }
                    </div>
                }
                else
                {
                    <!-- No credentials, prompt to configure -->
                    <div class="connect-prompt">
                        <div class="connect-icon">@(ActiveCalendarTab == CalendarSource.Google ? "üî¥" : "üîµ")</div>
                        <h3>@(ActiveCalendarTab == CalendarSource.Google ? "Google Calendar" : "Microsoft Teams") not configured</h3>
                        <p>Configure your credentials in Settings to connect this calendar.</p>
                        <button class="connect-btn" @onclick="GoToSettings">
                            ‚öô Go to Settings
                        </button>
                    </div>
                }
            }
            else
            {
                <div class="external-events-list">
                    @if (IsLoadingExternalEvents)
                    {
                        <div class="loading-events">Loading events...</div>
                    }
                    else if (!ExternalEvents.Any())
                    {
                        <div class="no-events">No events for this period</div>
                    }
                    else
                    {
                        @foreach (var evt in ExternalEvents)
                        {
                            <div class="external-event-row @(evt.IsImported ? "imported" : "")">
                                <div class="event-details">
                                    <span class="event-title">@evt.Title</span>
                                    <span class="event-time">
                                        @(evt.IsAllDay ? "All day" : evt.Start.ToString("h:mm tt"))
                                    </span>
                                    @if (!string.IsNullOrEmpty(evt.Location))
                                    {
                                        <span class="event-location">üìç @evt.Location</span>
                                    }
                                </div>
                                <div class="event-actions">
                                    @if (evt.IsImported)
                                    {
                                        <span class="imported-label">‚úì Added</span>
                                    }
                                    else
                                    {
                                        <button class="add-to-integrated-btn" @onclick="() => ImportSingleEvent(evt)">
                                            ‚Üí Add to All
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                        @if (ExternalEvents.Any(e => !e.IsImported))
                        {
                            <button class="import-all-btn" @onclick="ImportAllExternalEvents">
                                Import All (@ExternalEvents.Count(e => !e.IsImported) events)
                            </button>
                        }
                    }
                </div>
            }
        }

        <!-- Task List (show on All Tasks tab) -->
        <div class="task-list" style="@(ActiveCalendarTab != CalendarSource.Integrated ? "display:none" : "")">
            @if (IsDailyView)
            {
                @if (ScheduledTasks.Any())
                {
                    <div class="scheduled-section">
                        <div class="section-header">
                            <span class="section-icon">&#128337;</span>
                            <span>Scheduled</span>
                        </div>
                        @foreach (var task in ScheduledTasks)
                        {
                            var isPast = IsTaskInPast(task);
                            <div class="task-row scheduled @(task.IsCompleted ? "completed" : "") @(EditingTaskId == task.Id ? "editing" : "") @(isPast ? "past" : "")">
                                <input type="checkbox" checked="@task.IsCompleted" @onchange="() => ToggleTask(task)" disabled="@isPast" />
                                <span class="task-time @(isPast ? "readonly" : "")" @onclick="() => OpenTimeEditor(task)">
                                    @FormatTime(task.ScheduledTime)
                                </span>
                                @if (EditingTaskId == task.Id)
                                {
                                    <input type="text" class="task-edit" @bind="EditingTaskText"
                                           @onblur="SaveTaskEdit" @onkeydown="HandleEditKeyDown" />
                                }
                                else
                                {
                                    <span class="task-title @(task.IsCompleted ? "strikethrough" : "")"
                                          @ondblclick="() => StartEditTask(task)">@task.Title</span>
                                }
                                @if (task.DurationMinutes != 30)
                                {
                                    <span class="task-duration">@task.DurationMinutes min</span>
                                }
                                @if (!isPast)
                                {
                                    <button class="clear-time-btn" title="Remove time" @onclick="() => ClearTaskTime(task)">&#10006;</button>
                                    <button class="delete-btn" @onclick="() => DeleteTask(task)">&#128465;</button>
                                }
                            </div>
                        }
                    </div>
                }

                @if (AllDayTasks.Any())
                {
                    <div class="allday-section">
                        <div class="section-header">
                            <span class="section-icon">&#128203;</span>
                            <span>Tasks</span>
                        </div>
                        @foreach (var task in AllDayTasks)
                        {
                            var isPast = IsTaskInPast(task);
                            <div class="task-row @(task.IsCompleted ? "completed" : "") @(EditingTaskId == task.Id ? "editing" : "") @(isPast ? "past" : "")">
                                <input type="checkbox" checked="@task.IsCompleted" @onchange="() => ToggleTask(task)" disabled="@isPast" />
                                @if (EditingTaskId == task.Id)
                                {
                                    <input type="text" class="task-edit" @bind="EditingTaskText"
                                           @onblur="SaveTaskEdit" @onkeydown="HandleEditKeyDown" />
                                }
                                else
                                {
                                    <span class="task-title @(task.IsCompleted ? "strikethrough" : "")"
                                          @ondblclick="() => StartEditTask(task)">@task.Title</span>
                                }
                                @if (!isPast)
                                {
                                    <button class="schedule-btn" title="Schedule time" @onclick="() => OpenTimeEditor(task)">&#128337;</button>
                                    <button class="delete-btn" @onclick="() => DeleteTask(task)">&#128465;</button>
                                }
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                @foreach (var task in WeeklyTasks)
                {
                    var isPast = IsTaskInPast(task);
                    <div class="task-row @(task.IsCompleted ? "completed" : "") @(isPast ? "past" : "")">
                        <input type="checkbox" checked="@task.IsCompleted" @onchange="() => ToggleWeeklyTask(task)" disabled="@isPast" />
                        @if (EditingTaskId == task.Id)
                        {
                            <input type="text" class="task-edit" @bind="EditingTaskText"
                                   @onblur="SaveWeeklyTaskEdit" @onkeydown="HandleWeeklyEditKeyDown" />
                        }
                        else
                        {
                            <span class="task-title @(task.IsCompleted ? "strikethrough" : "")"
                                  @ondblclick="() => StartEditWeeklyTask(task)">@task.Title</span>
                        }
                        <span class="task-date">@task.TaskDate.ToString("ddd M/d")</span>
                        <div class="day-indicators">
                            <span class="day-indicator @(task.TaskDate.DayOfWeek == DayOfWeek.Monday ? "active" : "")">M</span>
                            <span class="day-indicator @(task.TaskDate.DayOfWeek == DayOfWeek.Tuesday ? "active" : "")">T</span>
                            <span class="day-indicator @(task.TaskDate.DayOfWeek == DayOfWeek.Wednesday ? "active" : "")">W</span>
                            <span class="day-indicator @(task.TaskDate.DayOfWeek == DayOfWeek.Thursday ? "active" : "")">T</span>
                            <span class="day-indicator @(task.TaskDate.DayOfWeek == DayOfWeek.Friday ? "active" : "")">F</span>
                        </div>
                        @if (!isPast)
                        {
                            <button class="delete-btn" @onclick="() => DeleteWeeklyTask(task)">&#128465;</button>
                        }
                    </div>
                }
            }

            @if ((IsDailyView && !Tasks.Any()) || (!IsDailyView && !WeeklyTasks.Any()))
            {
                <div class="no-tasks">No tasks for this @(IsDailyView ? "day" : "week"). Add one above!</div>
            }
        </div>

    </div>

    <!-- Day Roller (draggable multi-day scroller) - Always visible in daily view -->
    @if (IsDailyView)
    {
        <div class="day-roller-wrapper">
            <!-- Day Navigation Roller -->
            <div class="day-roller">
                <button class="day-nav-btn up" @onclick="PrevDay" title="Previous Day">&#9650;</button>

                <div class="day-roller-track"
                     @onmousedown="OnRollerMouseDown"
                     @onmousemove="OnRollerMouseMove"
                     @onmouseup="OnRollerMouseUp"
                     @onmouseleave="OnRollerMouseUp"
                     @ontouchstart="OnRollerTouchStart"
                     @ontouchmove="OnRollerTouchMove"
                     @ontouchend="OnRollerTouchEnd"
                     @onwheel="OnRollerWheel"
                     style="transform: translateY(@(rollerOffset)px);">
                    @for (int offset = -7; offset <= 7; offset++)
                    {
                        var dayOffset = offset;
                        var displayDate = SelectedDate.AddDays(dayOffset);
                        var isToday = displayDate.Date == DateTime.Today;
                        var isSelected = dayOffset == 0;
                        var isWeekend = displayDate.DayOfWeek == DayOfWeek.Saturday || displayDate.DayOfWeek == DayOfWeek.Sunday;
                        var taskCount = GetTaskCountForDate(displayDate);
                        var opacity = 1.0 - (Math.Abs(dayOffset) * 0.15);

                        <div class="day-slot @(isToday ? "today" : "") @(isSelected ? "selected" : "") @(isWeekend ? "weekend" : "")"
                             style="opacity: @opacity.ToString("F2"); cursor: pointer;"
                             @onclick="() => SelectDateFromRoller(displayDate)"
                             @onclick:stopPropagation="true">
                            <span class="day-name">@displayDate.ToString("ddd")</span>
                            <span class="day-num">@displayDate.Day</span>
                            <span class="day-month">@displayDate.ToString("MMM")</span>
                            @if (taskCount > 0)
                            {
                                <span class="day-task-count">@taskCount</span>
                            }
                        </div>
                    }
                </div>

                <button class="day-nav-btn down" @onclick="NextDay" title="Next Day">&#9660;</button>

                <div class="roller-actions">
                    <button class="roller-today-btn" @onclick="GoToToday" title="Jump to Today">Today</button>
                </div>
            </div>

            <!-- Time & Tasks Panel - Always visible -->
            <div class="time-tasks-panel">
                <div class="time-panel-body">
                    <div class="time-column" @ref="timeRollerRef" @onscroll="OnTimeRollerScroll">
                        @for (int hour = WorkingHoursStart; hour <= WorkingHoursEnd; hour++)
                        {
                            var currentHour = hour;
                            var isCurrentHour = DateTime.Now.Hour == currentHour && SelectedDate.Date == DateTime.Today;
                            var hasItems = GetTasksAtHour(currentHour).Any() || GetGoogleEventsAtHour(currentHour).Any();
                            var isNonWorking = hour < 8 || hour >= 18;

                            <div class="time-slot @(isCurrentHour ? "now" : "") @(hasItems ? "has-items" : "") @(isNonWorking ? "off-hours" : "")">
                                <span class="hour-text">@FormatHour(currentHour)</span>
                            </div>
                        }
                    </div>

                    <div class="tasks-column" @ref="syncedTasksRef" @onscroll="OnSyncedTasksScroll">
                        @for (int hour = WorkingHoursStart; hour <= WorkingHoursEnd; hour++)
                        {
                            var currentHour = hour;
                            var tasksAtHour = GetTasksAtHour(currentHour);
                            var eventsAtHour = GetGoogleEventsAtHour(currentHour);
                            var isCurrentHour = DateTime.Now.Hour == currentHour && SelectedDate.Date == DateTime.Today;
                            var hasItems = tasksAtHour.Any() || eventsAtHour.Any();
                            var isNonWorking = hour < 8 || hour >= 18;

                            <div class="task-slot @(isCurrentHour ? "now" : "") @(hasItems ? "has-items" : "") @(isNonWorking ? "off-hours" : "")">
                                @foreach (var task in tasksAtHour)
                                {
                                    <div class="slot-task @(task.IsCompleted ? "done" : "") @(EditingTaskId == task.Id ? "active" : "")"
                                         @onclick="() => SelectTaskFromSchedule(task)">
                                        <span class="t-time">@FormatTime(task.ScheduledTime)</span>
                                        <span class="t-title">@task.Title</span>
                                        <span class="t-src pfd">P</span>
                                    </div>
                                }
                                @foreach (var evt in eventsAtHour)
                                {
                                    <div class="slot-task google">
                                        <span class="t-time">@evt.Start.ToString("h:mm")</span>
                                        <span class="t-title">@evt.Title</span>
                                        <span class="t-src google">G</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Time Editor Modal -->
    @if (EditingTimeTask != null)
    {
        <div class="modal-overlay" @onclick="CloseTimeEditor">
            <div class="time-editor-modal" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <span>Schedule Task</span>
                    <button class="close-btn" @onclick="CloseTimeEditor">&#10005;</button>
                </div>
                <div class="modal-body">
                    <div class="modal-task-title">@EditingTimeTask.Title</div>
                    <div class="time-picker-row">
                        <label>Time:</label>
                        <input type="text" @bind="EditingTimeValue" placeholder="HH:mm (e.g. 09:00)" />
                    </div>
                    <div class="duration-row">
                        <label>Duration:</label>
                        <select @bind="EditingDuration">
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="45">45 minutes</option>
                            <option value="60">1 hour</option>
                            <option value="90">1.5 hours</option>
                            <option value="120">2 hours</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="cancel-btn" @onclick="CloseTimeEditor">Cancel</button>
                    <button class="save-btn" @onclick="SaveTaskTime">Save</button>
                </div>
            </div>
        </div>
    }

    <!-- AI Insights Panel -->
    @if (ShowAiPanel)
    {
        <div class="ai-panel">
            <div class="ai-header">
                <span class="ai-icon">&#129302;</span>
                <span>AI Insights</span>
                <button class="refresh-btn" @onclick="RefreshAiInsights" title="Refresh">&#8635;</button>
            </div>

            @if (IsAiLoading)
            {
                <div class="ai-loading">
                    <span>&#8987;</span> Analyzing...
                </div>
            }
            else
            {
                <!-- Summary -->
                <div class="ai-section">
                    <div class="ai-section-title">Productivity Summary</div>
                    <p class="ai-summary">@AiSummary</p>
                </div>

                <!-- Suggestions -->
                @if (AiSuggestions.Any())
                {
                    <div class="ai-section">
                        <div class="ai-section-title">Suggestions</div>
                        @foreach (var suggestion in AiSuggestions)
                        {
                            <div class="ai-suggestion">
                                <span class="suggestion-icon">&#128161;</span>
                                <span>@suggestion</span>
                            </div>
                        }
                    </div>
                }

                <!-- Priority Tasks -->
                @if (PrioritizedTasks.Any())
                {
                    <div class="ai-section">
                        <div class="ai-section-title">Priority Tasks</div>
                        @foreach (var pt in PrioritizedTasks.Take(5))
                        {
                            <div class="priority-task">
                                <span class="priority-badge priority-@GetPriorityClass(pt.PriorityScore)">@GetPriorityLabel(pt.PriorityScore)</span>
                                <div class="priority-content">
                                    <div class="priority-title">@pt.Task.Title</div>
                                    <div class="priority-reason">@pt.Reasoning</div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    }
</div>

@code {
    private DateTime _selectedDate = DateTime.Today;
    private DateTime SelectedDate
    {
        get => _selectedDate;
        set
        {
            _selectedDate = value;
            _ = LoadTasksAsync();
        }
    }

    private DateTime CurrentMonth { get; set; } = DateTime.Today;
    private bool IsDailyView { get; set; } = true;
    private string CurrentTheme { get; set; } = "teal";
    private string NewTaskText { get; set; } = "";
    private string NewTaskTimeText { get; set; } = "";
    private List<DailyTask> Tasks { get; set; } = new();
    private List<DailyTask> WeeklyTasks { get; set; } = new();
    private List<DailyTask> OverdueTasks { get; set; } = new();
    private List<CalendarDay> CalendarDays { get; set; } = new();

    // Computed lists for scheduled/all-day display
    private List<DailyTask> ScheduledTasks => Tasks.Where(t => !t.IsAllDay && t.ScheduledTime.HasValue).ToList();
    private List<DailyTask> AllDayTasks => Tasks.Where(t => t.IsAllDay || !t.ScheduledTime.HasValue).ToList();

    private int? EditingTaskId { get; set; }

    // Time roller scroll sync
    private ElementReference timeRollerRef;
    private ElementReference syncedTasksRef;
    private bool isSyncingScroll = false;

    // Day roller drag state
    private bool isDragging = false;
    private double dragStartY = 0;
    private double rollerOffset = 0;
    private double totalDragDistance = 0;
    private const double SlotHeight = 55;
    private string EditingTaskText { get; set; } = "";
    private DailyTask? EditingTask { get; set; }

    // Time editor
    private DailyTask? EditingTimeTask { get; set; }
    private string EditingTimeValue { get; set; } = "09:00";
    private int EditingDuration { get; set; } = 30;

    // AI properties
    private bool ShowAiPanel { get; set; } = false;
    private bool IsAiLoading { get; set; } = false;
    private string AiSummary { get; set; } = "";
    private List<string> AiSuggestions { get; set; } = new();
    private List<PrioritizedTask> PrioritizedTasks { get; set; } = new();

    // Settings & Auth
    private int CurrentUserId { get; set; } = 0;
    private string CurrentUsername { get; set; } = "";
    private bool SettingsLoaded { get; set; } = false;
    private bool UseLargeText { get; set; } = false;
    private bool HighContrastMode { get; set; } = false;
    private int WorkingHoursStart { get; set; } = 6;  // 6 AM
    private int WorkingHoursEnd { get; set; } = 20;   // 8 PM

    // External Calendars
    private bool IsGoogleConnected { get; set; } = false;
    private bool IsMicrosoftConnected { get; set; } = false;
    private bool IsImporting { get; set; } = false;
    private string ImportMessage { get; set; } = "";
    private CalendarSource ActiveCalendarTab { get; set; } = CalendarSource.Integrated;
    private List<ExternalCalendarEvent> ExternalEvents { get; set; } = new();
    private bool IsLoadingExternalEvents { get; set; } = false;
    private int GoogleEventCount { get; set; } = 0;
    private int MicrosoftEventCount { get; set; } = 0;
    private int TotalTaskCount => Tasks.Count + WeeklyTasks.Count;

    // Calendar services (created dynamically from stored credentials)
    private IGoogleCalendarService? GoogleCalendarService { get; set; }
    private MicrosoftCalendarService? MicrosoftCalendarService { get; set; }
    private ICalendarSyncService? CalendarSyncService { get; set; }

    // Credentials info
    private bool HasGoogleCredentials { get; set; } = false;
    private bool HasMicrosoftCredentials { get; set; } = false;

    protected override void OnInitialized()
    {
        BuildCalendar();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CheckAuthAndLoadAsync();
        }
    }

    private async Task CheckAuthAndLoadAsync()
    {
        try
        {
            // Check if user is logged in
            var userIdStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "pfd_user_id");
            if (string.IsNullOrEmpty(userIdStr) || !int.TryParse(userIdStr, out var userId))
            {
                Navigation.NavigateTo("/login");
                return;
            }

            var user = await AuthService.GetUserByIdAsync(userId);
            if (user == null)
            {
                await Logout();
                return;
            }

            CurrentUserId = user.Id;
            CurrentUsername = user.DisplayName ?? user.Username;
            CurrentTheme = user.Theme;
            IsDailyView = user.IsDailyView;
            UseLargeText = user.UseLargeText;

            // Load high contrast from localStorage
            try
            {
                HighContrastMode = await JSRuntime.InvokeAsync<bool>("settingsInterop.getHighContrast");
            }
            catch { HighContrastMode = false; }

            SettingsLoaded = true;

            // Load calendar credentials and create services dynamically
            await LoadCalendarServicesFromCredentialsAsync();

            // Check external calendar connections
            if (GoogleCalendarService != null)
            {
                IsGoogleConnected = await GoogleCalendarService.IsConnectedAsync(CurrentUserId);
            }
            if (MicrosoftCalendarService != null)
            {
                IsMicrosoftConnected = await MicrosoftCalendarService.IsConnectedAsync(CurrentUserId);
            }

            // Load event counts for tabs
            await LoadExternalEventCounts();

            await LoadTasksAsync();
            StateHasChanged();
        }
        catch (Exception)
        {
            Navigation.NavigateTo("/login");
        }
    }

    private async Task LoadCalendarServicesFromCredentialsAsync()
    {
        try
        {
            // Load Google credentials
            var googleCreds = await CredentialsService.GetCredentialsAsync(CurrentUserId, "Google");
            if (googleCreds != null && !string.IsNullOrEmpty(googleCreds.ClientId) && !string.IsNullOrEmpty(googleCreds.ClientSecret))
            {
                HasGoogleCredentials = true;
                GoogleCalendarService = new GoogleCalendarService(
                    TaskService,
                    googleCreds.ClientId,
                    googleCreds.ClientSecret,
                    googleCreds.RedirectUri ?? "https://localhost:5001/auth/google/callback"
                );
            }

            // Load Microsoft credentials
            var msCreds = await CredentialsService.GetCredentialsAsync(CurrentUserId, "Microsoft");
            if (msCreds != null && !string.IsNullOrEmpty(msCreds.ClientId) && !string.IsNullOrEmpty(msCreds.ClientSecret))
            {
                HasMicrosoftCredentials = true;
                MicrosoftCalendarService = new MicrosoftCalendarService(
                    msCreds.ClientId,
                    msCreds.ClientSecret,
                    msCreds.TenantId ?? "common",
                    msCreds.RedirectUri ?? "https://localhost:5001/auth/microsoft/callback"
                );
            }

            // Create CalendarSyncService if any calendar is configured
            if (GoogleCalendarService != null || MicrosoftCalendarService != null)
            {
                var syncService = new CalendarSyncService(TaskService);
                if (GoogleCalendarService is IExternalCalendarService googleExtSvc)
                {
                    syncService.RegisterCalendarService(googleExtSvc);
                }
                if (MicrosoftCalendarService != null)
                {
                    syncService.RegisterCalendarService(MicrosoftCalendarService);
                }
                CalendarSyncService = syncService;
            }
        }
        catch (Exception ex)
        {
            ImportMessage = $"Error loading calendar credentials: {ex.Message}";
        }
    }

    private async Task Logout()
    {
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "pfd_user_id");
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "pfd_username");
        Navigation.NavigateTo("/login");
    }

    private void GoToSettings()
    {
        Navigation.NavigateTo("/settings");
    }


    private void BuildCalendar()
    {
        CalendarDays.Clear();
        var firstOfMonth = new DateTime(CurrentMonth.Year, CurrentMonth.Month, 1);
        var lastOfMonth = firstOfMonth.AddMonths(1).AddDays(-1);
        int startDayOfWeek = (int)firstOfMonth.DayOfWeek;

        // Previous month days
        var prevMonth = firstOfMonth.AddDays(-startDayOfWeek);
        for (int i = 0; i < startDayOfWeek; i++)
        {
            CalendarDays.Add(new CalendarDay { Date = prevMonth.AddDays(i), IsCurrentMonth = false });
        }

        // Current month days
        for (int day = 1; day <= lastOfMonth.Day; day++)
        {
            CalendarDays.Add(new CalendarDay { Date = new DateTime(CurrentMonth.Year, CurrentMonth.Month, day), IsCurrentMonth = true });
        }

        // Next month days
        int remainingDays = 42 - CalendarDays.Count;
        var nextMonth = lastOfMonth.AddDays(1);
        for (int i = 0; i < remainingDays; i++)
        {
            CalendarDays.Add(new CalendarDay { Date = nextMonth.AddDays(i), IsCurrentMonth = false });
        }
    }

    private async Task LoadTasksAsync()
    {
        if (CurrentUserId == 0) return;

        // Load overdue tasks (only for today's view)
        if (SelectedDate.Date == DateTime.Today)
        {
            OverdueTasks = await TaskService.GetOverdueTasksAsync(DateTime.Today, CurrentUserId);
        }
        else
        {
            OverdueTasks.Clear();
        }

        if (IsDailyView)
        {
            Tasks = await TaskService.GetTasksForDateAsync(SelectedDate, CurrentUserId);
            WeeklyTasks.Clear();
        }
        else
        {
            var dayOfWeek = (int)SelectedDate.DayOfWeek;
            var daysToMonday = dayOfWeek == 0 ? 6 : dayOfWeek - 1;
            var startOfWeek = SelectedDate.AddDays(-daysToMonday);
            WeeklyTasks = await TaskService.GetTasksForDateRangeAsync(startOfWeek, startOfWeek.AddDays(4), CurrentUserId);
            Tasks.Clear();
        }
        StateHasChanged();
    }

    private void SelectDate(DateTime date)
    {
        SelectedDate = date;
        if (date.Month != CurrentMonth.Month || date.Year != CurrentMonth.Year)
        {
            CurrentMonth = new DateTime(date.Year, date.Month, 1);
            BuildCalendar();
        }
    }

    private void PreviousMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
        BuildCalendar();
    }

    private void NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
        BuildCalendar();
    }

    private async Task SetView(bool daily)
    {
        IsDailyView = daily;
        await LoadTasksAsync();
        await SaveSettingsAsync();
    }

    private string GetHeaderText()
    {
        if (IsDailyView)
        {
            return SelectedDate.Date == DateTime.Today
                ? $"TODAY - {SelectedDate:dddd, MMMM d, yyyy}"
                : SelectedDate.ToString("dddd, MMMM d, yyyy");
        }
        else
        {
            var dayOfWeek = (int)SelectedDate.DayOfWeek;
            var daysToMonday = dayOfWeek == 0 ? 6 : dayOfWeek - 1;
            var startOfWeek = SelectedDate.AddDays(-daysToMonday);
            var endOfWeek = startOfWeek.AddDays(4);
            return $"WEEK: {startOfWeek:MMM d} - {endOfWeek:MMM d, yyyy}";
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddTask();
        }
    }

    private async Task AddTask()
    {
        if (string.IsNullOrWhiteSpace(NewTaskText) || CurrentUserId == 0) return;

        var task = new DailyTask
        {
            Title = NewTaskText,
            TaskDate = SelectedDate,
            IsCompleted = false,
            SortOrder = Tasks.Count,
            IsAllDay = string.IsNullOrWhiteSpace(NewTaskTimeText),
            UserId = CurrentUserId
        };

        // Parse scheduled time if provided
        if (!string.IsNullOrWhiteSpace(NewTaskTimeText) && TimeSpan.TryParse(NewTaskTimeText, out var time))
        {
            task.ScheduledTime = time;
            task.IsAllDay = false;
        }

        await TaskService.CreateTaskAsync(task);
        NewTaskText = "";
        NewTaskTimeText = "";
        await LoadTasksAsync();
    }

    private async Task ToggleTask(DailyTask task)
    {
        await TaskService.ToggleCompletionAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task DeleteTask(DailyTask task)
    {
        await TaskService.DeleteTaskAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task ToggleWeeklyTask(DailyTask task)
    {
        await TaskService.ToggleCompletionAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task DeleteWeeklyTask(DailyTask task)
    {
        await TaskService.DeleteTaskAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task ToggleOverdueTask(DailyTask task)
    {
        await TaskService.ToggleCompletionAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task DeleteOverdueTask(DailyTask task)
    {
        await TaskService.DeleteTaskAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task MoveToToday(DailyTask task)
    {
        await TaskService.RescheduleTaskAsync(task.Id, DateTime.Today, CurrentUserId);
        await LoadTasksAsync();
    }

    private bool IsTaskInPast(DailyTask task)
    {
        return task.TaskDate.Date < DateTime.Today;
    }

    private void StartEditTask(DailyTask task)
    {
        // Don't allow editing past tasks
        if (IsTaskInPast(task)) return;

        EditingTaskId = task.Id;
        EditingTaskText = task.Title;
        EditingTask = task;
    }

    private void StartEditWeeklyTask(DailyTask task)
    {
        // Don't allow editing past tasks
        if (IsTaskInPast(task)) return;

        EditingTaskId = task.Id;
        EditingTaskText = task.Title;
        EditingTask = task;
    }

    private void SelectTaskFromSchedule(DailyTask task)
    {
        // Don't allow editing past tasks
        if (IsTaskInPast(task)) return;

        // Set the task as editing - this highlights it in the task list and enables editing
        EditingTaskId = task.Id;
        EditingTaskText = task.Title;
        EditingTask = task;
    }

    private async Task SaveTaskEdit()
    {
        if (EditingTask != null && !string.IsNullOrWhiteSpace(EditingTaskText))
        {
            EditingTask.Title = EditingTaskText;
            await TaskService.UpdateTaskAsync(EditingTask);
            await LoadTasksAsync();
        }
        EditingTaskId = null;
        EditingTask = null;
    }

    private async Task SaveWeeklyTaskEdit()
    {
        await SaveTaskEdit();
    }

    private async Task HandleEditKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SaveTaskEdit();
        }
        else if (e.Key == "Escape")
        {
            EditingTaskId = null;
            EditingTask = null;
        }
    }

    private async Task HandleWeeklyEditKeyDown(KeyboardEventArgs e)
    {
        await HandleEditKeyDown(e);
    }

    private async Task ChangeTheme(ChangeEventArgs e)
    {
        CurrentTheme = e.Value?.ToString() ?? "teal";
        await SaveSettingsAsync();
    }

    private async Task SaveSettingsAsync()
    {
        if (!SettingsLoaded || CurrentUserId == 0) return;

        try
        {
            // Save to user profile in database
            await AuthService.UpdateUserSettingsAsync(CurrentUserId, CurrentTheme, IsDailyView, UseLargeText);
        }
        catch (Exception)
        {
            // Silently fail
        }
    }

    private async Task SetLargeText(bool useLargeText)
    {
        UseLargeText = useLargeText;
        await SaveSettingsAsync();
    }

    private void ToggleAiPanel()
    {
        ShowAiPanel = !ShowAiPanel;
        if (ShowAiPanel)
        {
            _ = LoadAiInsightsAsync();
        }
    }

    // Select date from day roller click
    private async Task SelectDateFromRoller(DateTime date)
    {
        // Only select if it wasn't a drag
        if (totalDragDistance < 10)
        {
            SelectedDate = date;
            await LoadTasksAsync();
        }
    }

    // Simple day navigation
    private async Task PrevDay()
    {
        SelectedDate = SelectedDate.AddDays(-1);
        await LoadTasksAsync();
    }

    private async Task NextDay()
    {
        SelectedDate = SelectedDate.AddDays(1);
        await LoadTasksAsync();
    }

    private async Task GoToToday()
    {
        SelectedDate = DateTime.Today;
        await LoadTasksAsync();
    }

    // Day roller drag handlers
    private void OnRollerMouseDown(MouseEventArgs e)
    {
        isDragging = true;
        dragStartY = e.ClientY;
        totalDragDistance = 0;
    }

    private async Task OnRollerMouseMove(MouseEventArgs e)
    {
        if (!isDragging) return;

        var delta = e.ClientY - dragStartY;
        totalDragDistance += Math.Abs(delta);
        rollerOffset += delta;
        dragStartY = e.ClientY;

        // Check if we've dragged enough to change day
        if (Math.Abs(rollerOffset) >= SlotHeight)
        {
            var dayChange = rollerOffset > 0 ? -1 : 1;
            SelectedDate = SelectedDate.AddDays(dayChange);
            rollerOffset = 0;
            await LoadTasksAsync();
        }

        StateHasChanged();
    }

    private void OnRollerMouseUp(MouseEventArgs e)
    {
        isDragging = false;
        rollerOffset = 0;
        StateHasChanged();
    }

    private void OnRollerTouchStart(TouchEventArgs e)
    {
        if (e.Touches.Length > 0)
        {
            isDragging = true;
            dragStartY = e.Touches[0].ClientY;
            totalDragDistance = 0;
        }
    }

    private async Task OnRollerTouchMove(TouchEventArgs e)
    {
        if (!isDragging || e.Touches.Length == 0) return;

        var delta = e.Touches[0].ClientY - dragStartY;
        totalDragDistance += Math.Abs(delta);
        rollerOffset += delta;
        dragStartY = e.Touches[0].ClientY;

        if (Math.Abs(rollerOffset) >= SlotHeight)
        {
            var dayChange = rollerOffset > 0 ? -1 : 1;
            SelectedDate = SelectedDate.AddDays(dayChange);
            rollerOffset = 0;
            await LoadTasksAsync();
        }

        StateHasChanged();
    }

    private void OnRollerTouchEnd(TouchEventArgs e)
    {
        isDragging = false;
        rollerOffset = 0;
        StateHasChanged();
    }

    private async Task OnRollerWheel(WheelEventArgs e)
    {
        // Scroll wheel changes days
        var dayChange = e.DeltaY > 0 ? 1 : -1;
        SelectedDate = SelectedDate.AddDays(dayChange);
        await LoadTasksAsync();
    }

    private async Task OnTimeRollerScroll()
    {
        if (isSyncingScroll) return;
        isSyncingScroll = true;
        await JSRuntime.InvokeVoidAsync("syncScroll", timeRollerRef, syncedTasksRef);
        isSyncingScroll = false;
    }

    private async Task OnSyncedTasksScroll()
    {
        if (isSyncingScroll) return;
        isSyncingScroll = true;
        await JSRuntime.InvokeVoidAsync("syncScroll", syncedTasksRef, timeRollerRef);
        isSyncingScroll = false;
    }

    private async Task ScrollToNow()
    {
        var currentHour = DateTime.Now.Hour;
        await JSRuntime.InvokeVoidAsync("scrollToHour", timeRollerRef, syncedTasksRef, currentHour);
    }

    private async Task ScrollToHour(int hour)
    {
        await JSRuntime.InvokeVoidAsync("scrollToHour", timeRollerRef, syncedTasksRef, hour);
    }


    private int GetTaskCountForDate(DateTime date)
    {
        // This is a simplified count - could be enhanced to query actual data
        if (date.Date == SelectedDate.Date)
        {
            return Tasks.Count;
        }
        return 0; // Would need to load from DB for other dates
    }

    private string FormatHour(int hour)
    {
        if (hour == 0) return "12a";
        if (hour < 12) return $"{hour}a";
        if (hour == 12) return "12p";
        return $"{hour - 12}p";
    }

    private async Task RefreshAiInsights()
    {
        await LoadAiInsightsAsync();
    }

    private async Task LoadAiInsightsAsync()
    {
        if (!await AnalysisService.IsAvailableAsync())
        {
            AiSummary = "AI service unavailable. Start Ollama to enable AI features.";
            StateHasChanged();
            return;
        }

        IsAiLoading = true;
        StateHasChanged();

        try
        {
            var recentTasks = await TaskService.GetRecentTasksAsync(CurrentUserId, 30);
            var overdueTasks = await TaskService.GetOverdueTasksAsync(DateTime.Today, CurrentUserId);
            var todayTasks = Tasks.ToList();

            // Get insights
            var insights = await AnalysisService.GetInsightsAsync(recentTasks);
            AiSummary = insights.ProductivitySummary;
            AiSuggestions = insights.Suggestions;

            // Get prioritization
            if (todayTasks.Any() || overdueTasks.Any())
            {
                var prioritization = await AnalysisService.GetPrioritizedTasksAsync(todayTasks, overdueTasks);

                PrioritizedTasks.Clear();
                foreach (var taskId in prioritization.PriorityOrder)
                {
                    var task = todayTasks.FirstOrDefault(t => t.Id == taskId)
                            ?? overdueTasks.FirstOrDefault(t => t.Id == taskId);
                    if (task != null)
                    {
                        PrioritizedTasks.Add(new PrioritizedTask
                        {
                            Task = task,
                            PriorityScore = prioritization.PriorityScores.GetValueOrDefault(taskId, 50),
                            Reasoning = prioritization.Reasoning.GetValueOrDefault(taskId, "")
                        });
                    }
                }
            }
        }
        catch (Exception ex)
        {
            AiSummary = $"Error loading insights: {ex.Message}";
        }
        finally
        {
            IsAiLoading = false;
            StateHasChanged();
        }
    }

    private string GetPriorityLabel(int score) => score switch
    {
        >= 90 => "Critical",
        >= 70 => "High",
        >= 50 => "Medium",
        _ => "Low"
    };

    private string GetPriorityClass(int score) => score switch
    {
        >= 90 => "critical",
        >= 70 => "high",
        >= 50 => "medium",
        _ => "low"
    };

    // Time scheduling methods
    private string FormatTime(TimeSpan? time)
    {
        if (!time.HasValue) return "";
        var dt = DateTime.Today.Add(time.Value);
        return dt.ToString("h:mm tt");
    }

    private void OpenTimeEditor(DailyTask task)
    {
        // Don't allow editing past tasks
        if (IsTaskInPast(task)) return;

        EditingTimeTask = task;
        EditingTimeValue = task.ScheduledTime.HasValue
            ? task.ScheduledTime.Value.ToString(@"hh\:mm")
            : "09:00";
        EditingDuration = task.DurationMinutes > 0 ? task.DurationMinutes : 30;
    }

    private void CloseTimeEditor()
    {
        EditingTimeTask = null;
    }

    private async Task SaveTaskTime()
    {
        if (EditingTimeTask == null) return;

        TimeSpan? time = null;
        if (TimeSpan.TryParse(EditingTimeValue, out var parsed))
        {
            time = parsed;
        }

        await TaskService.ScheduleTaskTimeAsync(EditingTimeTask.Id, time, CurrentUserId, EditingDuration);
        EditingTimeTask = null;
        await LoadTasksAsync();
    }

    private async Task ClearTaskTime(DailyTask task)
    {
        await TaskService.ScheduleTaskTimeAsync(task.Id, null, CurrentUserId, 30);
        await LoadTasksAsync();
    }

    private class CalendarDay
    {
        public DateTime Date { get; set; }
        public bool IsCurrentMonth { get; set; }
    }

    private class PrioritizedTask
    {
        public DailyTask Task { get; set; } = null!;
        public int PriorityScore { get; set; }
        public string Reasoning { get; set; } = "";
    }

    // Google Calendar methods
    private async Task ConnectGoogle()
    {
        if (GoogleCalendarService == null || CurrentUserId == 0) return;

        try
        {
            var authUrl = await GoogleCalendarService.GetAuthorizationUrlAsync(CurrentUserId);
            await JSRuntime.InvokeVoidAsync("open", authUrl, "_blank");
        }
        catch (Exception ex)
        {
            ImportMessage = $"Error: {ex.Message}";
        }
    }

    private async Task DisconnectGoogle()
    {
        if (GoogleCalendarService == null || CurrentUserId == 0) return;

        await GoogleCalendarService.DisconnectAsync(CurrentUserId);
        IsGoogleConnected = false;
        ImportMessage = "";
    }

    private async Task ImportGoogleEvents()
    {
        if (GoogleCalendarService == null || CurrentUserId == 0) return;

        IsImporting = true;
        ImportMessage = "";
        StateHasChanged();

        try
        {
            // Import events for the next 30 days
            var startDate = DateTime.Today;
            var endDate = DateTime.Today.AddDays(30);

            var count = await GoogleCalendarService.ImportEventsAsTasksAsync(CurrentUserId, startDate, endDate);
            ImportMessage = count > 0
                ? $"Imported {count} event(s)!"
                : "No new events to import.";

            await LoadTasksAsync();
        }
        catch (Exception ex)
        {
            ImportMessage = $"Import failed: {ex.Message}";
        }
        finally
        {
            IsImporting = false;
            StateHasChanged();
        }
    }

    public async Task HandleGoogleCallback(string code)
    {
        if (GoogleCalendarService == null || CurrentUserId == 0) return;

        var success = await GoogleCalendarService.HandleAuthCallbackAsync(code, CurrentUserId);
        IsGoogleConnected = success;
        if (success)
        {
            ImportMessage = "Connected! Switch to Google tab to view events.";
            await LoadExternalEventCounts();
        }
        else
        {
            ImportMessage = "Failed to connect. Please try again.";
        }
        StateHasChanged();
    }

    // Microsoft Calendar methods
    private async Task ConnectMicrosoft()
    {
        if (MicrosoftCalendarService == null || CurrentUserId == 0) return;

        try
        {
            var authUrl = await MicrosoftCalendarService.GetAuthorizationUrlAsync(CurrentUserId);
            await JSRuntime.InvokeVoidAsync("open", authUrl, "_blank");
            ImportMessage = "Complete authorization in browser, then refresh this page.";
        }
        catch (Exception ex)
        {
            ImportMessage = $"Error: {ex.Message}";
        }
    }

    private async Task DisconnectMicrosoft()
    {
        if (MicrosoftCalendarService == null || CurrentUserId == 0) return;

        await MicrosoftCalendarService.DisconnectAsync(CurrentUserId);
        IsMicrosoftConnected = false;
        MicrosoftEventCount = 0;
        if (ActiveCalendarTab == CalendarSource.Microsoft)
        {
            ActiveCalendarTab = CalendarSource.Integrated;
        }
        ImportMessage = "";
        StateHasChanged();
    }

    // Calendar Tab methods
    private async Task SetCalendarTab(CalendarSource tab)
    {
        ActiveCalendarTab = tab;
        if (tab != CalendarSource.Integrated)
        {
            await LoadExternalEventsForTab(tab);
        }
        StateHasChanged();
    }

    private async Task LoadExternalEventCounts()
    {
        var startDate = IsDailyView ? SelectedDate : GetWeekStart(SelectedDate);
        var endDate = IsDailyView ? SelectedDate.AddDays(1) : startDate.AddDays(7);

        if (IsGoogleConnected && CalendarSyncService != null)
        {
            try
            {
                var events = await CalendarSyncService.GetEventsBySourceAsync(CurrentUserId, CalendarSource.Google, startDate, endDate);
                GoogleEventCount = events.Count;
            }
            catch { GoogleEventCount = 0; }
        }

        if (IsMicrosoftConnected && CalendarSyncService != null)
        {
            try
            {
                var events = await CalendarSyncService.GetEventsBySourceAsync(CurrentUserId, CalendarSource.Microsoft, startDate, endDate);
                MicrosoftEventCount = events.Count;
            }
            catch { MicrosoftEventCount = 0; }
        }
    }

    private async Task LoadExternalEventsForTab(CalendarSource source)
    {
        if (CalendarSyncService == null || CurrentUserId == 0) return;

        IsLoadingExternalEvents = true;
        StateHasChanged();

        try
        {
            var startDate = IsDailyView ? SelectedDate : GetWeekStart(SelectedDate);
            var endDate = IsDailyView ? SelectedDate.AddDays(1) : startDate.AddDays(7);

            ExternalEvents = await CalendarSyncService.GetEventsBySourceAsync(CurrentUserId, source, startDate, endDate);
        }
        catch (Exception ex)
        {
            ImportMessage = $"Error loading events: {ex.Message}";
            ExternalEvents = new List<ExternalCalendarEvent>();
        }
        finally
        {
            IsLoadingExternalEvents = false;
            StateHasChanged();
        }
    }

    private async Task ImportSingleEvent(ExternalCalendarEvent evt)
    {
        if (CalendarSyncService == null || CurrentUserId == 0) return;

        try
        {
            await CalendarSyncService.ImportEventToIntegratedAsync(CurrentUserId, evt);
            evt.IsImported = true;
            await LoadTasksAsync();
            ImportMessage = $"Added '{evt.Title}' to Integrated";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ImportMessage = $"Error: {ex.Message}";
        }
    }

    private async Task ImportAllExternalEvents()
    {
        if (CalendarSyncService == null || CurrentUserId == 0) return;

        IsImporting = true;
        StateHasChanged();

        try
        {
            var toImport = ExternalEvents.Where(e => !e.IsImported).ToList();
            var count = await CalendarSyncService.ImportEventsToIntegratedAsync(CurrentUserId, toImport);
            ImportMessage = $"Imported {count} event(s) to Integrated!";
            await LoadTasksAsync();
            await LoadExternalEventsForTab(ActiveCalendarTab);
        }
        catch (Exception ex)
        {
            ImportMessage = $"Import failed: {ex.Message}";
        }
        finally
        {
            IsImporting = false;
            StateHasChanged();
        }
    }

    private DateTime GetWeekStart(DateTime date)
    {
        int diff = (7 + (date.DayOfWeek - DayOfWeek.Sunday)) % 7;
        return date.AddDays(-1 * diff).Date;
    }

    // Timeline helper methods
    private List<DailyTask> GetTasksAtHour(int hour)
    {
        return ScheduledTasks
            .Where(t => t.ScheduledTime.HasValue && t.ScheduledTime.Value.Hours == hour)
            .OrderBy(t => t.ScheduledTime!.Value.Minutes)
            .ToList();
    }

    private List<ExternalCalendarEvent> GetGoogleEventsAtHour(int hour)
    {
        if (!IsGoogleConnected) return new List<ExternalCalendarEvent>();

        return ExternalEvents
            .Where(e => !e.IsAllDay && e.Start.Hour == hour && e.Start.Date == SelectedDate.Date)
            .OrderBy(e => e.Start.Minute)
            .ToList();
    }
}
