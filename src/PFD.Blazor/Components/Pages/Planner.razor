@page "/planner"
@using PFD.Shared.Interfaces
@using PFD.Shared.Models
@using PFD.Shared.Enums
@using PFD.Services
@using Microsoft.Extensions.DependencyInjection
@inject ITaskService TaskService
@inject IAnalysisService AnalysisService
@inject IAuthService AuthService
@inject ICalendarCredentialsService CredentialsService
@inject IServiceProvider ServiceProvider
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject IGroupService GroupService
@inject IOllamaService OllamaService
@inject INotificationService NotificationService
@inject IInsightHistoryService InsightHistoryService
@inject ITaskTemplateService TaskTemplateService
@inject IClaudeService ClaudeService
@rendermode InteractiveServer

<PageTitle>PFD - Personal Daily Planner</PageTitle>

<div class="planner-container theme-@CurrentTheme @(UseLargeText ? "large-text" : "") @(HighContrastMode ? "high-contrast" : "") @(IsResizingPanels ? "resizing" : "")"
     @onmousemove="OnPanelResize"
     @onmouseup="StopPanelResize"
     @onmouseleave="StopPanelResize"
     @onkeydown="HandleGlobalKeyDown"
     tabindex="0">
    <!-- Left Panel: Calendar + Settings -->
    <div class="left-panel">
        <!-- Calendar -->
        <div class="calendar-section">
            <div class="calendar-header">
                <button class="nav-btn" @onclick="PreviousMonth">&lt;</button>
                <span class="month-year">@CurrentMonth.ToString("MMMM yyyy")</span>
                <button class="nav-btn" @onclick="NextMonth">&gt;</button>
            </div>
            <div class="calendar-weekdays">
                <span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span>
            </div>
            <div class="calendar-days">
                @foreach (var day in CalendarDays)
                {
                    <button class="calendar-day @(day.IsCurrentMonth ? "" : "other-month") @(day.Date.Date == SelectedDate.Date ? "selected" : "") @(day.Date.Date == LocalToday ? "today" : "") @(day.TaskCount > 0 ? "has-tasks" : "")"
                            @onclick="() => SelectDate(day.Date)">
                        <span class="day-number">@day.Date.Day</span>
                        @if (day.TaskCount > 0)
                        {
                            <span class="task-count-badge">@day.TaskCount</span>
                        }
                    </button>
                }
            </div>
        </div>

        <!-- Settings -->
        <div class="settings-section">
            <div class="setting-group">
                <label>View</label>
                <div class="view-toggle">
                    <button class="@(IsDailyView ? "active" : "")" @onclick="() => SetView(true)">Daily</button>
                    <button class="@(!IsDailyView ? "active" : "")" @onclick="() => SetView(false)">Weekly</button>
                </div>
            </div>
            <div class="setting-group">
                <label>Theme</label>
                <select @onchange="ChangeTheme" value="@CurrentTheme">
                    <option value="teal">Teal</option>
                    <option value="red">Red</option>
                    <option value="orange">Orange</option>
                    <option value="yellow">Yellow</option>
                    <option value="blue">Blue</option>
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                    <option value="preppy">Preppy</option>
                    <option value="tropical">Tropical</option>
                    <option value="nordic">Nordic</option>
                    <option value="pinkish">Pinkish</option>
                    <option value="bigly">Bigly</option>
                    <option value="ughly">Ughly</option>
                    <option value="vampire">Vampire</option>
                    <option value="greek">Greek</option>
                </select>
            </div>
            <div class="setting-group">
                <label>Text Size</label>
                <div class="view-toggle">
                    <button class="@(!UseLargeText ? "active" : "")" @onclick="() => SetLargeText(false)">Normal</button>
                    <button class="@(UseLargeText ? "active" : "")" @onclick="() => SetLargeText(true)">Large</button>
                </div>
            </div>
            <div class="setting-group">
                <label>AI Assistant</label>
                <button class="ai-toggle-btn" @onclick="ToggleAiPanel">
                    <span class="ai-icon">&#129302;</span>
                    @(ShowAiPanel ? "Hide Insights" : "Show Insights")
                </button>
            </div>
            @if (HasGoogleCredentials || HasMicrosoftCredentials)
            {
                <div class="setting-group">
                    <label>External Calendars</label>
                    <div class="external-calendars">
                        @if (HasGoogleCredentials && GoogleCalendarService != null)
                        {
                            <div class="calendar-connection">
                                <span class="cal-icon google-icon">G</span>
                                <span class="cal-name">Google</span>
                                @if (IsGoogleConnected)
                                {
                                    <span class="status-badge connected">‚úì</span>
                                    <button class="disconnect-small-btn" @onclick="DisconnectGoogle">√ó</button>
                                }
                                else
                                {
                                    <button class="connect-small-btn" @onclick="ConnectGoogle">Connect</button>
                                }
                            </div>
                        }
                        @if (HasMicrosoftCredentials && MicrosoftCalendarService != null)
                        {
                            <div class="calendar-connection">
                                <span class="cal-icon microsoft-icon">M</span>
                                <span class="cal-name">Teams</span>
                                @if (IsMicrosoftConnected)
                                {
                                    <span class="status-badge connected">‚úì</span>
                                    <button class="disconnect-small-btn" @onclick="DisconnectMicrosoft">√ó</button>
                                }
                                else
                                {
                                    <button class="connect-small-btn" @onclick="ConnectMicrosoft">Connect</button>
                                }
                            </div>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(ImportMessage))
                    {
                        <div class="import-message">@ImportMessage</div>
                    }
                </div>
            }
            <!-- Manage Credentials Section -->
            <div class="setting-group credentials-section">
                <button type="button" class="credentials-toggle-btn" @onclick="ToggleCredentialsSection" @onclick:stopPropagation="true">
                    <span class="cred-icon">&#128273;</span>
                    <span>Manage Credentials</span>
                    <span class="toggle-arrow @(ShowCredentialsSection ? "open" : "")">&#9662;</span>
                </button>

                @if (ShowCredentialsSection)
                {
                    <div class="credentials-dropdowns">
                        <!-- Calendar Credentials -->
                        <div class="cred-dropdown">
                            <button class="cred-dropdown-btn" @onclick="ToggleCalendarCredentials">
                                <span>&#128197; Calendars</span>
                                <span class="dropdown-arrow @(ShowCalendarCredentials ? "open" : "")">&#9656;</span>
                            </button>
                            @if (ShowCalendarCredentials)
                            {
                                <div class="cred-dropdown-content">
                                    <button class="settings-link-btn" @onclick="GoToSettings">
                                        ‚öô Configure API Keys
                                    </button>
                                    @if (HasGoogleCredentials || HasMicrosoftCredentials)
                                    {
                                        <div class="connected-services">
                                            @if (HasGoogleCredentials)
                                            {
                                                <span class="service-badge google">Google @(IsGoogleConnected ? "‚úì" : "")</span>
                                            }
                                            @if (HasMicrosoftCredentials)
                                            {
                                                <span class="service-badge microsoft">Microsoft @(IsMicrosoftConnected ? "‚úì" : "")</span>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>

                        <!-- Personal Info -->
                        <div class="cred-dropdown">
                            <button class="cred-dropdown-btn" @onclick="TogglePersonalInfo">
                                <span>&#128100; Personal</span>
                                <span class="dropdown-arrow @(ShowPersonalInfo ? "open" : "")">&#9656;</span>
                            </button>
                            @if (ShowPersonalInfo)
                            {
                                <div class="cred-dropdown-content personal-info">
                                    <div class="info-field">
                                        <label>Display Name</label>
                                        <input type="text" @bind="ProfileDisplayName" placeholder="Your name" />
                                    </div>
                                    <div class="info-field">
                                        <label>Email</label>
                                        <input type="email" @bind="ProfileEmail" placeholder="your@email.com" />
                                    </div>
                                    <div class="info-field">
                                        <label>Phone</label>
                                        <input type="tel" @bind="ProfilePhone" placeholder="+1 234 567 8900" />
                                    </div>
                                    <div class="info-field">
                                        <label>Address (optional)</label>
                                        <input type="text" @bind="ProfileAddress" placeholder="123 Main St, City" />
                                    </div>
                                    <button class="save-profile-btn" @onclick="SaveProfile">
                                        @(IsSavingProfile ? "Saving..." : "Save")
                                    </button>
                                    @if (!string.IsNullOrEmpty(ProfileMessage))
                                    {
                                        <div class="profile-message @(ProfileMessage.Contains("Error") ? "error" : "success")">@ProfileMessage</div>
                                    }
                                </div>
                            }
                        </div>

                        <!-- Other Credentials -->
                        <div class="cred-dropdown">
                            <button class="cred-dropdown-btn" @onclick="ToggleOtherCredentials">
                                <span>&#128274; Other</span>
                                <span class="dropdown-arrow @(ShowOtherCredentials ? "open" : "")">&#9656;</span>
                            </button>
                            @if (ShowOtherCredentials)
                            {
                                <div class="cred-dropdown-content other-creds">
                                    <div class="cred-item">
                                        <span class="cred-label">SendGrid (Email)</span>
                                        <span class="cred-status @(NotificationServiceAvailable ? "configured" : "")">
                                            @(NotificationServiceAvailable ? "‚úì" : "‚Äî")
                                        </span>
                                    </div>
                                    <div class="cred-item">
                                        <span class="cred-label">Twilio (SMS)</span>
                                        <span class="cred-status">‚Äî</span>
                                    </div>
                                    <div class="cred-item">
                                        <span class="cred-label">Claude AI</span>
                                        <span class="cred-status configured">‚úì</span>
                                    </div>
                                    <p class="cred-note">Set in appsettings.json</p>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            <div class="setting-group user-section">
                <label>Signed in as</label>
                <span class="username">@CurrentUsername</span>
                <button class="logout-btn" @onclick="Logout">Logout</button>
            </div>

            <!-- Groups Section -->
            <div class="setting-group groups-section">
                <label>Groups</label>
                <div class="groups-list">
                    @foreach (var group in UserGroups)
                    {
                        <div class="group-item">
                            <span class="group-name">@group.Name</span>
                            <button class="group-manage-btn" @onclick="() => OpenGroupModal(group)">...</button>
                        </div>
                    }
                </div>
                <button class="create-group-btn" @onclick="OpenCreateGroupModal">+ Create Group</button>
            </div>
        </div>
    </div>

    <!-- Center Panel: Tasks -->
    <div class="center-panel">
        <!-- Header -->
        <div class="task-header">
            <span class="header-icon">&#128197;</span>
            <span class="header-text">@GetHeaderText()</span>
        </div>

        <!-- Add Task -->
        <div class="add-task @(SelectedDate.Date < LocalToday ? "past-date" : "")">
            <input type="text" @bind="NewTaskText" @bind:event="oninput"
                   @onkeydown="HandleKeyDown" placeholder="@(SelectedDate.Date < LocalToday ? "Viewing past date - tasks will be added to today" : "Enter a new task...")" />
            <input type="text" @bind="NewTaskTimeText" @bind:event="oninput" class="time-input"
                   placeholder="9:00" pattern="[0-9]{1,2}:[0-9]{2}" title="Time (e.g. 9:00, 14:30)" />
            <button @onclick="AddTask">Add</button>
            <div class="template-dropdown">
                <button class="template-btn" @onclick="ToggleTemplateDropdown" title="Use template">&#128203;</button>
                <button class="search-btn" @onclick="ToggleSearchPanel" title="AI Search">&#128269;</button>
                @if (ShowTemplateDropdown)
                {
                    <div class="template-menu">
                        @if (TaskTemplates.Any())
                        {
                            @foreach (var template in TaskTemplates)
                            {
                                <div class="template-item" @onclick="() => CreateFromTemplate(template)">
                                    <span class="template-name">@template.Name</span>
                                    @if (template.SubtaskTemplates.Any())
                                    {
                                        <span class="template-subtask-count">@template.SubtaskTemplates.Count subtasks</span>
                                    }
                                </div>
                            }
                            <div class="template-divider"></div>
                        }
                        <div class="template-item manage" @onclick="OpenTemplateManager">
                            <span>&#9881; Manage Templates</span>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Search Panel -->
        @if (ShowSearchPanel)
        {
            <div class="search-panel">
                <div class="search-header">
                    <span class="search-icon">&#128269;</span>
                    <span>AI-Powered Search</span>
                    <button class="close-search-btn" @onclick="CloseSearchPanel">√ó</button>
                </div>
                <div class="search-input-row">
                    <input type="text" @bind="SearchQuery" @bind:event="oninput"
                           @onkeydown="HandleSearchKeyDown" placeholder="Search tasks... (e.g., 'meetings last week', 'incomplete work tasks')"
                           class="search-input" />
                    <button class="search-execute-btn" @onclick="ExecuteSearch" disabled="@IsSearching">
                        @if (IsSearching)
                        {
                            <span>...</span>
                        }
                        else
                        {
                            <span>Search</span>
                        }
                    </button>
                </div>
                @if (SearchResults != null)
                {
                    <div class="search-results">
                        <div class="search-summary">@SearchResults.Summary</div>
                        @if (SearchResults.Results.Any())
                        {
                            <div class="search-results-list">
                                @foreach (var result in SearchResults.Results)
                                {
                                    <div class="search-result-item @(result.Task.IsCompleted ? "completed" : "")" @onclick="() => NavigateToTask(result.Task)">
                                        <div class="result-date-line">
                                            <span class="result-date-icon">&#128197;</span>
                                            <span class="result-date">@result.Task.TaskDate.ToString("ddd, MMM d, yyyy")</span>
                                            @if (result.Task.ScheduledTime.HasValue)
                                            {
                                                <span class="result-time">@FormatTime(result.Task.ScheduledTime)</span>
                                            }
                                        </div>
                                        <div class="result-title">@result.Task.Title</div>
                                        <div class="result-meta">
                                            <span class="result-type">@result.Task.TaskType</span>
                                            <span class="result-status">@(result.Task.IsCompleted ? "‚úì Done" : result.Task.IsStarted ? "‚ñ∂ Started" : "‚óã Pending")</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="no-results">No matching tasks found.</div>
                        }
                    </div>
                }
            </div>
        }

        <!-- Calendar Tabs - Always show -->
        <div class="calendar-tabs-container">
            <div class="tab-bar">
                <button class="tab @(ActiveCalendarTab == CalendarSource.Integrated ? "active" : "")"
                        @onclick="() => SetCalendarTab(CalendarSource.Integrated)">
                    <span class="tab-icon">üìã</span> All Tasks
                    @if (TotalTaskCount > 0)
                    {
                        <span class="tab-count">@TotalTaskCount</span>
                    }
                </button>
                <button class="tab google-tab @(ActiveCalendarTab == CalendarSource.Google ? "active" : "") @(IsGoogleConnected ? "" : "disconnected")"
                        @onclick="() => SetCalendarTab(CalendarSource.Google)">
                    <span class="tab-icon google-tab-icon">G</span> Google
                    @if (IsGoogleConnected && GoogleEventCount > 0)
                    {
                        <span class="tab-count">@GoogleEventCount</span>
                    }
                    else if (HasGoogleCredentials && !IsGoogleConnected)
                    {
                        <span class="tab-status" title="Configured - click to connect">‚öô</span>
                    }
                    else if (!HasGoogleCredentials)
                    {
                        <span class="tab-status">‚óã</span>
                    }
                </button>
                <button class="tab microsoft-tab @(ActiveCalendarTab == CalendarSource.Microsoft ? "active" : "") @(IsMicrosoftConnected ? "" : "disconnected")"
                        @onclick="() => SetCalendarTab(CalendarSource.Microsoft)">
                    <span class="tab-icon microsoft-tab-icon">M</span> Teams
                    @if (IsMicrosoftConnected && MicrosoftEventCount > 0)
                    {
                        <span class="tab-count">@MicrosoftEventCount</span>
                    }
                    else if (HasMicrosoftCredentials && !IsMicrosoftConnected)
                    {
                        <span class="tab-status" title="Configured - click to connect">‚öô</span>
                    }
                    else if (!HasMicrosoftCredentials)
                    {
                        <span class="tab-status">‚óã</span>
                    }
                </button>
            </div>
        </div>

        <!-- External Calendar Events (when on Google or Teams tab) -->
        @if (ActiveCalendarTab == CalendarSource.Google || ActiveCalendarTab == CalendarSource.Microsoft)
        {
            @if ((ActiveCalendarTab == CalendarSource.Google && !IsGoogleConnected) ||
                 (ActiveCalendarTab == CalendarSource.Microsoft && !IsMicrosoftConnected))
            {
                @if ((ActiveCalendarTab == CalendarSource.Google && HasGoogleCredentials) ||
                     (ActiveCalendarTab == CalendarSource.Microsoft && HasMicrosoftCredentials))
                {
                    <!-- Credentials configured, show connect button -->
                    <div class="connect-prompt">
                        <div class="connect-icon">@(ActiveCalendarTab == CalendarSource.Google ? "üî¥" : "üîµ")</div>
                        <h3>@(ActiveCalendarTab == CalendarSource.Google ? "Google Calendar" : "Microsoft Teams") - Ready to Connect</h3>
                        <p>Your credentials are configured. Click below to authorize access to your calendar.</p>
                        @if (ActiveCalendarTab == CalendarSource.Google)
                        {
                            <button class="connect-btn" @onclick="ConnectGoogle">
                                Connect Google Calendar
                            </button>
                        }
                        else
                        {
                            <button class="connect-btn" @onclick="ConnectMicrosoft">
                                Connect Microsoft Teams
                            </button>
                        }
                    </div>
                }
                else
                {
                    <!-- No credentials, prompt to configure -->
                    <div class="connect-prompt">
                        <div class="connect-icon">@(ActiveCalendarTab == CalendarSource.Google ? "üî¥" : "üîµ")</div>
                        <h3>@(ActiveCalendarTab == CalendarSource.Google ? "Google Calendar" : "Microsoft Teams") not configured</h3>
                        <p>Configure your credentials in Settings to connect this calendar.</p>
                        <button class="connect-btn" @onclick="GoToSettings">
                            ‚öô Go to Settings
                        </button>
                    </div>
                }
            }
            else
            {
                <div class="external-events-list">
                    @if (IsLoadingExternalEvents)
                    {
                        <div class="loading-events">Loading events...</div>
                    }
                    else if (!ExternalEvents.Any())
                    {
                        <div class="no-events">No events for this period</div>
                    }
                    else
                    {
                        @foreach (var evt in ExternalEvents)
                        {
                            <div class="external-event-row @(evt.IsImported ? "imported" : "")">
                                <div class="event-details">
                                    <span class="event-title">@evt.Title</span>
                                    <span class="event-time">
                                        @(evt.IsAllDay ? "All day" : evt.Start.ToString("h:mm tt"))
                                    </span>
                                    @if (!string.IsNullOrEmpty(evt.Location))
                                    {
                                        <span class="event-location">üìç @evt.Location</span>
                                    }
                                </div>
                                <div class="event-actions">
                                    @if (evt.IsImported)
                                    {
                                        <span class="imported-label">‚úì Added</span>
                                    }
                                    else
                                    {
                                        <button class="add-to-integrated-btn" @onclick="() => ImportSingleEvent(evt)">
                                            ‚Üí Add to All
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                        @if (ExternalEvents.Any(e => !e.IsImported))
                        {
                            <button class="import-all-btn" @onclick="ImportAllExternalEvents">
                                Import All (@ExternalEvents.Count(e => !e.IsImported) events)
                            </button>
                        }
                    }
                </div>
            }
        }

        <!-- Task List (show on All Tasks tab) -->
        <div class="task-list" style="@(ActiveCalendarTab != CalendarSource.Integrated ? "display:none" : "")">
            @if (IsDailyView)
            {
                <!-- Task Section Tabs -->
                <div class="task-section-tabs">
                    <button class="section-tab @(ActiveTaskSection == TaskSection.Scheduled ? "active" : "")"
                            @onclick="() => SetTaskSection(TaskSection.Scheduled)">
                        <span class="tab-icon">&#128337;</span> Scheduled
                        @if (ScheduledTasks.Any())
                        {
                            <span class="tab-count">@ScheduledTasks.Count</span>
                        }
                    </button>
                    <button class="section-tab @(ActiveTaskSection == TaskSection.Tasks ? "active" : "")"
                            @onclick="() => SetTaskSection(TaskSection.Tasks)">
                        <span class="tab-icon">&#128203;</span> Tasks
                        @if (AllDayTasks.Any())
                        {
                            <span class="tab-count">@AllDayTasks.Count</span>
                        }
                    </button>
                    <button class="section-tab @(ActiveTaskSection == TaskSection.Waiting ? "active" : "")"
                            @onclick="() => SetTaskSection(TaskSection.Waiting)">
                        <span class="tab-icon">&#9203;</span> Waiting
                        @if (OverdueTasks.Any())
                        {
                            <span class="tab-count">@OverdueTasks.Count</span>
                        }
                    </button>
                </div>

                @if (ActiveTaskSection == TaskSection.Scheduled)
                {
                    <div class="scheduled-section">
                        @foreach (var task in ScheduledTasks)
                        {
                            var isPast = IsTaskInPast(task);
                            <div class="task-row scheduled @(task.IsCompleted ? "completed" : "") @(EditingTaskId == task.Id ? "editing" : "") @(isPast ? "past" : "")">
                                <input type="checkbox" class="started-cb" checked="@task.IsStarted" @onchange="() => ToggleStarted(task)" disabled="@isPast" title="Started" />
                                    <input type="checkbox" class="completed-cb" checked="@task.IsCompleted" @onchange="() => ToggleTask(task)" disabled="@isPast" title="Completed" />
                                <span class="task-time @(isPast ? "readonly" : "")" @onclick="() => OpenTimeEditor(task)">
                                    @FormatTime(task.ScheduledTime)
                                </span>
                                @if (EditingTaskId == task.Id)
                                {
                                    <input type="text" class="task-edit" @bind="EditingTaskText"
                                           @onblur="SaveTaskEdit" @onkeydown="HandleEditKeyDown" />
                                }
                                else
                                {
                                    <span class="task-title @(task.IsCompleted ? "strikethrough" : "")"
                                          @ondblclick="() => StartEditTask(task)">@task.Title</span>
                                }
                                <span class="task-schedule-zone" title="Double-click to edit schedule" @ondblclick="() => OpenTimeEditor(task)"></span>
                                @if (task.Participants.Any())
                                {
                                    <div class="task-participants">
                                        @foreach (var tp in task.Participants.Take(3))
                                        {
                                            <span class="participant-chip" title="@tp.Participant.Name">@GetInitials(tp.Participant.Name)</span>
                                        }
                                        @if (task.Participants.Count > 3)
                                        {
                                            <span class="participant-chip more">+@(task.Participants.Count - 3)</span>
                                        }
                                    </div>
                                }
                                <button class="participants-btn" title="Manage participants" @onclick="() => OpenParticipantsModal(task)">&#128101;</button>
                                @if (task.GroupId.HasValue)
                                {
                                    <span class="group-badge" title="Shared with @(task.Group?.Name ?? "group")">&#128279; @(task.Group?.Name ?? "Group")</span>
                                    <button class="unshare-btn" title="Unshare from group" @onclick="() => UnshareTask(task)">&#10006;</button>
                                }
                                else if (UserGroups.Any())
                                {
                                    <button class="share-btn" title="Share with group" @onclick="() => OpenShareModal(task)">&#128279;</button>
                                }
                                @if (task.DurationMinutes != 30)
                                {
                                    <span class="task-duration">@task.DurationMinutes min</span>
                                }
                                @{ var scheduledAction = GetTaskAction(task); }
                                @if (scheduledAction != null && scheduledAction.ActionType != TaskActionType.None)
                                {
                                    <div class="task-actions">
                                        @if (scheduledAction.ActionType == TaskActionType.Email)
                                        {
                                            <button class="action-btn email-action" title="@GetActionTooltip(scheduledAction)" @onclick="() => ExecuteTaskAction(task, scheduledAction)">&#128231;</button>
                                        }
                                        else if (scheduledAction.ActionType == TaskActionType.Call)
                                        {
                                            <button class="action-btn call-action" title="@GetActionTooltip(scheduledAction)" @onclick="() => ExecuteTaskAction(task, scheduledAction)">&#128222;</button>
                                        }
                                        else if (scheduledAction.ActionType == TaskActionType.Document)
                                        {
                                            <button class="action-btn doc-action" title="@GetActionTooltip(scheduledAction)" @onclick="() => ExecuteTaskAction(task, scheduledAction)">&#128196;</button>
                                        }
                                        else if (scheduledAction.ActionType == TaskActionType.Website)
                                        {
                                            <button class="action-btn web-action" title="@GetActionTooltip(scheduledAction)" @onclick="() => ExecuteTaskAction(task, scheduledAction)">&#127760;</button>
                                        }
                                        else if (scheduledAction.ActionType == TaskActionType.Meeting)
                                        {
                                            <button class="action-btn meeting-action" title="@GetActionTooltip(scheduledAction)" @onclick="() => ExecuteTaskAction(task, scheduledAction)">&#128197;</button>
                                        }
                                    </div>
                                }
                                @if (!isPast)
                                {
                                    <button class="reschedule-btn" title="Reschedule to another day" @onclick="() => OpenRescheduleModal(task)">&#9193;</button>
                                    <button class="clear-time-btn" title="Remove time" @onclick="() => ClearTaskTime(task)">&#10006;</button>
                                    <button class="delete-btn" @onclick="() => DeleteTask(task)">&#128465;</button>
                                }
                            </div>
                            @if (task.Subtasks != null && task.Subtasks.Any())
                            {
                                @foreach (var subtask in task.Subtasks.OrderBy(s => s.SortOrder).ThenBy(s => s.CreatedAt))
                                {
                                    <div class="subtask-row @(subtask.IsCompleted ? "completed" : "")">
                                        <span class="subtask-indent"></span>
                                        <input type="checkbox" checked="@subtask.IsCompleted" @onchange="() => ToggleTask(subtask)" />
                                        <span class="subtask-title @(subtask.IsCompleted ? "strikethrough" : "")">@subtask.Title</span>
                                        <button class="delete-btn small" @onclick="() => DeleteTask(subtask)">&#128465;</button>
                                    </div>
                                }
                            }
                        }
                    </div>
                }

                @if (ActiveTaskSection == TaskSection.Tasks)
                {
                    <div class="allday-section">
                        @if (AllDayTasks.Any())
                        {
                            @foreach (var task in AllDayTasks)
                            {
                                var isPast = IsTaskInPast(task);
                                <div class="task-row @(task.IsCompleted ? "completed" : "") @(EditingTaskId == task.Id ? "editing" : "") @(isPast ? "past" : "") @(DraggingTaskId == task.Id ? "dragging" : "") @(!isPast && !task.IsCompleted ? "draggable-task" : "")"
                                     draggable="@((!isPast && !task.IsCompleted) ? "true" : "false")"
                                     @ondragstart="() => OnDragStart(task)"
                                     @ondragend="OnDragEnd"
                                     @ondblclick="() => OpenTimeEditor(task)"
                                     @ondblclick:stopPropagation="true"
                                     data-task-id="@task.Id">
                                    @if (!isPast && !task.IsCompleted)
                                    {
                                        <span class="drag-handle" title="Drag to schedule">&#9776;</span>
                                    }
                                    <input type="checkbox" checked="@task.IsCompleted" @onchange="() => ToggleTask(task)" disabled="@isPast" />
                                    @if (EditingTaskId == task.Id)
                                    {
                                        <input type="text" class="task-edit" @bind="EditingTaskText"
                                               @onblur="SaveTaskEdit" @onkeydown="HandleEditKeyDown" />
                                    }
                                    else
                                    {
                                        <span class="task-title @(task.IsCompleted ? "strikethrough" : "")"
                                              @ondblclick="() => StartEditTask(task)"
                                              @ondblclick:stopPropagation="true">@task.Title</span>
                                    }
                                    @if (task.RecurrenceType != RecurrenceType.None)
                                    {
                                        <span class="recurring-flag" title="Recurring: @task.RecurrenceType">&#128257;</span>
                                    }
                                    @if (task.Participants.Any())
                                    {
                                        <div class="task-participants">
                                            @foreach (var tp in task.Participants.Take(3))
                                            {
                                                <span class="participant-chip" title="@tp.Participant.Name">@GetInitials(tp.Participant.Name)</span>
                                            }
                                            @if (task.Participants.Count > 3)
                                            {
                                                <span class="participant-chip more">+@(task.Participants.Count - 3)</span>
                                            }
                                        </div>
                                    }
                                    <button class="participants-btn" title="Manage participants" @onclick="() => OpenParticipantsModal(task)">&#128101;</button>
                                    @if (task.GroupId.HasValue)
                                    {
                                        <span class="group-badge" title="Shared with @(task.Group?.Name ?? "group")">&#128279; @(task.Group?.Name ?? "Group")</span>
                                        <button class="unshare-btn" title="Unshare from group" @onclick="() => UnshareTask(task)">&#10006;</button>
                                    }
                                    else if (UserGroups.Any())
                                    {
                                        <button class="share-btn" title="Share with group" @onclick="() => OpenShareModal(task)">&#128279;</button>
                                    }
                                    @{ var allDayAction = GetTaskAction(task); }
                                    @if (allDayAction != null && allDayAction.ActionType != TaskActionType.None)
                                    {
                                        <div class="task-actions">
                                            @if (allDayAction.ActionType == TaskActionType.Email)
                                            {
                                                <button class="action-btn email-action" title="@GetActionTooltip(allDayAction)" @onclick="() => ExecuteTaskAction(task, allDayAction)">&#128231;</button>
                                            }
                                            else if (allDayAction.ActionType == TaskActionType.Call)
                                            {
                                                <button class="action-btn call-action" title="@GetActionTooltip(allDayAction)" @onclick="() => ExecuteTaskAction(task, allDayAction)">&#128222;</button>
                                            }
                                            else if (allDayAction.ActionType == TaskActionType.Document)
                                            {
                                                <button class="action-btn doc-action" title="@GetActionTooltip(allDayAction)" @onclick="() => ExecuteTaskAction(task, allDayAction)">&#128196;</button>
                                            }
                                            else if (allDayAction.ActionType == TaskActionType.Website)
                                            {
                                                <button class="action-btn web-action" title="@GetActionTooltip(allDayAction)" @onclick="() => ExecuteTaskAction(task, allDayAction)">&#127760;</button>
                                            }
                                            else if (allDayAction.ActionType == TaskActionType.Meeting)
                                            {
                                                <button class="action-btn meeting-action" title="@GetActionTooltip(allDayAction)" @onclick="() => ExecuteTaskAction(task, allDayAction)">&#128197;</button>
                                            }
                                        </div>
                                    }
                                    @if (!isPast)
                                    {
                                        <button class="reschedule-btn" title="Move to another day" @onclick="() => OpenRescheduleModal(task)">&#9193;</button>
                                        <button class="schedule-btn" title="Schedule time" @onclick="() => OpenTimeEditor(task)">&#128337;</button>
                                        <button class="delete-btn" @onclick="() => DeleteTask(task)">&#128465;</button>
                                    }
                                </div>
                                @* Render subtasks *@
                                @if (task.Subtasks != null && task.Subtasks.Any())
                                {
                                    @foreach (var subtask in task.Subtasks.OrderBy(s => s.SortOrder).ThenBy(s => s.CreatedAt))
                                    {
                                        <div class="subtask-row @(subtask.IsCompleted ? "completed" : "")">
                                            <span class="subtask-indent"></span>
                                            <input type="checkbox" checked="@subtask.IsCompleted" @onchange="() => ToggleTask(subtask)" />
                                            <span class="subtask-title @(subtask.IsCompleted ? "strikethrough" : "")">@subtask.Title</span>
                                            <button class="delete-btn small" @onclick="() => DeleteTask(subtask)">&#128465;</button>
                                        </div>
                                    }
                                }
                            }
                        }
                        else
                        {
                            <div class="no-tasks">No unscheduled tasks. Add one above!</div>
                        }
                    </div>
                }

                @if (ActiveTaskSection == TaskSection.Waiting)
                {
                    <div class="waiting-tab-section">
                        @if (OverdueTasks.Any())
                        {
                            @foreach (var task in OverdueTasks)
                            {
                                <div class="task-row waiting @(task.ScheduledTime.HasValue ? "was-scheduled" : "") @(DraggingTaskId == task.Id ? "dragging" : "") @(!task.IsCompleted ? "draggable-task" : "")"
                                     draggable="@(!task.IsCompleted ? "true" : "false")"
                                     @ondragstart="() => OnDragStart(task)"
                                     @ondragend="OnDragEnd"
                                     @ondblclick="() => OpenTimeEditor(task)"
                                     data-task-id="@task.Id">
                                    <span class="drag-handle" title="Drag to schedule">&#9776;</span>
                                    @if (task.ScheduledTime.HasValue)
                                    {
                                        <span class="task-time waiting-time" title="Originally scheduled for @FormatTime(task.ScheduledTime)">
                                            @FormatTime(task.ScheduledTime)
                                        </span>
                                    }
                                    <span class="task-title">@task.Title</span>
                                    <span class="task-date waiting-date">@task.TaskDate.ToString("M/d")</span>
                                    <button class="move-btn" title="Move to today" @onclick="() => MoveToToday(task)">&#10132;</button>
                                    <button class="delete-btn" @onclick="() => DeleteOverdueTask(task)">&#128465;</button>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-tasks">No waiting tasks. You're all caught up!</div>
                        }
                    </div>
                }

                @if (!ScheduledTasks.Any() && !AllDayTasks.Any() && !OverdueTasks.Any())
                {
                    <div class="no-tasks">No tasks for this day. Add one above!</div>
                }
            }
            else
            {
                @foreach (var task in WeeklyTasks)
                {
                    var isPast = IsTaskInPast(task);
                    <div class="task-row @(task.IsCompleted ? "completed" : "") @(isPast ? "past" : "")"
                         @ondblclick="() => OpenTimeEditor(task)">
                        <input type="checkbox" class="started-cb" checked="@task.IsStarted" @onchange="() => ToggleStartedWeekly(task)" disabled="@isPast" title="Started" />
                        <input type="checkbox" class="completed-cb" checked="@task.IsCompleted" @onchange="() => ToggleWeeklyTask(task)" disabled="@isPast" title="Completed" />
                        @if (EditingTaskId == task.Id)
                        {
                            <input type="text" class="task-edit" @bind="EditingTaskText"
                                   @onblur="SaveWeeklyTaskEdit" @onkeydown="HandleWeeklyEditKeyDown" />
                        }
                        else
                        {
                            <span class="task-title @(task.IsCompleted ? "strikethrough" : "")"
                                  @ondblclick="() => StartEditWeeklyTask(task)">@task.Title</span>
                        }
                        <span class="task-date">@task.TaskDate.ToString("ddd M/d")</span>
                        <div class="day-indicators">
                            <span class="day-indicator @(task.TaskDate.DayOfWeek == DayOfWeek.Monday ? "active" : "")">M</span>
                            <span class="day-indicator @(task.TaskDate.DayOfWeek == DayOfWeek.Tuesday ? "active" : "")">T</span>
                            <span class="day-indicator @(task.TaskDate.DayOfWeek == DayOfWeek.Wednesday ? "active" : "")">W</span>
                            <span class="day-indicator @(task.TaskDate.DayOfWeek == DayOfWeek.Thursday ? "active" : "")">T</span>
                            <span class="day-indicator @(task.TaskDate.DayOfWeek == DayOfWeek.Friday ? "active" : "")">F</span>
                        </div>
                        @if (!isPast)
                        {
                            <button class="delete-btn" @onclick="() => DeleteWeeklyTask(task)">&#128465;</button>
                        }
                    </div>
                }
            }

            @if ((IsDailyView && !Tasks.Any()) || (!IsDailyView && !WeeklyTasks.Any()))
            {
                <div class="no-tasks">No tasks for this @(IsDailyView ? "day" : "week"). Add one above!</div>
            }
        </div>

    </div>

    <!-- Resize Handle between center panel and schedule -->
    @if (IsDailyView)
    {
        <div class="panel-resize-handle"
             @onmousedown="StartPanelResize"
             title="Drag to resize panels">
            <span class="resize-grip">‚ãÆ‚ãÆ</span>
        </div>
    }

    <!-- Day Roller (draggable multi-day scroller) - Always visible in daily view -->
    @if (IsDailyView)
    {
        <div class="day-roller-wrapper" style="@(SchedulePanelWidth > 0 ? $"width: {SchedulePanelWidth}px !important; min-width: {SchedulePanelWidth}px !important;" : "")">
            <!-- Day Navigation Roller -->
            <div class="day-roller">
                <button class="day-nav-btn up" @onclick="PrevDay" title="Previous Day">&#9650;</button>

                <div class="day-roller-track"
                     @onmousedown="OnRollerMouseDown"
                     @onmousemove="OnRollerMouseMove"
                     @onmouseup="OnRollerMouseUp"
                     @onmouseleave="OnRollerMouseUp"
                     @ontouchstart="OnRollerTouchStart"
                     @ontouchmove="OnRollerTouchMove"
                     @ontouchend="OnRollerTouchEnd"
                     @onwheel="OnRollerWheel"
                     style="transform: translateY(@(rollerOffset)px);">
                    @for (int offset = -7; offset <= 7; offset++)
                    {
                        var dayOffset = offset;
                        var displayDate = SelectedDate.AddDays(dayOffset);
                        var isToday = displayDate.Date == LocalToday;
                        var isSelected = dayOffset == 0;
                        var isWeekend = displayDate.DayOfWeek == DayOfWeek.Saturday || displayDate.DayOfWeek == DayOfWeek.Sunday;
                        var taskCount = GetTaskCountForDate(displayDate);
                        var opacity = 1.0 - (Math.Abs(dayOffset) * 0.05);

                        <div class="day-slot @(isToday ? "today" : "") @(isSelected ? "selected" : "") @(isWeekend ? "weekend" : "")"
                             style="opacity: @opacity.ToString("F2"); cursor: pointer;"
                             @onclick="() => SelectDateFromRoller(displayDate)"
                             @onclick:stopPropagation="true">
                            <span class="day-name">@displayDate.ToString("ddd")</span>
                            <span class="day-num">@displayDate.Day</span>
                            <span class="day-month">@displayDate.ToString("MMM")</span>
                            @if (taskCount > 0)
                            {
                                <span class="day-task-count">@taskCount</span>
                            }
                        </div>
                    }
                </div>

                <button class="day-nav-btn down" @onclick="NextDay" title="Next Day">&#9660;</button>

                <div class="roller-actions">
                    <button class="roller-today-btn" @onclick="GoToToday" title="Jump to Today">Today</button>
                </div>
            </div>

            <!-- Time & Tasks Panel - Always visible (20-minute slots) -->
            <div class="time-tasks-panel">
                <div class="time-panel-body">
                    <div class="time-column" @ref="timeRollerRef" @onscroll="OnTimeRollerScroll">
                        @foreach (var slot in GetTimeSlots())
                        {
                            var isCurrentSlot = IsCurrentTimeSlot(slot);
                            var hasItems = GetTasksAtSlot(slot).Any() || GetGoogleEventsAtSlot(slot).Any();
                            var isNonWorking = slot.Hours < 8 || slot.Hours >= 18;
                            var isHourStart = slot.Minutes == 0;

                            <div class="time-slot @(isCurrentSlot ? "now" : "") @(hasItems ? "has-items" : "") @(isNonWorking ? "off-hours" : "") @(isHourStart ? "hour-start" : "")">
                                <span class="hour-text">@FormatTimeSlot(slot)</span>
                            </div>
                        }
                    </div>

                    <div class="tasks-column" @ref="syncedTasksRef" @onscroll="OnSyncedTasksScroll">
                        @foreach (var slot in GetTimeSlots())
                        {
                            var tasksAtSlot = GetTasksAtSlot(slot);
                            var eventsAtSlot = GetGoogleEventsAtSlot(slot);
                            var isCurrentSlot = IsCurrentTimeSlot(slot);
                            var hasItems = tasksAtSlot.Any() || eventsAtSlot.Any();
                            var isNonWorking = slot.Hours < 8 || slot.Hours >= 18;
                            var isPastSlot = SelectedDate.Date < LocalToday || (SelectedDate.Date == LocalToday && slot < DateTime.Now.TimeOfDay);
                            var isHourStart = slot.Minutes == 0;

                            <div class="task-slot @(isCurrentSlot ? "now" : "") @(hasItems ? "has-items" : "") @(isNonWorking ? "off-hours" : "") @(DragOverSlot == slot ? "drag-over" : "") @(isPastSlot ? "past-slot" : "") @(isHourStart ? "hour-start" : "")"
                                 @ondragover="(e) => OnDragOverSlot(e, slot)"
                                 @ondragover:preventDefault
                                 @ondragleave="OnDragLeaveSlot"
                                 @ondrop="() => OnDropOnSlot(slot)" @ondrop:preventDefault
                                 data-slot="@slot.TotalMinutes">
                                @if (DragOverSlot == slot && DraggingTaskId.HasValue && !isPastSlot)
                                {
                                    <div class="drop-preview">Drop to schedule at @FormatTimeSlot(slot)</div>
                                }
                                @foreach (var task in tasksAtSlot)
                                {
                                    var isTaskDragging = DraggingScheduledTaskId == task.Id;
                                    var isSelected = SelectedScheduleTaskId == task.Id;
                                    <div class="slot-task @(task.IsCompleted ? "done" : "") @(isSelected ? "selected" : "") @(isTaskDragging ? "dragging" : "")"
                                         draggable="@(!task.IsCompleted && !isPastSlot ? "true" : "false")"
                                         @ondragstart="() => OnScheduledTaskDragStart(task)"
                                         @ondragend="OnScheduledTaskDragEnd"
                                         @onclick="() => SelectTaskFromSchedule(task)"
                                         @ondblclick="() => OpenAppointmentDetail(task)">
                                        @if (!task.IsCompleted && !isPastSlot)
                                        {
                                            <span class="slot-drag-handle" title="Drag to reschedule">&#8597;</span>
                                        }
                                        <span class="t-time">@FormatTime(task.ScheduledTime)</span>
                                        <span class="t-title">@task.Title</span>
                                        @if (task.RecurrenceType != RecurrenceType.None)
                                        {
                                            <span class="t-recurring">&#128257;</span>
                                        }
                                        <span class="t-src pfd">P</span>
                                    </div>
                                }
                                @foreach (var evt in eventsAtSlot)
                                {
                                    <div class="slot-task google">
                                        <span class="t-time">@evt.Start.ToString("h:mm")</span>
                                        <span class="t-title">@evt.Title</span>
                                        <span class="t-src google">G</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>

            </div>
        </div>
    }

    <!-- Time Editor Modal -->
    @if (EditingTimeTask != null)
    {
        <div class="modal-overlay" @onclick="CloseTimeEditor">
            <div class="time-editor-modal" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <span>Schedule Task</span>
                    <button class="close-btn" @onclick="CloseTimeEditor">&#10005;</button>
                </div>
                <div class="modal-body">
                    <div class="modal-task-title">@EditingTimeTask.Title</div>
                    <div class="time-picker-row">
                        <label>Time:</label>
                        <input type="text" @bind="EditingTimeValue" placeholder="HH:mm (e.g. 09:00)" />
                    </div>
                    <div class="duration-row">
                        <label>Duration:</label>
                        <select @bind="EditingDuration">
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="45">45 minutes</option>
                            <option value="60">1 hour</option>
                            <option value="90">1.5 hours</option>
                            <option value="120">2 hours</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="cancel-btn" @onclick="CloseTimeEditor">Cancel</button>
                    <button class="save-btn" @onclick="SaveTaskTime">Save</button>
                </div>
            </div>
        </div>
    }

    <!-- Reschedule Modal -->
    @if (ReschedulingTask != null)
    {
        <div class="modal-overlay" @onclick="CloseRescheduleModal">
            <div class="reschedule-modal" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <span>&#9193; Reschedule Task</span>
                    <button class="close-btn" @onclick="CloseRescheduleModal">&#10005;</button>
                </div>
                <div class="modal-body">
                    <div class="modal-task-title">@ReschedulingTask.Title</div>
                    @if (ReschedulingTask.ScheduledTime.HasValue)
                    {
                        <div class="current-schedule">Currently: @ReschedulingTask.TaskDate.ToString("ddd, MMM d") at @FormatTime(ReschedulingTask.ScheduledTime)</div>
                    }
                    else
                    {
                        <div class="current-schedule">Currently: @ReschedulingTask.TaskDate.ToString("ddd, MMM d")</div>
                    }

                    <div class="quick-reschedule">
                        <label>Quick options:</label>
                        <div class="quick-buttons">
                            <button @onclick="() => QuickReschedule(LocalToday.AddDays(1), null)">Tomorrow</button>
                            <button @onclick="() => QuickReschedule(LocalToday.AddDays(1), new TimeSpan(9, 0, 0))">Tomorrow Morning</button>
                            <button @onclick="() => QuickReschedule(LocalToday.AddDays(1), new TimeSpan(14, 0, 0))">Tomorrow Afternoon</button>
                        </div>
                        <div class="quick-buttons" style="margin-top: 6px;">
                            <button @onclick="() => QuickReschedule(GetNextWeekday(LocalToday, DayOfWeek.Monday), null)">Next Monday</button>
                            <button @onclick="() => QuickReschedule(LocalToday.AddDays(7), null)">Next Week</button>
                        </div>
                    </div>

                    <div class="date-picker-row">
                        <label>Or pick a date:</label>
                        <input type="date" @bind="RescheduleTargetDate" min="@LocalToday.ToString("yyyy-MM-dd")" />
                    </div>

                    <div class="time-entry-row">
                        <label>Schedule for:</label>
                        <div class="time-options">
                            <button class="time-preset @(RescheduleTimePreset == "morning" ? "active" : "")"
                                    @onclick='() => SetRescheduleTimePreset("morning")'>üåÖ Morning (9am)</button>
                            <button class="time-preset @(RescheduleTimePreset == "afternoon" ? "active" : "")"
                                    @onclick='() => SetRescheduleTimePreset("afternoon")'>‚òÄÔ∏è Afternoon (2pm)</button>
                            <button class="time-preset @(RescheduleTimePreset == "evening" ? "active" : "")"
                                    @onclick='() => SetRescheduleTimePreset("evening")'>üåô Evening (6pm)</button>
                            <button class="time-preset @(RescheduleTimePreset == "custom" ? "active" : "")"
                                    @onclick='() => SetRescheduleTimePreset("custom")'>‚è∞ Custom</button>
                            <button class="time-preset @(RescheduleTimePreset == "none" ? "active" : "")"
                                    @onclick='() => SetRescheduleTimePreset("none")'>üìã No time</button>
                        </div>
                        @if (RescheduleTimePreset == "custom")
                        {
                            <div class="custom-time-input">
                                <input type="text" @bind="RescheduleCustomTime" placeholder="e.g. 15:30 or 3:30 PM" />
                            </div>
                        }
                    </div>

                    @if (ReschedulingTask.ScheduledTime.HasValue && RescheduleTimePreset == "none")
                    {
                        <div class="keep-time-option">
                            <label>
                                <input type="checkbox" @bind="KeepScheduledTime" />
                                Keep original time (@FormatTime(ReschedulingTask.ScheduledTime))
                            </label>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="cancel-btn" @onclick="CloseRescheduleModal">Cancel</button>
                    <button class="save-btn" @onclick="ConfirmReschedule">Reschedule</button>
                </div>
            </div>
        </div>
    }

    <!-- Participants/Invitees Modal -->
    @if (ParticipantsTask != null)
    {
        <div class="modal-overlay" @onclick="CloseParticipantsModal">
            <div class="participants-modal" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <span>&#128101; @(IsMeetingTask(ParticipantsTask) ? "Meeting Invitees" : "Participants")</span>
                    <button class="close-btn" @onclick="CloseParticipantsModal">&#10005;</button>
                </div>
                <div class="modal-body">
                    <div class="modal-task-title">@ParticipantsTask.Title</div>
                    @if (ParticipantsTask.ScheduledTime.HasValue)
                    {
                        <div class="modal-task-time">@FormatTime(ParticipantsTask.ScheduledTime) on @ParticipantsTask.TaskDate.ToString("ddd, MMM d")</div>
                    }

                    <!-- Current participants/invitees -->
                    @if (ParticipantsTask.Participants.Any())
                    {
                        <div class="current-participants">
                            <label>@(IsMeetingTask(ParticipantsTask) ? "Invitees:" : "Current participants:")</label>
                            <div class="participants-list">
                                @foreach (var tp in ParticipantsTask.Participants)
                                {
                                    <div class="participant-item">
                                        <span class="participant-avatar">@GetInitials(tp.Participant.Name)</span>
                                        <div class="participant-info">
                                            <span class="participant-name">@tp.Participant.Name</span>
                                            @if (!string.IsNullOrEmpty(tp.Participant.Email))
                                            {
                                                <span class="participant-email">@tp.Participant.Email</span>
                                            }
                                            @if (!string.IsNullOrEmpty(tp.Participant.Phone))
                                            {
                                                <span class="participant-phone">@tp.Participant.Phone</span>
                                            }
                                        </div>
                                        <div class="participant-actions">
                                            @if (!string.IsNullOrEmpty(tp.Participant.Email))
                                            {
                                                <button class="invitee-action-btn email-btn" title="Send email invitation" @onclick="() => SendEmailInvite(tp.Participant)">&#128231;</button>
                                            }
                                            @if (!string.IsNullOrEmpty(tp.Participant.Phone))
                                            {
                                                <button class="invitee-action-btn call-btn" title="Call invitee" @onclick="() => CallInvitee(tp.Participant)">&#128222;</button>
                                            }
                                            <button class="remove-participant-btn" title="Remove" @onclick="() => RemoveParticipantFromTask(tp.Participant)">&#10005;</button>
                                        </div>
                                    </div>
                                }
                            </div>
                            @if (IsMeetingTask(ParticipantsTask) && ParticipantsTask.Participants.Any(p => !string.IsNullOrEmpty(p.Participant.Email) || !string.IsNullOrEmpty(p.Participant.Phone)))
                            {
                                <div class="invite-buttons">
                                    @if (NotificationServiceAvailable)
                                    {
                                        <button class="send-all-invites-btn primary" @onclick="SendNotificationsToAll" disabled="@IsSendingNotifications">
                                            @if (IsSendingNotifications)
                                            {
                                                <span>Sending...</span>
                                            }
                                            else
                                            {
                                                <span>&#128232; Send Invites</span>
                                            }
                                        </button>
                                    }
                                    <button class="send-all-invites-btn" @onclick="SendAllEmailInvites">
                                        &#128231; Open Email Client
                                    </button>
                                </div>
                            }
                        </div>
                    }

                    <!-- Share with group members -->
                    @if (IsMeetingTask(ParticipantsTask) && ParticipantsTask.GroupId.HasValue && GroupMembers.Any())
                    {
                        <div class="group-members-section">
                            <label>Add to group members' calendars:</label>
                            <div class="group-members-list">
                                @foreach (var member in GroupMembers.Where(m => m.Id != CurrentUserId))
                                {
                                    <div class="group-member-item">
                                        <span class="member-avatar">@GetInitials(member.Username)</span>
                                        <span class="member-name">@member.Username</span>
                                        <button class="add-to-calendar-btn" title="Add meeting to their calendar" @onclick="() => AddMeetingToMemberCalendar(member)">
                                            &#128197; Add to Calendar
                                        </button>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Add participant -->
                    <div class="add-participant-section">
                        <label>Add @(IsMeetingTask(ParticipantsTask) ? "invitee" : "participant"):</label>
                        <div class="add-participant-form">
                            <div class="add-participant-row">
                                <input type="text" @bind="NewParticipantName" placeholder="Name" class="participant-name-input" />
                            </div>
                            <div class="add-participant-row">
                                <input type="email" @bind="NewParticipantEmail" placeholder="Email" class="participant-email-input" />
                                <input type="tel" @bind="NewParticipantPhone" placeholder="Phone" class="participant-phone-input" />
                            </div>
                            <button class="add-participant-btn" @onclick="AddNewParticipant">Add</button>
                        </div>
                    </div>

                    <!-- Recent participants -->
                    @if (RecentParticipants.Any())
                    {
                        <div class="recent-participants">
                            <label>Recent:</label>
                            <div class="recent-chips">
                                @foreach (var p in RecentParticipants.Where(rp => !ParticipantsTask.Participants.Any(tp => tp.ParticipantId == rp.Id)))
                                {
                                    <button class="recent-chip" @onclick="() => AddExistingParticipant(p)">
                                        @p.Name
                                    </button>
                                }
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(ParticipantsMessage))
                    {
                        <div class="participants-message @(ParticipantsMessage.Contains("Error") ? "error" : "")">@ParticipantsMessage</div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="save-btn" @onclick="CloseParticipantsModal">Done</button>
                </div>
            </div>
        </div>
    }

    <!-- Share Task Modal -->
    @if (ShareTask != null)
    {
        <div class="modal-overlay" @onclick="CloseShareModal">
            <div class="share-modal" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <span>&#128279; Share Task with Group</span>
                    <button class="close-btn" @onclick="CloseShareModal">&#10005;</button>
                </div>
                <div class="modal-body">
                    <div class="modal-task-title">@ShareTask.Title</div>

                    <div class="share-group-section">
                        <label>Select a group to share with:</label>
                        <div class="group-options">
                            @foreach (var group in UserGroups)
                            {
                                <button class="group-option @(SelectedShareGroupId == group.Id ? "selected" : "")"
                                        @onclick="() => SelectShareGroup(group.Id)">
                                    <span class="group-icon">&#128101;</span>
                                    <span class="group-name">@group.Name</span>
                                </button>
                            }
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(ShareMessage))
                    {
                        <div class="share-message @(ShareMessage.Contains("Error") ? "error" : "success")">@ShareMessage</div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="cancel-btn" @onclick="CloseShareModal">Cancel</button>
                    <button class="save-btn" @onclick="ConfirmShareTask" disabled="@(SelectedShareGroupId == 0)">Share</button>
                </div>
            </div>
        </div>
    }

    <!-- Appointment Detail Panel (double-click on scheduled task) -->
    @if (AppointmentDetailTask != null)
    {
        <div class="modal-overlay" @onclick="CloseAppointmentDetail">
            <div class="appointment-detail-panel" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <span>&#128197; Appointment Details</span>
                    <button class="close-btn" @onclick="CloseAppointmentDetail">&#10005;</button>
                </div>
                <div class="modal-body">
                    <!-- Title -->
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" @bind="AppointmentTitle" placeholder="Appointment title" />
                    </div>

                    <!-- Description -->
                    <div class="form-group">
                        <label>Description</label>
                        <textarea @bind="AppointmentDescription" placeholder="Add notes or details..." rows="3"></textarea>
                    </div>

                    <!-- Date & Time -->
                    <div class="form-row">
                        <div class="form-group half">
                            <label>Date</label>
                            <div class="date-display">@AppointmentDetailTask.TaskDate.ToString("ddd, MMM d, yyyy")</div>
                        </div>
                        <div class="form-group half">
                            <label>Time</label>
                            <input type="text" @bind="AppointmentTimeValue" placeholder="HH:mm (e.g. 09:00)" />
                        </div>
                    </div>

                    <!-- Duration -->
                    <div class="form-group">
                        <label>Duration</label>
                        <div class="duration-options">
                            <button class="duration-btn @(AppointmentDuration == 15 ? "selected" : "")" @onclick="() => AppointmentDuration = 15">15m</button>
                            <button class="duration-btn @(AppointmentDuration == 30 ? "selected" : "")" @onclick="() => AppointmentDuration = 30">30m</button>
                            <button class="duration-btn @(AppointmentDuration == 45 ? "selected" : "")" @onclick="() => AppointmentDuration = 45">45m</button>
                            <button class="duration-btn @(AppointmentDuration == 60 ? "selected" : "")" @onclick="() => AppointmentDuration = 60">1h</button>
                            <button class="duration-btn @(AppointmentDuration == 90 ? "selected" : "")" @onclick="() => AppointmentDuration = 90">1.5h</button>
                            <button class="duration-btn @(AppointmentDuration == 120 ? "selected" : "")" @onclick="() => AppointmentDuration = 120">2h</button>
                        </div>
                    </div>

                    <!-- Recurrence Section -->
                    <div class="form-group">
                        <label>&#128257; Repeat</label>
                        <div class="recurrence-options">
                            <button class="recurrence-btn @(AppointmentRecurrence == RecurrenceType.None ? "selected" : "")" @onclick="() => AppointmentRecurrence = RecurrenceType.None">Never</button>
                            <button class="recurrence-btn @(AppointmentRecurrence == RecurrenceType.Daily ? "selected" : "")" @onclick="() => AppointmentRecurrence = RecurrenceType.Daily">Daily</button>
                            <button class="recurrence-btn @(AppointmentRecurrence == RecurrenceType.Weekly ? "selected" : "")" @onclick="() => AppointmentRecurrence = RecurrenceType.Weekly">Weekly</button>
                            <button class="recurrence-btn @(AppointmentRecurrence == RecurrenceType.Monthly ? "selected" : "")" @onclick="() => AppointmentRecurrence = RecurrenceType.Monthly">Monthly</button>
                        </div>
                        @if (AppointmentRecurrence != RecurrenceType.None)
                        {
                            <div class="recurrence-details">
                                <div class="recurrence-interval">
                                    <span>Every</span>
                                    <input type="number" min="1" max="30" @bind="AppointmentRecurrenceInterval" />
                                    <span>@GetRecurrenceIntervalLabel()</span>
                                </div>
                                @if (AppointmentRecurrence == RecurrenceType.Weekly)
                                {
                                    <div class="recurrence-days">
                                        <button class="day-btn @(AppointmentRecurrenceDays.Contains("Mon") ? "selected" : "")" @onclick='() => ToggleRecurrenceDay("Mon")'>M</button>
                                        <button class="day-btn @(AppointmentRecurrenceDays.Contains("Tue") ? "selected" : "")" @onclick='() => ToggleRecurrenceDay("Tue")'>T</button>
                                        <button class="day-btn @(AppointmentRecurrenceDays.Contains("Wed") ? "selected" : "")" @onclick='() => ToggleRecurrenceDay("Wed")'>W</button>
                                        <button class="day-btn @(AppointmentRecurrenceDays.Contains("Thu") ? "selected" : "")" @onclick='() => ToggleRecurrenceDay("Thu")'>T</button>
                                        <button class="day-btn @(AppointmentRecurrenceDays.Contains("Fri") ? "selected" : "")" @onclick='() => ToggleRecurrenceDay("Fri")'>F</button>
                                        <button class="day-btn @(AppointmentRecurrenceDays.Contains("Sat") ? "selected" : "")" @onclick='() => ToggleRecurrenceDay("Sat")'>S</button>
                                        <button class="day-btn @(AppointmentRecurrenceDays.Contains("Sun") ? "selected" : "")" @onclick='() => ToggleRecurrenceDay("Sun")'>S</button>
                                    </div>
                                }
                                <div class="recurrence-end">
                                    <label>
                                        <input type="checkbox" @bind="HasRecurrenceEndDate" /> Ends on:
                                    </label>
                                    @if (HasRecurrenceEndDate)
                                    {
                                        <input type="date" @bind="AppointmentRecurrenceEndDate" min="@AppointmentDetailTask.TaskDate.ToString("yyyy-MM-dd")" />
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Invitees/Participants Section -->
                    <div class="form-group">
                        <label>&#128101; Invitees</label>
                        @if (AppointmentDetailTask.Participants.Any())
                        {
                            <div class="invitees-list">
                                @foreach (var tp in AppointmentDetailTask.Participants)
                                {
                                    <div class="invitee-chip">
                                        <span class="invitee-avatar">@GetInitials(tp.Participant.Name)</span>
                                        <span class="invitee-name">@tp.Participant.Name</span>
                                        <button class="remove-invitee" @onclick="() => RemoveAppointmentInvitee(tp.Participant)">&#10005;</button>
                                    </div>
                                }
                            </div>
                        }
                        <div class="add-invitee-row">
                            <input type="text" @bind="NewParticipantName" placeholder="Add invitee name..." @onkeydown="HandleAppointmentInviteeKeyDown" />
                            <button class="add-invitee-btn" @onclick="AddAppointmentInvitee" disabled="@string.IsNullOrWhiteSpace(NewParticipantName)">Add</button>
                        </div>
                        @if (RecentParticipants.Any())
                        {
                            <div class="recent-invitees">
                                <span class="recent-label">Recent:</span>
                                @foreach (var p in RecentParticipants.Take(5))
                                {
                                    @if (!AppointmentDetailTask.Participants.Any(tp => tp.ParticipantId == p.Id))
                                    {
                                        <button class="recent-invitee-btn" @onclick="() => AddRecentToAppointment(p)">@p.Name</button>
                                    }
                                }
                            </div>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(ParticipantsMessage))
                    {
                        <div class="form-message @(ParticipantsMessage.Contains("Error") ? "error" : "success")">@ParticipantsMessage</div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="delete-btn" @onclick="DeleteAppointment">&#128465; Delete</button>
                    <button class="unschedule-btn" @onclick="UnscheduleAppointment" title="Remove from schedule and put back in Tasks list">&#128203; Unschedule</button>
                    <div class="footer-right">
                        <button class="cancel-btn" @onclick="CloseAppointmentDetail">Cancel</button>
                        <button class="save-btn" @onclick="SaveAppointmentDetail" disabled="@IsSavingAppointment">
                            @if (IsSavingAppointment)
                            {
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Save</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Recurring Delete Dialog -->
    @if (ShowRecurringDeleteDialog && DeletingRecurringTask != null)
    {
        <div class="modal-overlay" @onclick="CloseRecurringDeleteDialog">
            <div class="recurring-delete-modal" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <span>&#128465; Delete Recurring Appointment</span>
                    <button class="close-btn" @onclick="CloseRecurringDeleteDialog">&#10005;</button>
                </div>
                <div class="modal-body">
                    <div class="delete-task-title">@DeletingRecurringTask.Title</div>
                    <div class="delete-options">
                        <label class="delete-option">
                            <input type="radio" name="deleteMode" value="this" checked="@(RecurringDeleteMode == "this")" @onchange='() => RecurringDeleteMode = "this"' />
                            <span class="option-label">Delete only this occurrence</span>
                            <span class="option-desc">@DeletingRecurringTask.TaskDate.ToString("ddd, MMM d") @(DeletingRecurringTask.ScheduledTime.HasValue ? "at " + FormatTime(DeletingRecurringTask.ScheduledTime) : "")</span>
                        </label>
                        <label class="delete-option">
                            <input type="radio" name="deleteMode" value="all" checked="@(RecurringDeleteMode == "all")" @onchange='() => RecurringDeleteMode = "all"' />
                            <span class="option-label">Delete all occurrences</span>
                            <span class="option-desc">@RecurringInstances.Count total appointments in this series</span>
                        </label>
                        <label class="delete-option">
                            <input type="radio" name="deleteMode" value="select" checked="@(RecurringDeleteMode == "select")" @onchange='() => RecurringDeleteMode = "select"' />
                            <span class="option-label">Select which to delete</span>
                            <span class="option-desc">Choose specific dates below</span>
                        </label>
                    </div>

                    @if (RecurringDeleteMode == "select")
                    {
                        <div class="instance-selection">
                            <div class="selection-header">
                                <button class="select-all-btn" @onclick="SelectAllInstancesForDeletion">Select All</button>
                                <button class="select-none-btn" @onclick="DeselectAllInstancesForDeletion">Select None</button>
                                <span class="selection-count">@SelectedInstancesForDeletion.Count selected</span>
                            </div>
                            <div class="instance-list">
                                @foreach (var instance in RecurringInstances)
                                {
                                    var isSelected = SelectedInstancesForDeletion.Contains(instance.Id);
                                    var isPast = instance.TaskDate.Date < LocalToday;
                                    <label class="instance-item @(isSelected ? "selected" : "") @(isPast ? "past" : "")">
                                        <input type="checkbox" checked="@isSelected" @onchange="() => ToggleInstanceForDeletion(instance.Id)" />
                                        <span class="instance-date">@instance.TaskDate.ToString("ddd, MMM d")</span>
                                        @if (instance.ScheduledTime.HasValue)
                                        {
                                            <span class="instance-time">@FormatTime(instance.ScheduledTime)</span>
                                        }
                                        @if (instance.Id == DeletingRecurringTask.Id)
                                        {
                                            <span class="current-badge">current</span>
                                        }
                                        @if (isPast)
                                        {
                                            <span class="past-badge">past</span>
                                        }
                                    </label>
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="cancel-btn" @onclick="CloseRecurringDeleteDialog">Cancel</button>
                    <button class="delete-confirm-btn" @onclick="ConfirmRecurringDelete"
                            disabled="@(RecurringDeleteMode == "select" && !SelectedInstancesForDeletion.Any())">
                        Delete @(RecurringDeleteMode == "this" ? "This" : RecurringDeleteMode == "all" ? "All" : SelectedInstancesForDeletion.Count.ToString())
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- AI Insights Panel -->
    @if (ShowAiPanel)
    {
        <div class="ai-panel">
            <div class="ai-header">
                <span class="ai-icon">&#129302;</span>
                <span>AI Insights</span>
                <button class="refresh-btn" @onclick="RefreshAiInsights" title="Refresh">&#8635;</button>
            </div>

            @if (IsAiLoading)
            {
                <div class="ai-loading">
                    <span>&#8987;</span> Analyzing...
                </div>
            }
            else
            {
                <!-- Summary -->
                <div class="ai-section">
                    <div class="ai-section-title">Productivity Summary</div>
                    <p class="ai-summary">@AiSummary</p>
                </div>

                <!-- Suggestions -->
                @if (AiSuggestions.Any())
                {
                    <div class="ai-section">
                        <div class="ai-section-title">Suggestions</div>
                        @foreach (var suggestion in AiSuggestions)
                        {
                            <div class="ai-suggestion">
                                <span class="suggestion-icon">&#128161;</span>
                                <span>@suggestion</span>
                            </div>
                        }
                    </div>
                }

                <!-- Schedule Advice -->
                @if (ScheduleAdvice.Any())
                {
                    <div class="ai-section schedule-advice-section">
                        <div class="ai-section-title">&#128197; Schedule Advice</div>
                        @foreach (var advice in ScheduleAdvice)
                        {
                            <div class="schedule-advice-item @advice.Type.ToLower()">
                                <span class="advice-icon">@GetAdviceIcon(advice.Type)</span>
                                <div class="advice-content">
                                    <div class="advice-title">@advice.Title</div>
                                    <div class="advice-description">@advice.Description</div>
                                    @if (!string.IsNullOrEmpty(advice.ActionLabel))
                                    {
                                        <button class="advice-action-btn" @onclick="() => ApplyScheduleAdvice(advice)">
                                            @advice.ActionLabel
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }

                <!-- Time Gaps -->
                @if (TimeGaps.Any())
                {
                    <div class="ai-section time-gaps-section">
                        <div class="ai-section-title">&#9201; Available Time Slots</div>
                        <div class="time-gaps-list">
                            @foreach (var gap in TimeGaps.Take(4))
                            {
                                <div class="time-gap-item">
                                    <span class="gap-time">@FormatTime(gap.Start) - @FormatTime(gap.End)</span>
                                    <span class="gap-duration">@gap.DurationMinutes min</span>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Priority Tasks -->
                @if (PrioritizedTasks.Any())
                {
                    <div class="ai-section">
                        <div class="ai-section-title">Priority Tasks</div>
                        @foreach (var pt in PrioritizedTasks.Take(5))
                        {
                            <div class="priority-task">
                                <span class="priority-badge priority-@GetPriorityClass(pt.PriorityScore)">@GetPriorityLabel(pt.PriorityScore)</span>
                                <div class="priority-content">
                                    <div class="priority-title">@pt.Task.Title</div>
                                    <div class="priority-reason">@pt.Reasoning</div>
                                </div>
                            </div>
                        }
                    </div>
                }

                <!-- Insight History (shows trends from raw data, not AI-on-AI) -->
                <div class="ai-section insight-history-section">
                    <div class="ai-section-title clickable" @onclick="ToggleInsightHistory">
                        &#128200; Insight History @(ShowInsightHistory ? "&#9660;" : "&#9654;")
                    </div>
                    @if (ShowInsightHistory)
                    {
                        @if (InsightHistoryList.Any())
                        {
                            <div class="insight-history-list">
                                @foreach (var insight in InsightHistoryList.Take(5))
                                {
                                    <div class="insight-history-item @(insight == SelectedHistoryInsight ? "selected" : "")"
                                         @onclick="() => SelectHistoryInsight(insight)">
                                        <div class="history-date">@insight.PeriodEnd.ToString("MMM dd")</div>
                                        <div class="history-stats">
                                            <span class="history-rate" title="Completion rate">@(GetSnapshotCompletionRate(insight))%</span>
                                            <span class="history-trend" title="Trend">@GetTrendIndicator(insight)</span>
                                        </div>
                                    </div>
                                }
                            </div>
                            @if (SelectedHistoryInsight != null)
                            {
                                <div class="insight-history-detail">
                                    <div class="history-detail-header">
                                        <span>@SelectedHistoryInsight.PeriodStart.ToString("MMM dd") - @SelectedHistoryInsight.PeriodEnd.ToString("MMM dd")</span>
                                    </div>
                                    <div class="history-snapshot">
                                        @{
                                            var snapshot = GetSnapshot(SelectedHistoryInsight);
                                            if (snapshot != null)
                                            {
                                                <div class="snapshot-stat">
                                                    <span class="stat-label">Tasks:</span>
                                                    <span class="stat-value">@snapshot.CompletedTasks / @snapshot.TotalTasks</span>
                                                </div>
                                                <div class="snapshot-stat">
                                                    <span class="stat-label">Completion:</span>
                                                    <span class="stat-value">@snapshot.CompletionRate%</span>
                                                </div>
                                                <div class="snapshot-stat">
                                                    <span class="stat-label">Overdue:</span>
                                                    <span class="stat-value @(snapshot.OverdueTasks > 0 ? "warning" : "")">@snapshot.OverdueTasks</span>
                                                </div>
                                                @if (snapshot.PreviousCompletionRate.HasValue)
                                                {
                                                    var change = snapshot.CompletionRate - snapshot.PreviousCompletionRate.Value;
                                                    <div class="snapshot-stat">
                                                        <span class="stat-label">Change:</span>
                                                        <span class="stat-value @(change >= 0 ? "positive" : "negative")">
                                                            @(change >= 0 ? "+" : "")@change.ToString("F1")%
                                                        </span>
                                                    </div>
                                                }
                                            }
                                        }
                                    </div>
                                    @if (!string.IsNullOrEmpty(SelectedHistoryInsight.AiInsightText))
                                    {
                                        <div class="history-ai-text">@SelectedHistoryInsight.AiInsightText</div>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <p class="no-history">No insight history yet. Insights are saved automatically when generated.</p>
                        }
                    }
                </div>
            }
        </div>
    }

    <!-- Group Management Modal -->
    @if (ShowGroupModal)
    {
        <div class="modal-overlay" @onclick="CloseGroupModal">
            <div class="group-modal" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <span>@(IsCreatingGroup ? "Create Group" : $"Manage: {SelectedGroup?.Name}")</span>
                    <button class="close-btn" @onclick="CloseGroupModal">&#10005;</button>
                </div>
                <div class="modal-body">
                    @if (IsCreatingGroup)
                    {
                        <div class="form-group">
                            <label>Group Name</label>
                            <input type="text" @bind="NewGroupName" placeholder="Enter group name..." />
                        </div>
                    }
                    else if (SelectedGroup != null)
                    {
                        <div class="group-members">
                            <h4>Members</h4>
                            @if (GroupMembers.Any())
                            {
                                @foreach (var member in GroupMembers)
                                {
                                    <div class="member-row">
                                        <span class="member-name">@(member.DisplayName ?? member.Username ?? "Unknown")</span>
                                        <span class="member-role">@(member.Id == SelectedGroup.LeaderUserId ? "Leader" : "Member")</span>
                                        @if (member.Id != SelectedGroup.LeaderUserId && SelectedGroup.LeaderUserId == CurrentUserId)
                                        {
                                            <button class="remove-member-btn" @onclick="() => RemoveMember(member)">Remove</button>
                                        }
                                    </div>
                                }
                            }
                            else
                            {
                                <p class="no-members">No members yet</p>
                            }
                        </div>
                        @if (SelectedGroup.LeaderUserId == CurrentUserId)
                        {
                            <div class="add-member-section">
                                <h4>Add Member</h4>
                                <select @bind="SelectedUserIdToAdd">
                                    <option value="0">-- Select User --</option>
                                    @foreach (var user in AllUsers.Where(u => u.Id != CurrentUserId && !GroupMembers.Any(m => m.Id == u.Id)))
                                    {
                                        <option value="@user.Id">@(user.DisplayName ?? user.Username)</option>
                                    }
                                </select>
                                <button class="add-member-btn" @onclick="AddMember" disabled="@(SelectedUserIdToAdd == 0)">Add</button>
                            </div>
                        }
                    }
                </div>
                <div class="modal-footer">
                    @if (IsCreatingGroup)
                    {
                        <button class="cancel-btn" @onclick="CloseGroupModal">Cancel</button>
                        <button class="save-btn" @onclick="CreateGroup">Create</button>
                    }
                    else if (SelectedGroup != null && SelectedGroup.LeaderUserId == CurrentUserId)
                    {
                        <button class="delete-btn" @onclick="DeleteGroup">Delete Group</button>
                        <button class="cancel-btn" @onclick="CloseGroupModal">Close</button>
                    }
                    else
                    {
                        <button class="cancel-btn" @onclick="CloseGroupModal">Close</button>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Task Template Manager Modal -->
    @if (ShowTemplateManager)
    {
        <div class="modal-overlay" @onclick="CloseTemplateManager">
            <div class="template-manager-modal" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <span>Manage Task Templates</span>
                    <button class="close-btn" @onclick="CloseTemplateManager">&#10005;</button>
                </div>
                <div class="modal-body">
                    <div class="template-list-panel">
                        <h4>Templates</h4>
                        <div class="template-list">
                            @foreach (var template in TaskTemplates)
                            {
                                <div class="template-list-item @(EditingTemplate?.Id == template.Id ? "selected" : "")"
                                     @onclick="() => EditTemplate(template)">
                                    <span class="template-name">@template.Name</span>
                                    <span class="subtask-count">@template.SubtaskTemplates.Count steps</span>
                                    <button class="delete-template-btn" @onclick="() => DeleteTemplate(template)" @onclick:stopPropagation="true">&#128465;</button>
                                </div>
                            }
                        </div>
                        <div class="new-template-form">
                            <input type="text" @bind="NewTemplateName" placeholder="New template name..." />
                            <button class="add-template-btn" @onclick="CreateNewTemplate" disabled="@string.IsNullOrWhiteSpace(NewTemplateName)">&#43; Add</button>
                        </div>
                    </div>
                    <div class="template-edit-panel">
                        @if (EditingTemplate != null)
                        {
                            <h4>@EditingTemplate.Name - Subtasks</h4>
                            <div class="subtask-template-list">
                                @foreach (var subtask in EditingTemplate.SubtaskTemplates.OrderBy(s => s.SortOrder))
                                {
                                    <div class="subtask-template-item">
                                        <span class="subtask-order">@(subtask.SortOrder + 1).</span>
                                        <span class="subtask-title">@subtask.Title</span>
                                        <button class="remove-subtask-btn" @onclick="() => RemoveSubtaskFromTemplate(subtask)">&#10005;</button>
                                    </div>
                                }
                            </div>
                            <div class="new-subtask-form">
                                <input type="text" @bind="NewSubtaskTitle" @onkeydown="HandleSubtaskKeyDown" placeholder="Add subtask step..." />
                                <button class="add-subtask-btn" @onclick="AddSubtaskToTemplate" disabled="@string.IsNullOrWhiteSpace(NewSubtaskTitle)">&#43;</button>
                            </div>
                        }
                        else
                        {
                            <div class="no-template-selected">
                                <p>Select a template to edit its subtasks, or create a new template.</p>
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="cancel-btn" @onclick="CloseTemplateManager">Close</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    // LocalToday is set from browser's local time to handle timezone correctly
    private DateTime _localToday = DateTime.Today;
    private DateTime LocalToday
    {
        get => _localToday;
        set => _localToday = value;
    }

    private DateTime _selectedDate = DateTime.Today;
    private DateTime SelectedDate
    {
        get => _selectedDate;
        set
        {
            _selectedDate = value;
            _ = LoadTasksAsync();
        }
    }

    private DateTime CurrentMonth { get; set; } = DateTime.Today;
    private bool IsDailyView { get; set; } = true;
    private string CurrentTheme { get; set; } = "teal";
    private string NewTaskText { get; set; } = "";
    private string NewTaskTimeText { get; set; } = "";
    private List<DailyTask> Tasks { get; set; } = new();
    private List<DailyTask> WeeklyTasks { get; set; } = new();
    private List<DailyTask> OverdueTasks { get; set; } = new();
    private List<DailyTask> AllUnscheduledTasks { get; set; } = new(); // All unscheduled tasks across all dates
    private List<CalendarDay> CalendarDays { get; set; } = new();
    private bool _isLoadingTasks = false; // Prevents concurrent DB calls

    // Computed lists for scheduled/all-day display
    private List<DailyTask> ScheduledTasks => Tasks.Where(t => !t.IsAllDay && t.ScheduledTime.HasValue).ToList();
    private List<DailyTask> AllDayTasks => Tasks.Where(t => t.IsAllDay || !t.ScheduledTime.HasValue).ToList();

    // Task section tabs
    private enum TaskSection { Scheduled, Tasks, Waiting }
    private TaskSection ActiveTaskSection { get; set; } = TaskSection.Scheduled;

    private int? EditingTaskId { get; set; }
    private int? SelectedScheduleTaskId { get; set; } // Selected task in schedule panel (single click)
    private DotNetObjectReference<Planner>? _dotNetRef;

    // Time roller scroll sync
    private ElementReference timeRollerRef;
    private ElementReference syncedTasksRef;
    private bool isSyncingScroll = false;

    // Day roller drag state
    private bool isDragging = false;
    private double dragStartY = 0;
    private double rollerOffset = 0;
    private double totalDragDistance = 0;
    private const double SlotHeight = 55;
    private string EditingTaskText { get; set; } = "";
    private DailyTask? EditingTask { get; set; }

    // Time editor
    private DailyTask? EditingTimeTask { get; set; }
    private string EditingTimeValue { get; set; } = "09:00";
    private int EditingDuration { get; set; } = 30;

    // Reschedule modal
    private DailyTask? ReschedulingTask { get; set; }
    private DateTime RescheduleTargetDate { get; set; } = DateTime.Now.Date.AddDays(1);
    private bool KeepScheduledTime { get; set; } = true;
    private string RescheduleTimePreset { get; set; } = "none";  // morning, afternoon, evening, custom, none
    private string RescheduleCustomTime { get; set; } = "";

    // AI properties
    private bool ShowAiPanel { get; set; } = false;
    private bool IsAiLoading { get; set; } = false;

    // Search properties
    private bool ShowSearchPanel { get; set; } = false;
    private string SearchQuery { get; set; } = "";
    private bool IsSearching { get; set; } = false;
    private TaskSearchResponse? SearchResults { get; set; }

    // Credentials section properties
    private bool ShowCredentialsSection { get; set; } = false;
    private bool ShowCalendarCredentials { get; set; } = false;
    private bool ShowPersonalInfo { get; set; } = false;
    private bool ShowOtherCredentials { get; set; } = false;

    // Profile editing
    private string ProfileDisplayName { get; set; } = "";
    private string ProfileEmail { get; set; } = "";
    private string ProfilePhone { get; set; } = "";
    private string ProfileAddress { get; set; } = "";
    private bool IsSavingProfile { get; set; } = false;
    private string ProfileMessage { get; set; } = "";

    // Group properties
    private List<TaskGroup> UserGroups { get; set; } = new();
    private bool ShowGroupModal { get; set; } = false;
    private bool IsCreatingGroup { get; set; } = false;
    private TaskGroup? SelectedGroup { get; set; }
    private List<User> GroupMembers { get; set; } = new();
    private string NewGroupName { get; set; } = "";
    private List<User> AllUsers { get; set; } = new();
    private int SelectedUserIdToAdd { get; set; } = 0;

    // Participants modal
    private DailyTask? ParticipantsTask { get; set; }
    private List<Participant> RecentParticipants { get; set; } = new();
    private string NewParticipantName { get; set; } = "";
    private string NewParticipantEmail { get; set; } = "";
    private string NewParticipantPhone { get; set; } = "";
    private string ParticipantsMessage { get; set; } = "";
    private bool IsSendingNotifications { get; set; } = false;
    private bool NotificationServiceAvailable { get; set; } = false;

    // Share task modal
    private DailyTask? ShareTask { get; set; }
    private int SelectedShareGroupId { get; set; } = 0;

    // Appointment Detail Panel (double-click on scheduled task)
    private DailyTask? AppointmentDetailTask { get; set; }
    private string AppointmentTitle { get; set; } = "";
    private string AppointmentDescription { get; set; } = "";
    private string AppointmentTimeValue { get; set; } = "";
    private int AppointmentDuration { get; set; } = 30;
    private bool IsSavingAppointment { get; set; } = false;
    private RecurrenceType AppointmentRecurrence { get; set; } = RecurrenceType.None;
    private int AppointmentRecurrenceInterval { get; set; } = 1;
    private List<string> AppointmentRecurrenceDays { get; set; } = new();
    private DateTime? AppointmentRecurrenceEndDate { get; set; }
    private bool HasRecurrenceEndDate { get; set; } = false;

    // Recurring delete dialog
    private bool ShowRecurringDeleteDialog { get; set; } = false;
    private DailyTask? DeletingRecurringTask { get; set; }
    private List<DailyTask> RecurringInstances { get; set; } = new();
    private HashSet<int> SelectedInstancesForDeletion { get; set; } = new();
    private string RecurringDeleteMode { get; set; } = "this"; // "this", "all", "select"

    // Insight History
    private bool ShowInsightHistory { get; set; } = false;
    private List<InsightHistory> InsightHistoryList { get; set; } = new();
    private InsightHistory? SelectedHistoryInsight { get; set; }
    private string ShareMessage { get; set; } = "";

    // Drag and drop
    private int? DraggingTaskId { get; set; }
    private int? DraggingScheduledTaskId { get; set; } // For dragging within schedule panel
    private int? DragOverHour { get; set; }
    private TimeSpan? DragOverSlot { get; set; }

    // Panel resize state
    private int SchedulePanelWidth { get; set; } = 0; // 0 means use default CSS width
    private bool IsResizingPanels { get; set; } = false;
    private double ResizeStartX { get; set; } = 0;

    // Task Actions (Agentic AI)
    private Dictionary<int, TaskAction?> TaskActions { get; set; } = new();
    private bool IsOllamaAvailable { get; set; } = false;
    private string AiSummary { get; set; } = "";
    private List<string> AiSuggestions { get; set; } = new();
    private List<PrioritizedTask> PrioritizedTasks { get; set; } = new();
    private List<ScheduleAdviceItem> ScheduleAdvice { get; set; } = new();
    private List<TimeGap> TimeGaps { get; set; } = new();

    // Schedule advice helper classes
    private class ScheduleAdviceItem
    {
        public string Type { get; set; } = "info"; // warning, conflict, suggestion, info
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string? ActionLabel { get; set; }
        public int? TaskId { get; set; }
        public TimeSpan? SuggestedTime { get; set; }
    }

    private class TimeGap
    {
        public TimeSpan Start { get; set; }
        public TimeSpan End { get; set; }
        public int DurationMinutes => (int)(End - Start).TotalMinutes;
    }

    // Settings & Auth
    private int CurrentUserId { get; set; } = 0;
    private string CurrentUsername { get; set; } = "";
    private bool SettingsLoaded { get; set; } = false;
    private bool UseLargeText { get; set; } = false;
    private bool HighContrastMode { get; set; } = false;
    private int WorkingHoursStart { get; set; } = 6;  // 6 AM
    private int WorkingHoursEnd { get; set; } = 20;   // 8 PM

    // Task Templates
    private List<TaskTemplate> TaskTemplates { get; set; } = new();
    private bool ShowTemplateDropdown { get; set; } = false;
    private bool ShowTemplateManager { get; set; } = false;
    private TaskTemplate? EditingTemplate { get; set; } = null;
    private string NewTemplateName { get; set; } = "";
    private string NewTemplateDescription { get; set; } = "";
    private string NewSubtaskTitle { get; set; } = "";

    // External Calendars
    private bool IsGoogleConnected { get; set; } = false;
    private bool IsMicrosoftConnected { get; set; } = false;
    private bool IsImporting { get; set; } = false;
    private string ImportMessage { get; set; } = "";
    private CalendarSource ActiveCalendarTab { get; set; } = CalendarSource.Integrated;
    private List<ExternalCalendarEvent> ExternalEvents { get; set; } = new();
    private bool IsLoadingExternalEvents { get; set; } = false;
    private int GoogleEventCount { get; set; } = 0;
    private int MicrosoftEventCount { get; set; } = 0;
    private int TotalTaskCount => Tasks.Count + WeeklyTasks.Count;

    // Calendar services (created dynamically from stored credentials)
    private IGoogleCalendarService? GoogleCalendarService { get; set; }
    private MicrosoftCalendarService? MicrosoftCalendarService { get; set; }
    private ICalendarSyncService? CalendarSyncService { get; set; }

    // Credentials info
    private bool HasGoogleCredentials { get; set; } = false;
    private bool HasMicrosoftCredentials { get; set; } = false;

    protected override void OnInitialized()
    {
        BuildCalendar();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Get the actual local date from browser (handles timezone correctly)
            try
            {
                var localDateStr = await JSRuntime.InvokeAsync<string>("eval", "new Date().toLocaleDateString('en-CA')");
                if (DateTime.TryParse(localDateStr, out var localDate))
                {
                    LocalToday = localDate;
                    // Only update if we haven't navigated away from today
                    if (_selectedDate.Date == DateTime.Today.Date || _selectedDate.Date == DateTime.UtcNow.Date)
                    {
                        _selectedDate = localDate;
                        CurrentMonth = localDate;
                    }
                }
            }
            catch { /* Fall back to server time */ }

            // Register global ESC key handler
            _dotNetRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("registerEscHandler", _dotNetRef);

            await CheckAuthAndLoadAsync();
        }
    }

    private async Task CheckAuthAndLoadAsync()
    {
        try
        {
            // Check if user is logged in
            var userIdStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "pfd_user_id");
            if (string.IsNullOrEmpty(userIdStr) || !int.TryParse(userIdStr, out var userId))
            {
                Navigation.NavigateTo("/login");
                return;
            }

            var user = await AuthService.GetUserByIdAsync(userId);
            if (user == null)
            {
                await Logout();
                return;
            }

            CurrentUserId = user.Id;
            CurrentUsername = user.DisplayName ?? user.Username;
            CurrentTheme = user.Theme;
            IsDailyView = user.IsDailyView;
            UseLargeText = user.UseLargeText;

            // Load high contrast from localStorage
            try
            {
                HighContrastMode = await JSRuntime.InvokeAsync<bool>("settingsInterop.getHighContrast");
            }
            catch { HighContrastMode = false; }

            SettingsLoaded = true;

            // Load calendar credentials and create services dynamically
            await LoadCalendarServicesFromCredentialsAsync();

            // Check external calendar connections
            if (GoogleCalendarService != null)
            {
                IsGoogleConnected = await GoogleCalendarService.IsConnectedAsync(CurrentUserId);
            }
            if (MicrosoftCalendarService != null)
            {
                IsMicrosoftConnected = await MicrosoftCalendarService.IsConnectedAsync(CurrentUserId);
            }

            // Load event counts for tabs
            await LoadExternalEventCounts();

            // Load user groups
            await LoadUserGroupsAsync();

            // Load task templates
            await LoadTaskTemplatesAsync();

            // Check if Ollama is available for task actions
            await CheckOllamaAvailability();

            // Check if notification service is available
            await CheckNotificationServiceAvailability();

            // Auto kick-forward in-progress tasks from past days to today
            var kickedCount = await TaskService.KickForwardInProgressTasksAsync(CurrentUserId);
            if (kickedCount > 0)
            {
                Console.WriteLine($"Kicked forward {kickedCount} in-progress tasks to today");
            }

            await LoadTasksAsync();

            // Parse task actions in background if Ollama available
            if (IsOllamaAvailable)
            {
                _ = ParseTaskActionsAsync();
            }

            StateHasChanged();
        }
        catch (Exception)
        {
            Navigation.NavigateTo("/login");
        }
    }

    private async Task LoadCalendarServicesFromCredentialsAsync()
    {
        try
        {
            // Load Google credentials
            var googleCreds = await CredentialsService.GetCredentialsAsync(CurrentUserId, "Google");
            if (googleCreds != null && !string.IsNullOrEmpty(googleCreds.ClientId) && !string.IsNullOrEmpty(googleCreds.ClientSecret))
            {
                HasGoogleCredentials = true;
                GoogleCalendarService = new GoogleCalendarService(
                    TaskService,
                    googleCreds.ClientId,
                    googleCreds.ClientSecret,
                    googleCreds.RedirectUri ?? "https://localhost:5001/auth/google/callback"
                );
            }

            // Load Microsoft credentials
            var msCreds = await CredentialsService.GetCredentialsAsync(CurrentUserId, "Microsoft");
            if (msCreds != null && !string.IsNullOrEmpty(msCreds.ClientId) && !string.IsNullOrEmpty(msCreds.ClientSecret))
            {
                HasMicrosoftCredentials = true;
                MicrosoftCalendarService = new MicrosoftCalendarService(
                    msCreds.ClientId,
                    msCreds.ClientSecret,
                    msCreds.TenantId ?? "common",
                    msCreds.RedirectUri ?? "https://localhost:5001/auth/microsoft/callback"
                );
            }

            // Create CalendarSyncService if any calendar is configured
            if (GoogleCalendarService != null || MicrosoftCalendarService != null)
            {
                var syncService = new CalendarSyncService(TaskService);
                if (GoogleCalendarService is IExternalCalendarService googleExtSvc)
                {
                    syncService.RegisterCalendarService(googleExtSvc);
                }
                if (MicrosoftCalendarService != null)
                {
                    syncService.RegisterCalendarService(MicrosoftCalendarService);
                }
                CalendarSyncService = syncService;
            }
        }
        catch (Exception ex)
        {
            ImportMessage = $"Error loading calendar credentials: {ex.Message}";
        }
    }

    private async Task Logout()
    {
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "pfd_user_id");
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "pfd_username");
        Navigation.NavigateTo("/login");
    }

    private void GoToSettings()
    {
        Navigation.NavigateTo("/settings");
    }


    private void BuildCalendar()
    {
        CalendarDays.Clear();
        var firstOfMonth = new DateTime(CurrentMonth.Year, CurrentMonth.Month, 1);
        var lastOfMonth = firstOfMonth.AddMonths(1).AddDays(-1);
        int startDayOfWeek = (int)firstOfMonth.DayOfWeek;

        // Previous month days
        var prevMonth = firstOfMonth.AddDays(-startDayOfWeek);
        for (int i = 0; i < startDayOfWeek; i++)
        {
            CalendarDays.Add(new CalendarDay { Date = prevMonth.AddDays(i), IsCurrentMonth = false });
        }

        // Current month days
        for (int day = 1; day <= lastOfMonth.Day; day++)
        {
            CalendarDays.Add(new CalendarDay { Date = new DateTime(CurrentMonth.Year, CurrentMonth.Month, day), IsCurrentMonth = true });
        }

        // Next month days
        int remainingDays = 42 - CalendarDays.Count;
        var nextMonth = lastOfMonth.AddDays(1);
        for (int i = 0; i < remainingDays; i++)
        {
            CalendarDays.Add(new CalendarDay { Date = nextMonth.AddDays(i), IsCurrentMonth = false });
        }

        // Load task counts asynchronously
        _ = LoadCalendarTaskCountsAsync();
    }

    private async Task LoadCalendarTaskCountsAsync()
    {
        if (CurrentUserId == 0 || !CalendarDays.Any()) return;

        try
        {
            var startDate = CalendarDays.First().Date;
            var endDate = CalendarDays.Last().Date;
            var tasks = await TaskService.GetTasksForDateRangeAsync(startDate, endDate, CurrentUserId);

            foreach (var day in CalendarDays)
            {
                day.TaskCount = tasks.Count(t => t.TaskDate.Date == day.Date.Date && !t.IsCompleted);
            }
            StateHasChanged();
        }
        catch
        {
            // Silently ignore errors loading task counts
        }
    }

    private async Task LoadTasksAsync()
    {
        if (CurrentUserId == 0) return;
        if (_isLoadingTasks) return; // Prevent concurrent calls

        _isLoadingTasks = true;
        try
        {
            // Always load overdue tasks - they should be visible regardless of selected date
            // The Waiting tab shows tasks that are past due and need attention
            OverdueTasks = await TaskService.GetOverdueTasksAsync(LocalToday, CurrentUserId);

            // Always load all unscheduled tasks - they show in the Tasks tab regardless of selected date
            AllUnscheduledTasks = await TaskService.GetUnscheduledTasksAsync(CurrentUserId);

            if (IsDailyView)
            {
                Tasks = await TaskService.GetTasksForDateAsync(SelectedDate, CurrentUserId);
                WeeklyTasks.Clear();
            }
            else
            {
                var dayOfWeek = (int)SelectedDate.DayOfWeek;
                var daysToMonday = dayOfWeek == 0 ? 6 : dayOfWeek - 1;
                var startOfWeek = SelectedDate.AddDays(-daysToMonday);
                WeeklyTasks = await TaskService.GetTasksForDateRangeAsync(startOfWeek, startOfWeek.AddDays(4), CurrentUserId);
                Tasks.Clear();
            }
            // Update calendar badge for selected date
            var calendarDay = CalendarDays.FirstOrDefault(d => d.Date.Date == SelectedDate.Date);
            if (calendarDay != null)
            {
                calendarDay.TaskCount = Tasks.Count(t => !t.IsCompleted);
            }
            StateHasChanged();
        }
        finally
        {
            _isLoadingTasks = false;
        }
    }

    private void SelectDate(DateTime date)
    {
        SelectedDate = date;
        if (date.Month != CurrentMonth.Month || date.Year != CurrentMonth.Year)
        {
            CurrentMonth = new DateTime(date.Year, date.Month, 1);
            BuildCalendar();
        }
    }

    private void PreviousMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
        BuildCalendar();
    }

    private void NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
        BuildCalendar();
    }

    private async Task SetView(bool daily)
    {
        IsDailyView = daily;
        await LoadTasksAsync();
        await SaveSettingsAsync();
    }

    private string GetHeaderText()
    {
        if (IsDailyView)
        {
            return SelectedDate.Date == LocalToday
                ? $"TODAY - {SelectedDate:dddd, MMMM d, yyyy}"
                : SelectedDate.ToString("dddd, MMMM d, yyyy");
        }
        else
        {
            var dayOfWeek = (int)SelectedDate.DayOfWeek;
            var daysToMonday = dayOfWeek == 0 ? 6 : dayOfWeek - 1;
            var startOfWeek = SelectedDate.AddDays(-daysToMonday);
            var endOfWeek = startOfWeek.AddDays(4);
            return $"WEEK: {startOfWeek:MMM d} - {endOfWeek:MMM d, yyyy}";
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddTask();
        }
    }

    private async Task AddTask()
    {
        if (string.IsNullOrWhiteSpace(NewTaskText) || CurrentUserId == 0) return;

        // Don't allow adding tasks to past days - use today instead
        var taskDate = SelectedDate.Date < LocalToday ? LocalToday : SelectedDate;

        // Parse time and recurrence from task text (e.g., "teach 333 MW 3:00 pm till May 1")
        var parseResult = TaskTimeParser.ParseWithRecurrence(NewTaskText);

        var task = new DailyTask
        {
            Title = parseResult.CleanedTitle,
            TaskDate = taskDate,
            IsCompleted = false,
            SortOrder = Tasks.Count,
            IsAllDay = true,
            UserId = CurrentUserId,
            RecurrenceType = parseResult.RecurrenceType,
            RecurrenceInterval = 1,
            RecurrenceDays = parseResult.RecurrenceDays != null ? string.Join(",", parseResult.RecurrenceDays) : null,
            RecurrenceEndDate = parseResult.RecurrenceEndDate
        };

        // Priority 1: Use manually entered time from time input field
        if (!string.IsNullOrWhiteSpace(NewTaskTimeText) && TimeSpan.TryParse(NewTaskTimeText, out var manualTime))
        {
            task.ScheduledTime = manualTime;
            task.IsAllDay = false;
        }
        // Priority 2: Use parsed time from task text
        else if (parseResult.ScheduledTime.HasValue)
        {
            task.ScheduledTime = parseResult.ScheduledTime.Value;
            task.IsAllDay = false;
        }

        await TaskService.CreateTaskAsync(task);

        // Generate recurring instances if recurrence is set
        if (parseResult.RecurrenceType != RecurrenceType.None)
        {
            await GenerateRecurringInstances(task);
        }

        NewTaskText = "";
        NewTaskTimeText = "";
        await LoadTasksAsync();
    }

    private async Task ToggleStarted(DailyTask task)
    {
        await TaskService.ToggleStartedAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task ToggleTask(DailyTask task)
    {
        await TaskService.ToggleCompletionAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task DeleteTask(DailyTask task)
    {
        await TaskService.DeleteTaskAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task ToggleStartedWeekly(DailyTask task)
    {
        await TaskService.ToggleStartedAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task ToggleWeeklyTask(DailyTask task)
    {
        await TaskService.ToggleCompletionAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task DeleteWeeklyTask(DailyTask task)
    {
        await TaskService.DeleteTaskAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task ToggleStartedOverdue(DailyTask task)
    {
        await TaskService.ToggleStartedAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task ToggleOverdueTask(DailyTask task)
    {
        await TaskService.ToggleCompletionAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task DeleteOverdueTask(DailyTask task)
    {
        await TaskService.DeleteTaskAsync(task.Id, CurrentUserId);
        await LoadTasksAsync();
    }

    private async Task MoveToToday(DailyTask task)
    {
        await TaskService.RescheduleTaskAsync(task.Id, LocalToday, CurrentUserId);
        await LoadTasksAsync();
    }

    private bool IsTaskInPast(DailyTask task)
    {
        return task.TaskDate.Date < LocalToday;
    }

    private void StartEditTask(DailyTask task)
    {
        // Don't allow editing past tasks
        if (IsTaskInPast(task)) return;

        EditingTaskId = task.Id;
        EditingTaskText = task.Title;
        EditingTask = task;
    }

    private void StartEditWeeklyTask(DailyTask task)
    {
        // Don't allow editing past tasks
        if (IsTaskInPast(task)) return;

        EditingTaskId = task.Id;
        EditingTaskText = task.Title;
        EditingTask = task;
    }

    private void SelectTaskFromSchedule(DailyTask task)
    {
        // Toggle selection - if already selected, deselect
        if (SelectedScheduleTaskId == task.Id)
        {
            SelectedScheduleTaskId = null;
        }
        else
        {
            SelectedScheduleTaskId = task.Id;
        }
    }

    private void ClearScheduleSelection()
    {
        SelectedScheduleTaskId = null;
        StateHasChanged();
    }

    private async Task SaveTaskEdit()
    {
        if (EditingTask != null && !string.IsNullOrWhiteSpace(EditingTaskText))
        {
            EditingTask.Title = EditingTaskText;
            await TaskService.UpdateTaskAsync(EditingTask);
            await LoadTasksAsync();
        }
        EditingTaskId = null;
        EditingTask = null;
    }

    private async Task SaveWeeklyTaskEdit()
    {
        await SaveTaskEdit();
    }

    private async Task HandleEditKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SaveTaskEdit();
        }
        else if (e.Key == "Escape")
        {
            EditingTaskId = null;
            EditingTask = null;
        }
    }

    private void HandleGlobalKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            HandleEscapeKey();
        }
    }

    [JSInvokable]
    public void HandleEscapeKeyJS()
    {
        HandleEscapeKey();
    }

    private void HandleEscapeKey()
    {
        // Clear schedule selection
        SelectedScheduleTaskId = null;
        // Close any open modals
        if (AppointmentDetailTask != null)
        {
            CloseAppointmentDetail();
        }
        // Close recurring delete dialog
        if (ShowRecurringDeleteDialog)
        {
            CloseRecurringDeleteDialog();
        }
        StateHasChanged();
    }

    private async Task HandleWeeklyEditKeyDown(KeyboardEventArgs e)
    {
        await HandleEditKeyDown(e);
    }

    private async Task ChangeTheme(ChangeEventArgs e)
    {
        CurrentTheme = e.Value?.ToString() ?? "teal";
        await SaveSettingsAsync();
    }

    private async Task SaveSettingsAsync()
    {
        if (!SettingsLoaded || CurrentUserId == 0) return;

        try
        {
            // Save to user profile in database
            await AuthService.UpdateUserSettingsAsync(CurrentUserId, CurrentTheme, IsDailyView, UseLargeText);
        }
        catch (Exception)
        {
            // Silently fail
        }
    }

    private async Task SetLargeText(bool useLargeText)
    {
        UseLargeText = useLargeText;
        await SaveSettingsAsync();
    }

    private void ToggleAiPanel()
    {
        ShowAiPanel = !ShowAiPanel;
        if (ShowAiPanel)
        {
            _ = LoadAiInsightsAsync();
        }
    }

    // Search methods
    private void ToggleSearchPanel()
    {
        ShowSearchPanel = !ShowSearchPanel;
        if (ShowSearchPanel)
        {
            SearchResults = null;
            SearchQuery = "";
        }
    }

    private void CloseSearchPanel()
    {
        ShowSearchPanel = false;
        SearchResults = null;
        SearchQuery = "";
    }

    private async Task HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ExecuteSearch();
        }
        else if (e.Key == "Escape")
        {
            CloseSearchPanel();
        }
    }

    private async Task ExecuteSearch()
    {
        if (string.IsNullOrWhiteSpace(SearchQuery) || IsSearching || CurrentUserId == 0) return;

        try
        {
            IsSearching = true;
            StateHasChanged();

            // Get all tasks for the user
            var allTasks = await TaskService.SearchAllTasksAsync(CurrentUserId, 500);

            if (!allTasks.Any())
            {
                SearchResults = new TaskSearchResponse
                {
                    Summary = "No tasks found in database to search.",
                    Results = new List<TaskSearchResult>(),
                    TotalSearched = 0
                };
                return;
            }

            // Use Claude to search
            SearchResults = await ClaudeService.SearchTasksAsync(SearchQuery, allTasks);

            // If no results and no summary, provide feedback
            if (string.IsNullOrEmpty(SearchResults.Summary))
            {
                SearchResults.Summary = $"Searched {allTasks.Count} tasks for \"{SearchQuery}\"";
            }
        }
        catch (Exception ex)
        {
            SearchResults = new TaskSearchResponse
            {
                Summary = $"Search error: {ex.Message}",
                Results = new List<TaskSearchResult>()
            };
        }
        finally
        {
            IsSearching = false;
            StateHasChanged();
        }
    }

    private void NavigateToTask(DailyTask task)
    {
        // Navigate to the task's date
        SelectedDate = task.TaskDate;
        CurrentMonth = new DateTime(task.TaskDate.Year, task.TaskDate.Month, 1);
        CloseSearchPanel();
        BuildCalendar();
    }

    // Credentials section toggles
    private void ToggleCredentialsSection()
    {
        ShowCredentialsSection = !ShowCredentialsSection;
        if (!ShowCredentialsSection)
        {
            ShowCalendarCredentials = false;
            ShowPersonalInfo = false;
            ShowOtherCredentials = false;
        }
    }

    private void ToggleCalendarCredentials()
    {
        ShowCalendarCredentials = !ShowCalendarCredentials;
    }

    private async Task TogglePersonalInfo()
    {
        ShowPersonalInfo = !ShowPersonalInfo;
        if (ShowPersonalInfo)
        {
            // Load current profile data
            var user = await AuthService.GetUserByIdAsync(CurrentUserId);
            if (user != null)
            {
                ProfileDisplayName = user.DisplayName ?? user.Username;
                ProfileEmail = user.Email ?? "";
                ProfilePhone = user.Phone ?? "";
                ProfileAddress = user.Address ?? "";
            }
            ProfileMessage = "";
        }
    }

    private void ToggleOtherCredentials()
    {
        ShowOtherCredentials = !ShowOtherCredentials;
    }

    private async Task SaveProfile()
    {
        if (IsSavingProfile) return;

        IsSavingProfile = true;
        ProfileMessage = "";
        StateHasChanged();

        try
        {
            await AuthService.UpdateUserProfileAsync(
                CurrentUserId,
                string.IsNullOrWhiteSpace(ProfileEmail) ? null : ProfileEmail.Trim(),
                string.IsNullOrWhiteSpace(ProfilePhone) ? null : ProfilePhone.Trim(),
                string.IsNullOrWhiteSpace(ProfileAddress) ? null : ProfileAddress.Trim(),
                string.IsNullOrWhiteSpace(ProfileDisplayName) ? null : ProfileDisplayName.Trim()
            );

            // Update displayed username if changed
            if (!string.IsNullOrWhiteSpace(ProfileDisplayName))
            {
                CurrentUsername = ProfileDisplayName.Trim();
            }

            ProfileMessage = "Saved!";
        }
        catch (Exception ex)
        {
            ProfileMessage = $"Error: {ex.Message}";
        }
        finally
        {
            IsSavingProfile = false;
            StateHasChanged();
        }
    }

    // Select date from day roller click
    private async Task SelectDateFromRoller(DateTime date)
    {
        // Only select if it wasn't a drag
        if (totalDragDistance < 10)
        {
            SelectedDate = date;
            await LoadTasksAsync();
        }
    }

    // Simple day navigation
    private async Task PrevDay()
    {
        SelectedDate = SelectedDate.AddDays(-1);
        await LoadTasksAsync();
    }

    private async Task NextDay()
    {
        SelectedDate = SelectedDate.AddDays(1);
        await LoadTasksAsync();
    }

    private async Task GoToToday()
    {
        SelectedDate = LocalToday;
        await LoadTasksAsync();
    }

    // Day roller drag handlers
    private void OnRollerMouseDown(MouseEventArgs e)
    {
        isDragging = true;
        dragStartY = e.ClientY;
        totalDragDistance = 0;
    }

    private async Task OnRollerMouseMove(MouseEventArgs e)
    {
        if (!isDragging) return;

        var delta = e.ClientY - dragStartY;
        totalDragDistance += Math.Abs(delta);
        rollerOffset += delta;
        dragStartY = e.ClientY;

        // Check if we've dragged enough to change day
        if (Math.Abs(rollerOffset) >= SlotHeight)
        {
            var dayChange = rollerOffset > 0 ? -1 : 1;
            SelectedDate = SelectedDate.AddDays(dayChange);
            rollerOffset = 0;
            await LoadTasksAsync();
        }

        StateHasChanged();
    }

    private void OnRollerMouseUp(MouseEventArgs e)
    {
        isDragging = false;
        rollerOffset = 0;
        StateHasChanged();
    }

    private void OnRollerTouchStart(TouchEventArgs e)
    {
        if (e.Touches.Length > 0)
        {
            isDragging = true;
            dragStartY = e.Touches[0].ClientY;
            totalDragDistance = 0;
        }
    }

    private async Task OnRollerTouchMove(TouchEventArgs e)
    {
        if (!isDragging || e.Touches.Length == 0) return;

        var delta = e.Touches[0].ClientY - dragStartY;
        totalDragDistance += Math.Abs(delta);
        rollerOffset += delta;
        dragStartY = e.Touches[0].ClientY;

        if (Math.Abs(rollerOffset) >= SlotHeight)
        {
            var dayChange = rollerOffset > 0 ? -1 : 1;
            SelectedDate = SelectedDate.AddDays(dayChange);
            rollerOffset = 0;
            await LoadTasksAsync();
        }

        StateHasChanged();
    }

    private void OnRollerTouchEnd(TouchEventArgs e)
    {
        isDragging = false;
        rollerOffset = 0;
        StateHasChanged();
    }

    private async Task OnRollerWheel(WheelEventArgs e)
    {
        // Scroll wheel changes days
        var dayChange = e.DeltaY > 0 ? 1 : -1;
        SelectedDate = SelectedDate.AddDays(dayChange);
        await LoadTasksAsync();
    }

    private async Task OnTimeRollerScroll()
    {
        if (isSyncingScroll) return;
        isSyncingScroll = true;
        await JSRuntime.InvokeVoidAsync("syncScroll", timeRollerRef, syncedTasksRef);
        isSyncingScroll = false;
    }

    private async Task OnSyncedTasksScroll()
    {
        if (isSyncingScroll) return;
        isSyncingScroll = true;
        await JSRuntime.InvokeVoidAsync("syncScroll", syncedTasksRef, timeRollerRef);
        isSyncingScroll = false;
    }

    private async Task ScrollToNow()
    {
        var currentHour = DateTime.Now.Hour;
        await JSRuntime.InvokeVoidAsync("scrollToHour", timeRollerRef, syncedTasksRef, currentHour);
    }

    private async Task ScrollToHour(int hour)
    {
        await JSRuntime.InvokeVoidAsync("scrollToHour", timeRollerRef, syncedTasksRef, hour);
    }


    private int GetTaskCountForDate(DateTime date)
    {
        // This is a simplified count - could be enhanced to query actual data
        if (date.Date == SelectedDate.Date)
        {
            return Tasks.Count;
        }
        return 0; // Would need to load from DB for other dates
    }

    private string FormatHour(int hour)
    {
        if (hour == 0) return "12a";
        if (hour < 12) return $"{hour}a";
        if (hour == 12) return "12p";
        return $"{hour - 12}p";
    }

    private async Task RefreshAiInsights()
    {
        await LoadAiInsightsAsync();
    }

    private async Task LoadAiInsightsAsync()
    {
        if (!await AnalysisService.IsAvailableAsync())
        {
            AiSummary = "AI service unavailable. Start Ollama to enable AI features.";
            StateHasChanged();
            return;
        }

        IsAiLoading = true;
        StateHasChanged();

        try
        {
            var recentTasks = await TaskService.GetRecentTasksAsync(CurrentUserId, 30);
            var overdueTasks = await TaskService.GetOverdueTasksAsync(LocalToday, CurrentUserId);
            var todayTasks = Tasks.ToList();

            // Get insights with history tracking (uses raw data comparison, not AI-on-AI)
            var insights = await AnalysisService.GetInsightsAsync(recentTasks, CurrentUserId);
            AiSummary = insights.ProductivitySummary;
            AiSuggestions = insights.Suggestions;

            // Load insight history for display
            await LoadInsightHistoryAsync();

            // Get prioritization
            if (todayTasks.Any() || overdueTasks.Any())
            {
                var prioritization = await AnalysisService.GetPrioritizedTasksAsync(todayTasks, overdueTasks);

                PrioritizedTasks.Clear();
                foreach (var taskId in prioritization.PriorityOrder)
                {
                    var task = todayTasks.FirstOrDefault(t => t.Id == taskId)
                            ?? overdueTasks.FirstOrDefault(t => t.Id == taskId);
                    if (task != null)
                    {
                        PrioritizedTasks.Add(new PrioritizedTask
                        {
                            Task = task,
                            PriorityScore = prioritization.PriorityScores.GetValueOrDefault(taskId, 50),
                            Reasoning = prioritization.Reasoning.GetValueOrDefault(taskId, "")
                        });
                    }
                }
            }

            // Analyze schedule for advice
            AnalyzeSchedule(todayTasks, overdueTasks);
        }
        catch (Exception ex)
        {
            AiSummary = $"Error loading insights: {ex.Message}";
        }
        finally
        {
            IsAiLoading = false;
            StateHasChanged();
        }
    }

    private string GetPriorityLabel(int score) => score switch
    {
        >= 90 => "Critical",
        >= 70 => "High",
        >= 50 => "Medium",
        _ => "Low"
    };

    private string GetPriorityClass(int score) => score switch
    {
        >= 90 => "critical",
        >= 70 => "high",
        >= 50 => "medium",
        _ => "low"
    };

    // Insight History Methods
    private async Task LoadInsightHistoryAsync()
    {
        try
        {
            InsightHistoryList = await InsightHistoryService.GetInsightHistoryAsync(CurrentUserId, "weekly", limit: 10);
        }
        catch
        {
            InsightHistoryList = new();
        }
    }

    private void ToggleInsightHistory()
    {
        ShowInsightHistory = !ShowInsightHistory;
        if (ShowInsightHistory && !InsightHistoryList.Any())
        {
            _ = LoadInsightHistoryAsync();
        }
    }

    private void SelectHistoryInsight(InsightHistory insight)
    {
        SelectedHistoryInsight = SelectedHistoryInsight == insight ? null : insight;
    }

    private string GetSnapshotCompletionRate(InsightHistory insight)
    {
        var snapshot = GetSnapshot(insight);
        return snapshot?.CompletionRate.ToString("F0") ?? "?";
    }

    private string GetTrendIndicator(InsightHistory insight)
    {
        var snapshot = GetSnapshot(insight);
        if (snapshot?.TrendDirection == null) return "-";
        return snapshot.TrendDirection switch
        {
            "improving" => "&#9650;", // up arrow
            "declining" => "&#9660;", // down arrow
            _ => "&#8212;" // dash
        };
    }

    private TaskDataSnapshot? GetSnapshot(InsightHistory insight)
    {
        if (string.IsNullOrEmpty(insight.RawDataSnapshot))
            return null;
        try
        {
            return System.Text.Json.JsonSerializer.Deserialize<TaskDataSnapshot>(insight.RawDataSnapshot,
                new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
        }
        catch
        {
            return null;
        }
    }

    // Schedule analysis methods
    private void AnalyzeSchedule(List<DailyTask> todayTasks, List<DailyTask> overdueTasks)
    {
        ScheduleAdvice.Clear();
        TimeGaps.Clear();

        var scheduledTasks = todayTasks
            .Where(t => t.ScheduledTime.HasValue && !t.IsCompleted)
            .OrderBy(t => t.ScheduledTime)
            .ToList();

        var unscheduledTasks = todayTasks.Where(t => !t.ScheduledTime.HasValue && !t.IsCompleted).ToList();

        // Check for overdue tasks
        if (overdueTasks.Any())
        {
            ScheduleAdvice.Add(new ScheduleAdviceItem
            {
                Type = "warning",
                Title = $"{overdueTasks.Count} Overdue Task{(overdueTasks.Count > 1 ? "s" : "")}",
                Description = "You have tasks from previous days that need attention. Consider rescheduling or completing them today.",
                ActionLabel = "View Waiting"
            });
        }

        // Check for time conflicts
        for (int i = 0; i < scheduledTasks.Count - 1; i++)
        {
            var current = scheduledTasks[i];
            var next = scheduledTasks[i + 1];
            var currentEnd = current.ScheduledTime!.Value.Add(TimeSpan.FromMinutes(current.DurationMinutes));

            if (currentEnd > next.ScheduledTime!.Value)
            {
                ScheduleAdvice.Add(new ScheduleAdviceItem
                {
                    Type = "conflict",
                    Title = "Time Conflict",
                    Description = $"'{current.Title}' overlaps with '{next.Title}'. Consider adjusting times.",
                    TaskId = next.Id,
                    SuggestedTime = currentEnd.Add(TimeSpan.FromMinutes(5))
                });
            }
        }

        // Find time gaps for potential scheduling
        var workStart = TimeSpan.FromHours(8);
        var workEnd = TimeSpan.FromHours(18);
        var currentTime = DateTime.Now.TimeOfDay;

        if (SelectedDate.Date == LocalToday && currentTime > workStart)
        {
            workStart = TimeSpan.FromMinutes(Math.Ceiling(currentTime.TotalMinutes / 15) * 15); // Round up to next 15 min
        }

        var checkpoints = new List<TimeSpan> { workStart };
        foreach (var task in scheduledTasks.Where(t => t.ScheduledTime >= workStart))
        {
            checkpoints.Add(task.ScheduledTime!.Value);
            checkpoints.Add(task.ScheduledTime!.Value.Add(TimeSpan.FromMinutes(task.DurationMinutes)));
        }
        checkpoints.Add(workEnd);
        checkpoints = checkpoints.Distinct().OrderBy(t => t).ToList();

        for (int i = 0; i < checkpoints.Count - 1; i++)
        {
            var gapStart = checkpoints[i];
            var gapEnd = checkpoints[i + 1];
            var gapMinutes = (int)(gapEnd - gapStart).TotalMinutes;

            // Is this gap free (no task starts here)?
            var taskAtTime = scheduledTasks.FirstOrDefault(t =>
                t.ScheduledTime >= gapStart && t.ScheduledTime < gapEnd);

            if (taskAtTime == null && gapMinutes >= 30)
            {
                TimeGaps.Add(new TimeGap { Start = gapStart, End = gapEnd });
            }
        }

        // Suggest scheduling unscheduled tasks
        if (unscheduledTasks.Any() && TimeGaps.Any())
        {
            var largestGap = TimeGaps.OrderByDescending(g => g.DurationMinutes).First();
            var taskToSchedule = unscheduledTasks.First();

            ScheduleAdvice.Add(new ScheduleAdviceItem
            {
                Type = "suggestion",
                Title = "Schedule a Task",
                Description = $"'{taskToSchedule.Title}' could fit in the {FormatTime(largestGap.Start)} - {FormatTime(largestGap.End)} slot.",
                ActionLabel = "Schedule Now",
                TaskId = taskToSchedule.Id,
                SuggestedTime = largestGap.Start
            });
        }

        // Check for heavy workload
        var totalScheduledMinutes = scheduledTasks.Sum(t => t.DurationMinutes);
        if (totalScheduledMinutes > 6 * 60) // More than 6 hours scheduled
        {
            ScheduleAdvice.Add(new ScheduleAdviceItem
            {
                Type = "info",
                Title = "Heavy Schedule",
                Description = $"You have {totalScheduledMinutes / 60}h {totalScheduledMinutes % 60}m of meetings/tasks scheduled. Remember to take breaks!"
            });
        }

        // Morning tip
        if (SelectedDate.Date == LocalToday && DateTime.Now.Hour < 10 && scheduledTasks.Any())
        {
            var firstTask = scheduledTasks.First();
            ScheduleAdvice.Add(new ScheduleAdviceItem
            {
                Type = "info",
                Title = "Day Ahead",
                Description = $"Your first scheduled item is '{firstTask.Title}' at {FormatTime(firstTask.ScheduledTime)}."
            });
        }
    }

    private string GetAdviceIcon(string type) => type switch
    {
        "warning" => "‚ö†Ô∏è",
        "conflict" => "üî¥",
        "suggestion" => "üí°",
        "info" => "‚ÑπÔ∏è",
        _ => "üìã"
    };

    private async Task ApplyScheduleAdvice(ScheduleAdviceItem advice)
    {
        if (advice.ActionLabel == "View Waiting")
        {
            SetTaskSection(TaskSection.Waiting);
            return;
        }

        if (advice.TaskId.HasValue && advice.SuggestedTime.HasValue)
        {
            await TaskService.ScheduleTaskTimeAsync(advice.TaskId.Value, advice.SuggestedTime.Value, CurrentUserId);
            await LoadTasksAsync();
            await RefreshAiInsights();
        }
    }

    // Time scheduling methods
    private string FormatTime(TimeSpan? time)
    {
        if (!time.HasValue) return "";
        var dt = DateTime.Today.Add(time.Value);
        return dt.ToString("h:mm tt");
    }

    private void OpenTimeEditor(DailyTask task)
    {
        // Don't allow editing past tasks
        if (IsTaskInPast(task)) return;

        EditingTimeTask = task;
        EditingTimeValue = task.ScheduledTime.HasValue
            ? task.ScheduledTime.Value.ToString(@"hh\:mm")
            : "09:00";
        EditingDuration = task.DurationMinutes > 0 ? task.DurationMinutes : 30;
    }

    private void CloseTimeEditor()
    {
        EditingTimeTask = null;
    }

    private async Task SaveTaskTime()
    {
        if (EditingTimeTask == null) return;

        TimeSpan? time = null;
        if (TimeSpan.TryParse(EditingTimeValue, out var parsed))
        {
            time = parsed;
        }

        await TaskService.ScheduleTaskTimeAsync(EditingTimeTask.Id, time, CurrentUserId, EditingDuration);
        EditingTimeTask = null;
        await LoadTasksAsync();
    }

    private async Task ClearTaskTime(DailyTask task)
    {
        await TaskService.ScheduleTaskTimeAsync(task.Id, null, CurrentUserId, 30);
        await LoadTasksAsync();
    }

    // Drag and drop methods
    private void OnDragStart(DailyTask task)
    {
        DraggingTaskId = task.Id;
        StateHasChanged();
    }

    private void OnDragEnd()
    {
        // Small delay to allow OnDropOnSlot to fire first
        _ = Task.Delay(100).ContinueWith(_ =>
        {
            InvokeAsync(() =>
            {
                DraggingTaskId = null;
                DragOverHour = null;
                DragOverSlot = null;
                StateHasChanged();
            });
        });
    }

    private void OnDragOver(DragEventArgs e, int hour)
    {
        if (DraggingTaskId.HasValue)
        {
            DragOverHour = hour;
            StateHasChanged();
        }
    }

    private void OnDragLeave()
    {
        DragOverHour = null;
        StateHasChanged();
    }

    // New slot-based drag/drop handlers for 20-minute slots
    private void OnDragOverSlot(DragEventArgs e, TimeSpan slot)
    {
        if (DraggingTaskId.HasValue)
        {
            DragOverSlot = slot;
            StateHasChanged();
        }
    }

    private void OnDragLeaveSlot()
    {
        DragOverSlot = null;
        StateHasChanged();
    }

    private async Task OnDropOnSlot(TimeSpan slot)
    {
        if (DraggingTaskId.HasValue)
        {
            // Don't allow scheduling to past days
            if (SelectedDate.Date < LocalToday)
            {
                DraggingTaskId = null;
                DragOverSlot = null;
                return;
            }

            // Don't allow scheduling to past slots on today
            if (SelectedDate.Date == LocalToday && slot < DateTime.Now.TimeOfDay)
            {
                DraggingTaskId = null;
                DragOverSlot = null;
                return;
            }

            var taskId = DraggingTaskId.Value;

            // Check if task is from a different date (overdue or future) - move it to selected date
            var task = Tasks.FirstOrDefault(t => t.Id == taskId) ?? OverdueTasks.FirstOrDefault(t => t.Id == taskId);
            if (task != null && task.TaskDate.Date != SelectedDate.Date)
            {
                // Move task to selected date first
                await TaskService.RescheduleTaskAsync(taskId, SelectedDate, CurrentUserId);
            }

            // Schedule the task at this slot with 20-minute duration
            await TaskService.ScheduleTaskTimeAsync(taskId, slot, CurrentUserId, 20);

            DraggingTaskId = null;
            DragOverSlot = null;

            await LoadTasksAsync();
            await LoadCalendarTaskCountsAsync();
        }
    }

    private async Task OnDropOnHour(int hour)
    {
        if (DraggingTaskId.HasValue)
        {
            // Don't allow scheduling to past days
            if (SelectedDate.Date < LocalToday)
            {
                DraggingTaskId = null;
                DragOverHour = null;
                return;
            }

            // Don't allow scheduling to past hours on today
            if (SelectedDate.Date == LocalToday && hour < DateTime.Now.Hour)
            {
                DraggingTaskId = null;
                DragOverHour = null;
                return;
            }

            var taskId = DraggingTaskId.Value;
            var scheduledTime = new TimeSpan(hour, 0, 0);

            // Check if task is from a different date (overdue or future) - move it to selected date
            var task = Tasks.FirstOrDefault(t => t.Id == taskId) ?? OverdueTasks.FirstOrDefault(t => t.Id == taskId);
            if (task != null && task.TaskDate.Date != SelectedDate.Date)
            {
                // Move task to selected date first
                await TaskService.RescheduleTaskAsync(taskId, SelectedDate, CurrentUserId);
            }

            // Schedule the task at this hour
            await TaskService.ScheduleTaskTimeAsync(taskId, scheduledTime, CurrentUserId, 30);

            DraggingTaskId = null;
            DragOverHour = null;

            await LoadTasksAsync();
            await LoadCalendarTaskCountsAsync();
        }
    }

    // Scheduled task drag (moving within schedule panel)
    private void OnScheduledTaskDragStart(DailyTask task)
    {
        DraggingScheduledTaskId = task.Id;
        DraggingTaskId = task.Id; // Also set this so drop zones highlight
        StateHasChanged();
    }

    private void OnScheduledTaskDragEnd()
    {
        DraggingScheduledTaskId = null;
        DraggingTaskId = null;
        DragOverSlot = null;
        StateHasChanged();
    }

    // Task Template methods
    private async Task LoadTaskTemplatesAsync()
    {
        try
        {
            TaskTemplates = await TaskTemplateService.GetTemplatesAsync(CurrentUserId);
        }
        catch
        {
            TaskTemplates = new List<TaskTemplate>();
        }
    }

    private void ToggleTemplateDropdown()
    {
        ShowTemplateDropdown = !ShowTemplateDropdown;
    }

    private async Task CreateFromTemplate(TaskTemplate template)
    {
        ShowTemplateDropdown = false;

        try
        {
            await TaskTemplateService.CreateTaskFromTemplateAsync(template.Id, CurrentUserId, SelectedDate);
            await LoadTasksAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating task from template: {ex.Message}");
        }
    }

    private void OpenTemplateManager()
    {
        ShowTemplateDropdown = false;
        ShowTemplateManager = true;
        EditingTemplate = null;
        NewTemplateName = "";
        NewTemplateDescription = "";
    }

    private void CloseTemplateManager()
    {
        ShowTemplateManager = false;
        EditingTemplate = null;
    }

    private async Task CreateNewTemplate()
    {
        if (string.IsNullOrWhiteSpace(NewTemplateName)) return;

        try
        {
            var template = await TaskTemplateService.CreateTemplateAsync(
                CurrentUserId, NewTemplateName.Trim(), NewTemplateDescription.Trim());
            TaskTemplates.Add(template);
            EditingTemplate = template;
            NewTemplateName = "";
            NewTemplateDescription = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating template: {ex.Message}");
        }
    }

    private async Task AddSubtaskToTemplate()
    {
        if (EditingTemplate == null || string.IsNullOrWhiteSpace(NewSubtaskTitle)) return;

        try
        {
            var subtask = await TaskTemplateService.AddSubtaskTemplateAsync(
                EditingTemplate.Id, NewSubtaskTitle.Trim());
            EditingTemplate.SubtaskTemplates.Add(subtask);
            NewSubtaskTitle = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding subtask template: {ex.Message}");
        }
    }

    private async Task RemoveSubtaskFromTemplate(SubtaskTemplate subtask)
    {
        if (EditingTemplate == null) return;

        try
        {
            await TaskTemplateService.RemoveSubtaskTemplateAsync(subtask.Id);
            EditingTemplate.SubtaskTemplates.Remove(subtask);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error removing subtask template: {ex.Message}");
        }
    }

    private async Task DeleteTemplate(TaskTemplate template)
    {
        try
        {
            await TaskTemplateService.DeleteTemplateAsync(template.Id);
            TaskTemplates.Remove(template);
            if (EditingTemplate?.Id == template.Id)
            {
                EditingTemplate = null;
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting template: {ex.Message}");
        }
    }

    private void EditTemplate(TaskTemplate template)
    {
        EditingTemplate = template;
        NewSubtaskTitle = "";
    }

    private async Task HandleSubtaskKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddSubtaskToTemplate();
        }
    }

    // Panel resize methods
    private void StartPanelResize(MouseEventArgs e)
    {
        IsResizingPanels = true;
        ResizeStartX = e.ClientX;
        // If width is 0, use default width of 340
        if (SchedulePanelWidth == 0)
            SchedulePanelWidth = 340;
    }

    private void OnPanelResize(MouseEventArgs e)
    {
        if (!IsResizingPanels) return;

        // Dragging left (e.ClientX decreases) = right panel expands
        // Dragging right (e.ClientX increases) = right panel shrinks
        var delta = ResizeStartX - e.ClientX;
        var newWidth = SchedulePanelWidth + (int)delta;

        // Constrain between 200 and 600 pixels
        SchedulePanelWidth = Math.Max(200, Math.Min(600, newWidth));
        ResizeStartX = e.ClientX;
        StateHasChanged();
    }

    private void StopPanelResize(MouseEventArgs e)
    {
        IsResizingPanels = false;
    }

    // Reschedule methods
    private void OpenRescheduleModal(DailyTask task)
    {
        ReschedulingTask = task;
        RescheduleTargetDate = LocalToday.AddDays(1);
        KeepScheduledTime = task.ScheduledTime.HasValue;
        RescheduleTimePreset = task.ScheduledTime.HasValue ? "none" : "none";
        RescheduleCustomTime = "";
    }

    private void CloseRescheduleModal()
    {
        ReschedulingTask = null;
    }

    private void SetRescheduleTimePreset(string preset)
    {
        RescheduleTimePreset = preset;
        if (preset != "custom")
        {
            RescheduleCustomTime = "";
        }
        KeepScheduledTime = false;  // User is choosing a new time
    }

    private TimeSpan? GetRescheduleTime()
    {
        return RescheduleTimePreset switch
        {
            "morning" => new TimeSpan(9, 0, 0),
            "afternoon" => new TimeSpan(14, 0, 0),
            "evening" => new TimeSpan(18, 0, 0),
            "custom" => ParseCustomTime(RescheduleCustomTime),
            "none" => KeepScheduledTime ? ReschedulingTask?.ScheduledTime : null,
            _ => null
        };
    }

    private TimeSpan? ParseCustomTime(string timeStr)
    {
        if (string.IsNullOrWhiteSpace(timeStr)) return null;

        // Try parsing various formats
        timeStr = timeStr.Trim().ToUpper();

        // Handle "3:30 PM" or "3:30PM" format
        if (timeStr.Contains("PM") || timeStr.Contains("AM"))
        {
            if (DateTime.TryParse(timeStr, out var parsed))
            {
                return parsed.TimeOfDay;
            }
        }

        // Handle "15:30" or "9:00" format
        if (TimeSpan.TryParse(timeStr.Replace("PM", "").Replace("AM", "").Trim(), out var ts))
        {
            return ts;
        }

        return null;
    }

    private async Task QuickReschedule(DateTime targetDate, TimeSpan? time)
    {
        if (ReschedulingTask == null) return;

        await TaskService.RescheduleTaskAsync(ReschedulingTask.Id, targetDate, CurrentUserId);

        if (time.HasValue)
        {
            await TaskService.ScheduleTaskTimeAsync(ReschedulingTask.Id, time, CurrentUserId, ReschedulingTask.DurationMinutes > 0 ? ReschedulingTask.DurationMinutes : 30);
        }
        else if (!KeepScheduledTime && ReschedulingTask.ScheduledTime.HasValue)
        {
            await TaskService.ScheduleTaskTimeAsync(ReschedulingTask.Id, null, CurrentUserId, 30);
        }

        ReschedulingTask = null;
        await LoadTasksAsync();
    }

    private async Task RescheduleToDate(DateTime targetDate)
    {
        if (ReschedulingTask == null) return;

        await TaskService.RescheduleTaskAsync(ReschedulingTask.Id, targetDate, CurrentUserId);

        var newTime = GetRescheduleTime();
        if (newTime.HasValue)
        {
            await TaskService.ScheduleTaskTimeAsync(ReschedulingTask.Id, newTime, CurrentUserId, ReschedulingTask.DurationMinutes > 0 ? ReschedulingTask.DurationMinutes : 30);
        }
        else if (!KeepScheduledTime && ReschedulingTask.ScheduledTime.HasValue)
        {
            await TaskService.ScheduleTaskTimeAsync(ReschedulingTask.Id, null, CurrentUserId, 30);
        }

        ReschedulingTask = null;
        await LoadTasksAsync();
    }

    private async Task ConfirmReschedule()
    {
        await RescheduleToDate(RescheduleTargetDate);
    }

    private DateTime GetNextWeekday(DateTime start, DayOfWeek day)
    {
        int daysToAdd = ((int)day - (int)start.DayOfWeek + 7) % 7;
        if (daysToAdd == 0) daysToAdd = 7; // If today is that day, get next week
        return start.AddDays(daysToAdd);
    }

    private class CalendarDay
    {
        public DateTime Date { get; set; }
        public bool IsCurrentMonth { get; set; }
        public int TaskCount { get; set; }
    }

    private class PrioritizedTask
    {
        public DailyTask Task { get; set; } = null!;
        public int PriorityScore { get; set; }
        public string Reasoning { get; set; } = "";
    }

    // Google Calendar methods
    private async Task ConnectGoogle()
    {
        if (GoogleCalendarService == null || CurrentUserId == 0) return;

        try
        {
            var authUrl = await GoogleCalendarService.GetAuthorizationUrlAsync(CurrentUserId);
            await JSRuntime.InvokeVoidAsync("open", authUrl, "_blank");
        }
        catch (Exception ex)
        {
            ImportMessage = $"Error: {ex.Message}";
        }
    }

    private async Task DisconnectGoogle()
    {
        if (GoogleCalendarService == null || CurrentUserId == 0) return;

        await GoogleCalendarService.DisconnectAsync(CurrentUserId);
        IsGoogleConnected = false;
        ImportMessage = "";
    }

    private async Task ImportGoogleEvents()
    {
        if (GoogleCalendarService == null || CurrentUserId == 0) return;

        IsImporting = true;
        ImportMessage = "";
        StateHasChanged();

        try
        {
            // Import events for the next 30 days
            var startDate = LocalToday;
            var endDate = LocalToday.AddDays(30);

            var count = await GoogleCalendarService.ImportEventsAsTasksAsync(CurrentUserId, startDate, endDate);
            ImportMessage = count > 0
                ? $"Imported {count} event(s)!"
                : "No new events to import.";

            await LoadTasksAsync();
        }
        catch (Exception ex)
        {
            ImportMessage = $"Import failed: {ex.Message}";
        }
        finally
        {
            IsImporting = false;
            StateHasChanged();
        }
    }

    public async Task HandleGoogleCallback(string code)
    {
        if (GoogleCalendarService == null || CurrentUserId == 0) return;

        var success = await GoogleCalendarService.HandleAuthCallbackAsync(code, CurrentUserId);
        IsGoogleConnected = success;
        if (success)
        {
            ImportMessage = "Connected! Switch to Google tab to view events.";
            await LoadExternalEventCounts();
        }
        else
        {
            ImportMessage = "Failed to connect. Please try again.";
        }
        StateHasChanged();
    }

    // Microsoft Calendar methods
    private async Task ConnectMicrosoft()
    {
        if (MicrosoftCalendarService == null || CurrentUserId == 0) return;

        try
        {
            var authUrl = await MicrosoftCalendarService.GetAuthorizationUrlAsync(CurrentUserId);
            await JSRuntime.InvokeVoidAsync("open", authUrl, "_blank");
            ImportMessage = "Complete authorization in browser, then refresh this page.";
        }
        catch (Exception ex)
        {
            ImportMessage = $"Error: {ex.Message}";
        }
    }

    private async Task DisconnectMicrosoft()
    {
        if (MicrosoftCalendarService == null || CurrentUserId == 0) return;

        await MicrosoftCalendarService.DisconnectAsync(CurrentUserId);
        IsMicrosoftConnected = false;
        MicrosoftEventCount = 0;
        if (ActiveCalendarTab == CalendarSource.Microsoft)
        {
            ActiveCalendarTab = CalendarSource.Integrated;
        }
        ImportMessage = "";
        StateHasChanged();
    }

    // Task Section Tab methods
    private void SetTaskSection(TaskSection section)
    {
        ActiveTaskSection = section;
        StateHasChanged();
    }

    // Calendar Tab methods
    private async Task SetCalendarTab(CalendarSource tab)
    {
        ActiveCalendarTab = tab;
        if (tab != CalendarSource.Integrated)
        {
            await LoadExternalEventsForTab(tab);
        }
        StateHasChanged();
    }

    private async Task LoadExternalEventCounts()
    {
        var startDate = IsDailyView ? SelectedDate : GetWeekStart(SelectedDate);
        var endDate = IsDailyView ? SelectedDate.AddDays(1) : startDate.AddDays(7);

        if (IsGoogleConnected && CalendarSyncService != null)
        {
            try
            {
                var events = await CalendarSyncService.GetEventsBySourceAsync(CurrentUserId, CalendarSource.Google, startDate, endDate);
                GoogleEventCount = events.Count;
            }
            catch { GoogleEventCount = 0; }
        }

        if (IsMicrosoftConnected && CalendarSyncService != null)
        {
            try
            {
                var events = await CalendarSyncService.GetEventsBySourceAsync(CurrentUserId, CalendarSource.Microsoft, startDate, endDate);
                MicrosoftEventCount = events.Count;
            }
            catch { MicrosoftEventCount = 0; }
        }
    }

    private async Task LoadExternalEventsForTab(CalendarSource source)
    {
        if (CalendarSyncService == null || CurrentUserId == 0) return;

        IsLoadingExternalEvents = true;
        StateHasChanged();

        try
        {
            var startDate = IsDailyView ? SelectedDate : GetWeekStart(SelectedDate);
            var endDate = IsDailyView ? SelectedDate.AddDays(1) : startDate.AddDays(7);

            ExternalEvents = await CalendarSyncService.GetEventsBySourceAsync(CurrentUserId, source, startDate, endDate);
        }
        catch (Exception ex)
        {
            ImportMessage = $"Error loading events: {ex.Message}";
            ExternalEvents = new List<ExternalCalendarEvent>();
        }
        finally
        {
            IsLoadingExternalEvents = false;
            StateHasChanged();
        }
    }

    private async Task ImportSingleEvent(ExternalCalendarEvent evt)
    {
        if (CalendarSyncService == null || CurrentUserId == 0) return;

        try
        {
            await CalendarSyncService.ImportEventToIntegratedAsync(CurrentUserId, evt);
            evt.IsImported = true;
            await LoadTasksAsync();
            ImportMessage = $"Added '{evt.Title}' to Integrated";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ImportMessage = $"Error: {ex.Message}";
        }
    }

    private async Task ImportAllExternalEvents()
    {
        if (CalendarSyncService == null || CurrentUserId == 0) return;

        IsImporting = true;
        StateHasChanged();

        try
        {
            var toImport = ExternalEvents.Where(e => !e.IsImported).ToList();
            var count = await CalendarSyncService.ImportEventsToIntegratedAsync(CurrentUserId, toImport);
            ImportMessage = $"Imported {count} event(s) to Integrated!";
            await LoadTasksAsync();
            await LoadExternalEventsForTab(ActiveCalendarTab);
        }
        catch (Exception ex)
        {
            ImportMessage = $"Import failed: {ex.Message}";
        }
        finally
        {
            IsImporting = false;
            StateHasChanged();
        }
    }

    private DateTime GetWeekStart(DateTime date)
    {
        int diff = (7 + (date.DayOfWeek - DayOfWeek.Sunday)) % 7;
        return date.AddDays(-1 * diff).Date;
    }

    // Timeline helper methods - 20 minute slots
    private const int SlotMinutes = 20;

    private IEnumerable<TimeSpan> GetTimeSlots()
    {
        for (int hour = WorkingHoursStart; hour <= WorkingHoursEnd; hour++)
        {
            for (int minute = 0; minute < 60; minute += SlotMinutes)
            {
                yield return new TimeSpan(hour, minute, 0);
            }
        }
    }

    private List<DailyTask> GetTasksAtSlot(TimeSpan slot)
    {
        var slotEnd = slot.Add(TimeSpan.FromMinutes(SlotMinutes));
        return ScheduledTasks
            .Where(t => t.ScheduledTime.HasValue &&
                        t.ScheduledTime.Value >= slot &&
                        t.ScheduledTime.Value < slotEnd)
            .OrderBy(t => t.ScheduledTime!.Value)
            .ToList();
    }

    private List<ExternalCalendarEvent> GetGoogleEventsAtSlot(TimeSpan slot)
    {
        if (!IsGoogleConnected) return new List<ExternalCalendarEvent>();
        var slotEnd = slot.Add(TimeSpan.FromMinutes(SlotMinutes));

        return ExternalEvents
            .Where(e => !e.IsAllDay &&
                        e.Start.Date == SelectedDate.Date &&
                        e.Start.TimeOfDay >= slot &&
                        e.Start.TimeOfDay < slotEnd)
            .OrderBy(e => e.Start)
            .ToList();
    }

    private bool IsCurrentTimeSlot(TimeSpan slot)
    {
        if (SelectedDate.Date != LocalToday) return false;
        var now = DateTime.Now.TimeOfDay;
        var slotEnd = slot.Add(TimeSpan.FromMinutes(SlotMinutes));
        return now >= slot && now < slotEnd;
    }

    private string FormatTimeSlot(TimeSpan slot)
    {
        var hour = slot.Hours;
        var minute = slot.Minutes;
        var ampm = hour >= 12 ? "pm" : "am";
        var displayHour = hour > 12 ? hour - 12 : (hour == 0 ? 12 : hour);
        return minute == 0 ? $"{displayHour}{ampm}" : $"{displayHour}:{minute:D2}";
    }

    // Keep old methods for backward compatibility
    private List<DailyTask> GetTasksAtHour(int hour)
    {
        return ScheduledTasks
            .Where(t => t.ScheduledTime.HasValue && t.ScheduledTime.Value.Hours == hour)
            .OrderBy(t => t.ScheduledTime!.Value.Minutes)
            .ToList();
    }

    private List<ExternalCalendarEvent> GetGoogleEventsAtHour(int hour)
    {
        if (!IsGoogleConnected) return new List<ExternalCalendarEvent>();

        return ExternalEvents
            .Where(e => !e.IsAllDay && e.Start.Hour == hour && e.Start.Date == SelectedDate.Date)
            .OrderBy(e => e.Start.Minute)
            .ToList();
    }

    // Group management methods
    private async Task LoadUserGroupsAsync()
    {
        if (CurrentUserId == 0) return;
        UserGroups = await GroupService.GetGroupsForUserAsync(CurrentUserId);
    }

    private async Task OpenGroupModal(TaskGroup group)
    {
        SelectedGroup = group;
        IsCreatingGroup = false;
        ShowGroupModal = true;
        GroupMembers = await GroupService.GetGroupMembersAsync(group.Id);
        AllUsers = await GroupService.GetAllUsersAsync();
        StateHasChanged();
    }

    private async Task OpenCreateGroupModalAsync()
    {
        SelectedGroup = null;
        IsCreatingGroup = true;
        NewGroupName = "";
        AllUsers = await GroupService.GetAllUsersAsync();
        ShowGroupModal = true;
    }

    private void OpenCreateGroupModal()
    {
        _ = OpenCreateGroupModalAsync();
    }

    private void CloseGroupModal()
    {
        ShowGroupModal = false;
        SelectedGroup = null;
        IsCreatingGroup = false;
        GroupMembers.Clear();
        SelectedUserIdToAdd = 0;
    }

    private async Task CreateGroup()
    {
        if (string.IsNullOrWhiteSpace(NewGroupName) || CurrentUserId == 0) return;

        await GroupService.CreateGroupAsync(NewGroupName, CurrentUserId);
        await LoadUserGroupsAsync();
        CloseGroupModal();
    }

    private async Task DeleteGroup()
    {
        if (SelectedGroup == null || CurrentUserId == 0) return;

        await GroupService.DeleteGroupAsync(SelectedGroup.Id, CurrentUserId);
        await LoadUserGroupsAsync();
        CloseGroupModal();
    }

    private async Task AddMember()
    {
        if (SelectedGroup == null || SelectedUserIdToAdd == 0) return;

        // Get the username for the selected user
        var userToAdd = AllUsers.FirstOrDefault(u => u.Id == SelectedUserIdToAdd);
        if (userToAdd != null)
        {
            await GroupService.AddMemberByUsernameAsync(SelectedGroup.Id, userToAdd.Username, CurrentUserId);
            GroupMembers = await GroupService.GetGroupMembersAsync(SelectedGroup.Id);
        }
        SelectedUserIdToAdd = 0;
        StateHasChanged();
    }

    private async Task RemoveMember(User member)
    {
        if (SelectedGroup == null) return;

        await GroupService.RemoveMemberAsync(SelectedGroup.Id, member.Id, CurrentUserId);
        GroupMembers = await GroupService.GetGroupMembersAsync(SelectedGroup.Id);
        StateHasChanged();
    }

    // Participants management methods
    private async Task OpenParticipantsModal(DailyTask task)
    {
        ParticipantsTask = task;
        NewParticipantName = "";
        NewParticipantEmail = "";
        ParticipantsMessage = "";
        RecentParticipants = await TaskService.GetRecentParticipantsAsync(10);
        StateHasChanged();
    }

    private void CloseParticipantsModal()
    {
        ParticipantsTask = null;
        ParticipantsMessage = "";
    }

    private async Task AddNewParticipant()
    {
        if (ParticipantsTask == null || string.IsNullOrWhiteSpace(NewParticipantName)) return;

        try
        {
            var participant = await TaskService.CreateParticipantAsync(NewParticipantName, NewParticipantEmail, NewParticipantPhone);
            await TaskService.AddParticipantToTaskAsync(ParticipantsTask.Id, participant.Id, CurrentUserId);

            // Reload the task to get updated participants
            var updatedTask = await TaskService.GetTaskByIdAsync(ParticipantsTask.Id, CurrentUserId);
            if (updatedTask != null)
            {
                ParticipantsTask = updatedTask;
            }

            NewParticipantName = "";
            NewParticipantEmail = "";
            NewParticipantPhone = "";
            ParticipantsMessage = $"Added {participant.Name}";
            await LoadTasksAsync();
        }
        catch (Exception ex)
        {
            ParticipantsMessage = $"Error: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task AddExistingParticipant(Participant participant)
    {
        if (ParticipantsTask == null) return;

        try
        {
            await TaskService.AddParticipantToTaskAsync(ParticipantsTask.Id, participant.Id, CurrentUserId);

            var updatedTask = await TaskService.GetTaskByIdAsync(ParticipantsTask.Id, CurrentUserId);
            if (updatedTask != null)
            {
                ParticipantsTask = updatedTask;
            }

            ParticipantsMessage = $"Added {participant.Name}";
            await LoadTasksAsync();
        }
        catch (Exception ex)
        {
            ParticipantsMessage = $"Error: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task RemoveParticipantFromTask(Participant participant)
    {
        if (ParticipantsTask == null) return;

        try
        {
            await TaskService.RemoveParticipantFromTaskAsync(ParticipantsTask.Id, participant.Id, CurrentUserId);

            var updatedTask = await TaskService.GetTaskByIdAsync(ParticipantsTask.Id, CurrentUserId);
            if (updatedTask != null)
            {
                ParticipantsTask = updatedTask;
            }

            ParticipantsMessage = $"Removed {participant.Name}";
            await LoadTasksAsync();
        }
        catch (Exception ex)
        {
            ParticipantsMessage = $"Error: {ex.Message}";
        }
        StateHasChanged();
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name.Length >= 2 ? name[..2].ToUpper() : name.ToUpper();
    }

    // Meeting/Invitee methods
    private bool IsMeetingTask(DailyTask task)
    {
        var title = task.Title.ToLowerInvariant();
        return title.Contains("meeting") || title.Contains("call") || title.Contains("sync") ||
               title.Contains("standup") || title.Contains("review") || title.Contains("interview") ||
               title.Contains("1:1") || title.Contains("1-1") || title.Contains("catch up") ||
               task.Participants.Any();
    }

    private async Task SendEmailInvite(Participant invitee)
    {
        if (ParticipantsTask == null || string.IsNullOrEmpty(invitee.Email)) return;

        var subject = Uri.EscapeDataString($"Meeting Invite: {ParticipantsTask.Title}");
        var body = BuildMeetingEmailBody(invitee);
        var mailtoUrl = $"mailto:{invitee.Email}?subject={subject}&body={body}";

        await JSRuntime.InvokeVoidAsync("open", mailtoUrl, "_blank");
        ParticipantsMessage = $"Email opened for {invitee.Name}";
        StateHasChanged();
    }

    private async Task SendAllEmailInvites()
    {
        if (ParticipantsTask == null) return;

        var inviteesWithEmail = ParticipantsTask.Participants
            .Where(p => !string.IsNullOrEmpty(p.Participant.Email))
            .Select(p => p.Participant.Email)
            .ToList();

        if (!inviteesWithEmail.Any()) return;

        var subject = Uri.EscapeDataString($"Meeting Invite: {ParticipantsTask.Title}");
        var body = BuildMeetingEmailBody(null);
        var emails = string.Join(",", inviteesWithEmail);
        var mailtoUrl = $"mailto:{emails}?subject={subject}&body={body}";

        await JSRuntime.InvokeVoidAsync("open", mailtoUrl, "_blank");
        ParticipantsMessage = $"Email opened for {inviteesWithEmail.Count} invitee(s)";
        StateHasChanged();
    }

    private string BuildMeetingEmailBody(Participant? specificInvitee)
    {
        if (ParticipantsTask == null) return "";

        var greeting = specificInvitee != null ? $"Hi {specificInvitee.Name.Split(' ')[0]}," : "Hi,";
        var dateTime = ParticipantsTask.ScheduledTime.HasValue
            ? $"{ParticipantsTask.TaskDate:dddd, MMMM d, yyyy} at {FormatTime(ParticipantsTask.ScheduledTime)}"
            : $"{ParticipantsTask.TaskDate:dddd, MMMM d, yyyy}";

        var duration = ParticipantsTask.DurationMinutes > 0 ? $"\nDuration: {ParticipantsTask.DurationMinutes} minutes" : "";

        var body = $@"{greeting}

You are invited to: {ParticipantsTask.Title}

Date/Time: {dateTime}{duration}

Please let me know if this works for you.

Best regards";

        return Uri.EscapeDataString(body);
    }

    private async Task CallInvitee(Participant invitee)
    {
        if (string.IsNullOrEmpty(invitee.Phone)) return;

        var telUrl = $"tel:{invitee.Phone.Replace(" ", "").Replace("-", "").Replace("(", "").Replace(")", "")}";
        await JSRuntime.InvokeVoidAsync("open", telUrl, "_self");
        ParticipantsMessage = $"Calling {invitee.Name}...";
        StateHasChanged();
    }

    private async Task AddMeetingToMemberCalendar(User member)
    {
        if (ParticipantsTask == null || !ParticipantsTask.GroupId.HasValue) return;

        try
        {
            // Create a copy of the task for the group member
            var meetingCopy = new DailyTask
            {
                Title = ParticipantsTask.Title,
                TaskDate = ParticipantsTask.TaskDate,
                ScheduledTime = ParticipantsTask.ScheduledTime,
                DurationMinutes = ParticipantsTask.DurationMinutes,
                IsAllDay = ParticipantsTask.IsAllDay,
                UserId = member.Id,
                GroupId = ParticipantsTask.GroupId,
                Description = $"Meeting shared by {CurrentUsername}"
            };

            await TaskService.CreateTaskAsync(meetingCopy);
            ParticipantsMessage = $"Meeting added to {member.Username}'s calendar";
        }
        catch (Exception ex)
        {
            ParticipantsMessage = $"Error: {ex.Message}";
        }
        StateHasChanged();
    }

    // Appointment Detail Panel methods
    private async Task OpenAppointmentDetail(DailyTask task)
    {
        // Don't allow editing past tasks
        if (IsTaskInPast(task)) return;

        AppointmentDetailTask = task;
        AppointmentTitle = task.Title;
        AppointmentDescription = task.Description ?? "";
        AppointmentTimeValue = task.ScheduledTime.HasValue ? task.ScheduledTime.Value.ToString(@"hh\:mm") : "";
        AppointmentDuration = task.DurationMinutes;
        AppointmentRecurrence = task.RecurrenceType;
        AppointmentRecurrenceInterval = task.RecurrenceInterval;
        AppointmentRecurrenceDays = string.IsNullOrEmpty(task.RecurrenceDays) ? new List<string>() : task.RecurrenceDays.Split(',').ToList();
        AppointmentRecurrenceEndDate = task.RecurrenceEndDate;
        HasRecurrenceEndDate = task.RecurrenceEndDate.HasValue;
        NewParticipantName = "";
        NewParticipantEmail = "";
        NewParticipantPhone = "";
        ParticipantsMessage = "";
        IsSavingAppointment = false;

        // Load recent participants for quick add
        RecentParticipants = await TaskService.GetRecentParticipantsAsync(10);
        StateHasChanged();
    }

    private void CloseAppointmentDetail()
    {
        AppointmentDetailTask = null;
        AppointmentTitle = "";
        AppointmentDescription = "";
        AppointmentTimeValue = "";
        AppointmentDuration = 30;
        AppointmentRecurrence = RecurrenceType.None;
        AppointmentRecurrenceInterval = 1;
        AppointmentRecurrenceDays = new();
        AppointmentRecurrenceEndDate = null;
        HasRecurrenceEndDate = false;
        ParticipantsMessage = "";
    }

    private async Task SaveAppointmentDetail()
    {
        if (AppointmentDetailTask == null || string.IsNullOrWhiteSpace(AppointmentTitle)) return;

        IsSavingAppointment = true;
        StateHasChanged();

        try
        {
            AppointmentDetailTask.Title = AppointmentTitle;
            AppointmentDetailTask.Description = string.IsNullOrWhiteSpace(AppointmentDescription) ? null : AppointmentDescription;
            AppointmentDetailTask.DurationMinutes = AppointmentDuration;

            // Parse time if provided
            if (!string.IsNullOrWhiteSpace(AppointmentTimeValue))
            {
                if (TimeSpan.TryParse(AppointmentTimeValue, out var time))
                {
                    AppointmentDetailTask.ScheduledTime = time;
                    AppointmentDetailTask.IsAllDay = false;
                }
            }

            // Save recurrence settings
            AppointmentDetailTask.RecurrenceType = AppointmentRecurrence;
            AppointmentDetailTask.RecurrenceInterval = AppointmentRecurrenceInterval;
            AppointmentDetailTask.RecurrenceDays = AppointmentRecurrenceDays.Any() ? string.Join(",", AppointmentRecurrenceDays) : null;
            AppointmentDetailTask.RecurrenceEndDate = HasRecurrenceEndDate ? AppointmentRecurrenceEndDate : null;

            await TaskService.UpdateTaskAsync(AppointmentDetailTask);

            // Generate recurring instances if recurrence is set
            if (AppointmentRecurrence != RecurrenceType.None)
            {
                await GenerateRecurringInstances(AppointmentDetailTask);
            }

            await LoadTasksAsync();
            CloseAppointmentDetail();
        }
        catch (Exception ex)
        {
            ParticipantsMessage = $"Error saving: {ex.Message}";
        }
        finally
        {
            IsSavingAppointment = false;
            StateHasChanged();
        }
    }

    private async Task DeleteAppointment()
    {
        if (AppointmentDetailTask == null) return;

        // Check if this is part of a recurring series
        var isRecurring = AppointmentDetailTask.RecurrenceType != RecurrenceType.None ||
                          AppointmentDetailTask.RecurrenceParentId.HasValue;

        if (isRecurring)
        {
            // Open the recurring delete dialog
            await OpenRecurringDeleteDialog(AppointmentDetailTask);
            return;
        }

        // Not recurring, delete directly
        try
        {
            await TaskService.DeleteTaskAsync(AppointmentDetailTask.Id, CurrentUserId);
            await LoadTasksAsync();
            CloseAppointmentDetail();
        }
        catch (Exception ex)
        {
            ParticipantsMessage = $"Error deleting: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task UnscheduleAppointment()
    {
        if (AppointmentDetailTask == null) return;

        try
        {
            // Remove the scheduled time and set date to yesterday - this puts it in the Waiting list
            await TaskService.ScheduleTaskTimeAsync(AppointmentDetailTask.Id, null, CurrentUserId);
            await TaskService.RescheduleTaskAsync(AppointmentDetailTask.Id, LocalToday.AddDays(-1), CurrentUserId);
            await LoadTasksAsync();
            CloseAppointmentDetail();
        }
        catch (Exception ex)
        {
            ParticipantsMessage = $"Error unscheduling: {ex.Message}";
            StateHasChanged();
        }
    }

    private string GetRecurrenceIntervalLabel()
    {
        return AppointmentRecurrence switch
        {
            RecurrenceType.Daily => AppointmentRecurrenceInterval == 1 ? "day" : "days",
            RecurrenceType.Weekly => AppointmentRecurrenceInterval == 1 ? "week" : "weeks",
            RecurrenceType.Monthly => AppointmentRecurrenceInterval == 1 ? "month" : "months",
            RecurrenceType.Yearly => AppointmentRecurrenceInterval == 1 ? "year" : "years",
            _ => ""
        };
    }

    private void ToggleRecurrenceDay(string day)
    {
        if (AppointmentRecurrenceDays.Contains(day))
            AppointmentRecurrenceDays.Remove(day);
        else
            AppointmentRecurrenceDays.Add(day);
    }

    private async Task OpenRecurringDeleteDialog(DailyTask task)
    {
        DeletingRecurringTask = task;
        RecurringDeleteMode = "this";
        SelectedInstancesForDeletion.Clear();

        // Find all instances in this recurring series
        var parentId = task.RecurrenceParentId ?? task.Id;

        // Get all tasks that are part of this series (same parent or is the parent)
        var allTasks = await TaskService.GetUpcomingTasksAsync(CurrentUserId, 365);
        RecurringInstances = allTasks
            .Where(t => t.Id == parentId || t.RecurrenceParentId == parentId)
            .OrderBy(t => t.TaskDate)
            .ThenBy(t => t.ScheduledTime)
            .ToList();

        // Pre-select the current task for deletion
        SelectedInstancesForDeletion.Add(task.Id);

        ShowRecurringDeleteDialog = true;
        StateHasChanged();
    }

    private void CloseRecurringDeleteDialog()
    {
        ShowRecurringDeleteDialog = false;
        DeletingRecurringTask = null;
        RecurringInstances.Clear();
        SelectedInstancesForDeletion.Clear();
    }

    private void ToggleInstanceForDeletion(int taskId)
    {
        if (SelectedInstancesForDeletion.Contains(taskId))
            SelectedInstancesForDeletion.Remove(taskId);
        else
            SelectedInstancesForDeletion.Add(taskId);
    }

    private void SelectAllInstancesForDeletion()
    {
        SelectedInstancesForDeletion = RecurringInstances.Select(t => t.Id).ToHashSet();
    }

    private void DeselectAllInstancesForDeletion()
    {
        SelectedInstancesForDeletion.Clear();
    }

    private async Task ConfirmRecurringDelete()
    {
        if (DeletingRecurringTask == null) return;

        try
        {
            switch (RecurringDeleteMode)
            {
                case "this":
                    // Delete only the current instance
                    await TaskService.DeleteTaskAsync(DeletingRecurringTask.Id, CurrentUserId);
                    break;

                case "all":
                    // Delete all instances in the series
                    foreach (var instance in RecurringInstances)
                    {
                        await TaskService.DeleteTaskAsync(instance.Id, CurrentUserId);
                    }
                    break;

                case "select":
                    // Delete only selected instances
                    foreach (var taskId in SelectedInstancesForDeletion)
                    {
                        await TaskService.DeleteTaskAsync(taskId, CurrentUserId);
                    }
                    break;
            }

            await LoadTasksAsync();
            CloseRecurringDeleteDialog();
            CloseAppointmentDetail();
        }
        catch (Exception ex)
        {
            ParticipantsMessage = $"Error deleting: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task GenerateRecurringInstances(DailyTask parentTask)
    {
        // Generate recurring instances for the next 3 months
        var endDate = parentTask.RecurrenceEndDate ?? DateTime.Today.AddMonths(3);
        var currentDate = parentTask.TaskDate.AddDays(1); // Start from day after the original

        while (currentDate <= endDate)
        {
            bool shouldCreate = false;

            switch (parentTask.RecurrenceType)
            {
                case RecurrenceType.Daily:
                    shouldCreate = (currentDate - parentTask.TaskDate).Days % parentTask.RecurrenceInterval == 0;
                    break;

                case RecurrenceType.Weekly:
                    var dayOfWeek = currentDate.DayOfWeek.ToString().Substring(0, 3);
                    var daysSinceStart = (currentDate - parentTask.TaskDate).Days;
                    var weeksSinceStart = daysSinceStart / 7;
                    shouldCreate = weeksSinceStart % parentTask.RecurrenceInterval == 0 &&
                                   (string.IsNullOrEmpty(parentTask.RecurrenceDays) || parentTask.RecurrenceDays.Contains(dayOfWeek));
                    break;

                case RecurrenceType.Monthly:
                    var monthsDiff = ((currentDate.Year - parentTask.TaskDate.Year) * 12) + currentDate.Month - parentTask.TaskDate.Month;
                    shouldCreate = currentDate.Day == parentTask.TaskDate.Day && monthsDiff % parentTask.RecurrenceInterval == 0;
                    break;

                case RecurrenceType.Yearly:
                    var yearsDiff = currentDate.Year - parentTask.TaskDate.Year;
                    shouldCreate = currentDate.Month == parentTask.TaskDate.Month &&
                                   currentDate.Day == parentTask.TaskDate.Day &&
                                   yearsDiff % parentTask.RecurrenceInterval == 0;
                    break;
            }

            if (shouldCreate)
            {
                // Check if instance already exists for this date
                var existingTasks = await TaskService.GetTasksForDateAsync(currentDate, CurrentUserId);
                var alreadyExists = existingTasks.Any(t => t.RecurrenceParentId == parentTask.Id);

                if (!alreadyExists)
                {
                    var instance = new DailyTask
                    {
                        Title = parentTask.Title,
                        Description = parentTask.Description,
                        TaskDate = currentDate,
                        ScheduledTime = parentTask.ScheduledTime,
                        DurationMinutes = parentTask.DurationMinutes,
                        IsAllDay = parentTask.IsAllDay,
                        UserId = parentTask.UserId,
                        RecurrenceParentId = parentTask.Id,
                        RecurrenceType = RecurrenceType.None // Instances don't have their own recurrence
                    };
                    await TaskService.CreateTaskAsync(instance);
                }
            }

            currentDate = currentDate.AddDays(1);
        }
    }

    private async Task AddAppointmentInvitee()
    {
        if (AppointmentDetailTask == null || string.IsNullOrWhiteSpace(NewParticipantName)) return;

        try
        {
            var participant = await TaskService.CreateParticipantAsync(NewParticipantName, NewParticipantEmail, NewParticipantPhone);
            await TaskService.AddParticipantToTaskAsync(AppointmentDetailTask.Id, participant.Id, CurrentUserId);

            // Reload the task to get updated participants
            var updatedTask = await TaskService.GetTaskByIdAsync(AppointmentDetailTask.Id, CurrentUserId);
            if (updatedTask != null)
            {
                AppointmentDetailTask = updatedTask;
            }

            NewParticipantName = "";
            NewParticipantEmail = "";
            NewParticipantPhone = "";
            ParticipantsMessage = $"Added {participant.Name}";
            await LoadTasksAsync();
        }
        catch (Exception ex)
        {
            ParticipantsMessage = $"Error: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task HandleAppointmentInviteeKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddAppointmentInvitee();
        }
    }

    private async Task AddRecentToAppointment(Participant participant)
    {
        if (AppointmentDetailTask == null) return;

        try
        {
            await TaskService.AddParticipantToTaskAsync(AppointmentDetailTask.Id, participant.Id, CurrentUserId);

            // Reload the task to get updated participants
            var updatedTask = await TaskService.GetTaskByIdAsync(AppointmentDetailTask.Id, CurrentUserId);
            if (updatedTask != null)
            {
                AppointmentDetailTask = updatedTask;
            }

            ParticipantsMessage = $"Added {participant.Name}";
            await LoadTasksAsync();
        }
        catch (Exception ex)
        {
            ParticipantsMessage = $"Error: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task RemoveAppointmentInvitee(Participant participant)
    {
        if (AppointmentDetailTask == null) return;

        try
        {
            await TaskService.RemoveParticipantFromTaskAsync(AppointmentDetailTask.Id, participant.Id, CurrentUserId);

            // Reload the task to get updated participants
            var updatedTask = await TaskService.GetTaskByIdAsync(AppointmentDetailTask.Id, CurrentUserId);
            if (updatedTask != null)
            {
                AppointmentDetailTask = updatedTask;
            }

            await LoadTasksAsync();
        }
        catch (Exception ex)
        {
            ParticipantsMessage = $"Error: {ex.Message}";
        }
        StateHasChanged();
    }

    // Share task methods
    private void OpenShareModal(DailyTask task)
    {
        ShareTask = task;
        SelectedShareGroupId = 0;
        ShareMessage = "";
        StateHasChanged();
    }

    private void CloseShareModal()
    {
        ShareTask = null;
        SelectedShareGroupId = 0;
        ShareMessage = "";
    }

    private void SelectShareGroup(int groupId)
    {
        SelectedShareGroupId = groupId;
        ShareMessage = "";
        StateHasChanged();
    }

    private async Task ConfirmShareTask()
    {
        if (ShareTask == null || SelectedShareGroupId == 0) return;

        try
        {
            await GroupService.ShareTaskToGroupAsync(ShareTask.Id, SelectedShareGroupId, CurrentUserId);
            var groupName = UserGroups.FirstOrDefault(g => g.Id == SelectedShareGroupId)?.Name ?? "group";
            ShareMessage = $"Shared with {groupName}!";
            await LoadTasksAsync();
            StateHasChanged();
            await Task.Delay(1000);
            CloseShareModal();
        }
        catch (Exception ex)
        {
            ShareMessage = $"Error: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task UnshareTask(DailyTask task)
    {
        try
        {
            await GroupService.UnshareTaskAsync(task.Id, CurrentUserId);
            await LoadTasksAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error unsharing task: {ex.Message}");
        }
    }

    // Task Action (Agentic AI) methods
    private async Task CheckOllamaAvailability()
    {
        try
        {
            IsOllamaAvailable = await OllamaService.IsAvailableAsync();
        }
        catch
        {
            IsOllamaAvailable = false;
        }
    }

    private async Task CheckNotificationServiceAvailability()
    {
        try
        {
            NotificationServiceAvailable = await NotificationService.IsAvailableAsync();
        }
        catch
        {
            NotificationServiceAvailable = false;
        }
    }

    private async Task SendNotificationsToAll()
    {
        if (ParticipantsTask == null) return;

        var participants = ParticipantsTask.Participants
            .Where(p => p.Participant.NotificationPreference != NotificationPreference.None)
            .Select(p => p.Participant)
            .ToList();

        if (!participants.Any())
        {
            ParticipantsMessage = "No participants with notification preferences set";
            StateHasChanged();
            return;
        }

        IsSendingNotifications = true;
        StateHasChanged();

        try
        {
            var message = EmailNotificationService.CreateMeetingInvite(ParticipantsTask, CurrentUsername);
            var results = await NotificationService.SendBulkNotificationAsync(participants, message);

            var successful = results.Count(r => r.Success);
            var failed = results.Count(r => !r.Success);

            if (failed == 0)
            {
                ParticipantsMessage = $"Sent {successful} invitation(s) successfully!";
            }
            else if (successful > 0)
            {
                ParticipantsMessage = $"Sent {successful} invitation(s). {failed} failed.";
            }
            else
            {
                var errors = string.Join("; ", results.Where(r => !r.Success).Select(r => r.ErrorMessage).Distinct().Take(2));
                ParticipantsMessage = $"Failed to send invitations: {errors}";
            }
        }
        catch (Exception ex)
        {
            ParticipantsMessage = $"Error sending invitations: {ex.Message}";
        }
        finally
        {
            IsSendingNotifications = false;
            StateHasChanged();
        }
    }

    private async Task ParseTaskActionsAsync()
    {
        if (!IsOllamaAvailable) return;

        var allTasks = Tasks.Concat(OverdueTasks).ToList();
        foreach (var task in allTasks)
        {
            if (!TaskActions.ContainsKey(task.Id))
            {
                try
                {
                    var action = await OllamaService.ParseTaskActionAsync(task.Title);
                    TaskActions[task.Id] = action;
                }
                catch
                {
                    TaskActions[task.Id] = null;
                }
            }
        }
        StateHasChanged();
    }

    private TaskAction? GetTaskAction(DailyTask task)
    {
        if (TaskActions.TryGetValue(task.Id, out var action))
        {
            return action;
        }
        // Queue parsing in background if not cached
        if (IsOllamaAvailable)
        {
            _ = ParseSingleTaskActionAsync(task);
        }
        return null;
    }

    private async Task ParseSingleTaskActionAsync(DailyTask task)
    {
        if (TaskActions.ContainsKey(task.Id)) return;

        try
        {
            var action = await OllamaService.ParseTaskActionAsync(task.Title);
            TaskActions[task.Id] = action;
            StateHasChanged();
        }
        catch
        {
            TaskActions[task.Id] = null;
        }
    }

    private string GetActionTooltip(TaskAction action)
    {
        return action.ActionType switch
        {
            TaskActionType.Email => action.Target != null
                ? $"Send email to {action.Target}"
                : "Compose email",
            TaskActionType.Call => action.Target != null
                ? $"Call {action.Target}"
                : "Make a call",
            TaskActionType.Document => action.Subject != null
                ? $"Open: {action.Subject}"
                : "Open document",
            TaskActionType.Website => action.Target != null
                ? $"Visit {action.Target}"
                : "Open website",
            TaskActionType.Meeting => action.Subject != null
                ? $"Schedule: {action.Subject}"
                : "Schedule meeting",
            _ => "Action"
        };
    }

    private async Task ExecuteTaskAction(DailyTask task, TaskAction action)
    {
        try
        {
            switch (action.ActionType)
            {
                case TaskActionType.Email:
                    await ExecuteEmailAction(task, action);
                    break;
                case TaskActionType.Call:
                    await ExecuteCallAction(task, action);
                    break;
                case TaskActionType.Document:
                    await ExecuteDocumentAction(task, action);
                    break;
                case TaskActionType.Website:
                    await ExecuteWebsiteAction(task, action);
                    break;
                case TaskActionType.Meeting:
                    await ExecuteMeetingAction(task, action);
                    break;
            }
        }
        catch (Exception ex)
        {
            ImportMessage = $"Action failed: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task ExecuteEmailAction(DailyTask task, TaskAction action)
    {
        var mailto = "mailto:";
        if (!string.IsNullOrEmpty(action.Target))
        {
            mailto += action.Target;
        }

        var queryParams = new List<string>();
        if (!string.IsNullOrEmpty(action.Subject))
        {
            queryParams.Add($"subject={Uri.EscapeDataString(action.Subject)}");
        }
        else
        {
            queryParams.Add($"subject={Uri.EscapeDataString(task.Title)}");
        }

        if (!string.IsNullOrEmpty(action.Body))
        {
            queryParams.Add($"body={Uri.EscapeDataString(action.Body)}");
        }

        if (queryParams.Any())
        {
            mailto += "?" + string.Join("&", queryParams);
        }

        await JSRuntime.InvokeVoidAsync("open", mailto);
    }

    private async Task ExecuteCallAction(DailyTask task, TaskAction action)
    {
        if (!string.IsNullOrEmpty(action.Target))
        {
            // Try to format as a tel: link
            var phoneNumber = action.Target.Replace(" ", "").Replace("-", "").Replace("(", "").Replace(")", "");
            await JSRuntime.InvokeVoidAsync("open", $"tel:{phoneNumber}");
        }
        else if (!string.IsNullOrEmpty(action.SearchQuery))
        {
            // Search for the contact
            await JSRuntime.InvokeVoidAsync("open", $"https://www.google.com/search?q={Uri.EscapeDataString(action.SearchQuery + " phone number")}");
        }
        else
        {
            ImportMessage = "No phone number found. Add contact details to task.";
            StateHasChanged();
        }
    }

    private async Task ExecuteDocumentAction(DailyTask task, TaskAction action)
    {
        // For documents, we search or open a new doc
        var searchTerm = action.Subject ?? action.SearchQuery ?? task.Title;
        // Open Google Docs search or create new doc
        await JSRuntime.InvokeVoidAsync("open", $"https://docs.google.com/document/create?title={Uri.EscapeDataString(searchTerm)}");
    }

    private async Task ExecuteWebsiteAction(DailyTask task, TaskAction action)
    {
        var url = action.Target;
        if (string.IsNullOrEmpty(url))
        {
            // Search for it
            var searchTerm = action.SearchQuery ?? task.Title;
            url = $"https://www.google.com/search?q={Uri.EscapeDataString(searchTerm)}";
        }
        else if (!url.StartsWith("http"))
        {
            url = "https://" + url;
        }

        await JSRuntime.InvokeVoidAsync("open", url);
    }

    private async Task ExecuteMeetingAction(DailyTask task, TaskAction action)
    {
        // Open calendar to create event
        var title = action.Subject ?? task.Title;
        var details = action.Body ?? task.Description ?? "";

        // Build date/time parameters
        // Google Calendar uses format: YYYYMMDDTHHMMSS (local time) or with Z for UTC
        var startDate = task.TaskDate;
        var startTime = task.ScheduledTime ?? new TimeSpan(9, 0, 0); // Default 9 AM if no time
        var startDateTime = startDate.Add(startTime);
        var endDateTime = startDateTime.AddMinutes(task.DurationMinutes > 0 ? task.DurationMinutes : 60);

        // Format: 20260209T130000/20260209T140000 (local time format)
        var dateFormat = "yyyyMMdd'T'HHmmss";
        var dates = $"{startDateTime.ToString(dateFormat)}/{endDateTime.ToString(dateFormat)}";

        // Add participants as guests
        var guestEmails = "";
        if (task.Participants != null && task.Participants.Any())
        {
            var emails = task.Participants
                .Where(p => !string.IsNullOrEmpty(p.Participant?.Email))
                .Select(p => p.Participant.Email)
                .ToList();
            if (emails.Any())
            {
                guestEmails = "&add=" + string.Join("&add=", emails.Select(e => Uri.EscapeDataString(e!)));
            }
        }

        // Google Calendar URL with all parameters
        var calendarUrl = $"https://calendar.google.com/calendar/render?action=TEMPLATE" +
            $"&text={Uri.EscapeDataString(title)}" +
            $"&dates={dates}" +
            $"&details={Uri.EscapeDataString(details)}" +
            guestEmails;

        await JSRuntime.InvokeVoidAsync("open", calendarUrl);
    }
}
